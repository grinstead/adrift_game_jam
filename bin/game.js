'use strict';class aa{constructor(a,b,c){this.name=c;this.fa=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.fa}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.fa}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function da(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new aa(c[1],c[2],c[3]))});return b}
const ea=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function fa(a,b){a.h.uniformMatrix4fv(a.v,!1,b);a.a.push(b)}function z(a,b,c,d=0){var e=a.a;e=e.length?e[e.length-1]:ea;fa(a,new Float32Array([e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],b*e[0]+c*e[4]+d*e[8]+e[12],b*e[1]+c*e[5]+d*e[9]+e[13],b*e[2]+c*e[6]+d*e[10]+e[14],b*e[3]+c*e[7]+d*e[11]+e[15]]))}function B(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class ha{constructor(a,b){this.h=a;this.v=b;this.a=[];a.uniformMatrix4fv(b,!1,ea)}depth(){return this.a.length}pop(){return this.a.pop()}push(a){var b=this.a;0===b.length?fa(this,a):(b=b[b.length-1],fa(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+
a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class C{constructor(a,b){this.name=a.name;var c=this.h=a.h;a=this.type=a.type;switch(a){case "vertex":var d=this.h.VERTEX_SHADER;break;case "fragment":d=this.h.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}d=this.a=c.createShader(d);c.shaderSource(d,b);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(d)}`,c.deleteShader(d),Error(b);this.eb=da(b)}}
function ia(a,...b){const c=a.h,d=a.Fa;b.forEach(e=>{a.Pa.push(e);c.attachShader(d,e.a)});return a}class ja{constructor(a){this.name=a.name;this.$=a.$;a=this.h=a.h;this.a=!1;this.Fa=a.createProgram();this.Pa=[];this.W={};this.ba={};this.stack=null}link(){if(this.a)return this;var a=this.h,b=this.Fa;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.a=!0;return this}}
function ka(a,b){var c=a.h,d=a.Fa;c.useProgram(d);for(var e={},g={},h=a.Pa,f=0;f<h.length;f++)for(var k=h[f].eb,l=0;l<k.length;l++){var n=k[l];1===n.type?n.fa in e||(e[n.name]=c.getUniformLocation(d,n.fa)):n.fa in g||(g[n.name]=c.getAttribLocation(d,n.fa))}a.W=e;a.ba=g;if(d=a.$)if(d in a.W)a.stack=new ha(c,a.W[d]);else throw Error(`No anchor point "${d}" in program`);try{b(c,a)}finally{a.W={},a.ba={},a.stack=null}}
class la{constructor(a,b,c,d,e){this.h=a;this.name=b;this.w=c;this.o=d;this.a=e(a)}bindTexture(){this.h.bindTexture(this.h.TEXTURE_2D,this.a)}}function ma(a){return(new Promise((b,c)=>{const d=new Image;d.onload=()=>void b(d);d.onerror=()=>{c(Error(`failed to load ${a.src}`))};d.mode="no-cors";d.src=a.src})).then(b=>{const c=b.naturalWidth,d=b.naturalHeight;return new la(a.h,a.name,c,d,na(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,c,d,0,e.RGBA,e.UNSIGNED_BYTE,b)}))})}
function oa(a){const b=a.width,c=a.height;return new la(a.h,a.name,b,c,na(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,b,c,0,d.RGBA,d.UNSIGNED_BYTE,a.Ha,0)}))}function qa(a){return new la(a.h,a.name,a.width,a.height,()=>a.V)}
function na(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function D(a,b,c){a=a.v;null!=c?a.set(b,c):a.delete(b)}function G(a,b){b=a.v.get(b);const c=a.a;return!!b&&!!b.some(d=>(d=c.get(d))?(d.ua=0,null!=d.ya):!1)}function ra(a){const b=a.v.get("showLights");if(b){const c=a.a;return b.reduce((d,e)=>(e=c.get(e))?(d+=e.ua,e.ua=0,d):d,0)}return 0}function sa(a,b,c){b=G(a,b)?1:0;return(G(a,c)?1:0)-b}
class ta{constructor(a){this.a=new Map;this.v=new Map;a.addEventListener("keydown",b=>{ua(this,b,!0)});a.addEventListener("keyup",b=>{ua(this,b,!1)});a.onblur=()=>{this.a.clear()};a.onfocus=()=>{this.a.clear()}}}function ua(a,b,c){b=b.key;a=a.a;const d=a.get(b);c?null==d?a.set(b,{ya:Date.now(),ua:1}):(null==d.ya&&(d.ya=Date.now()),d.ua++):null!=d&&(d.ya=null)};function I(a,b){const c=a.a.h;let d=a.v;null!=d?c.bindBuffer(c.ARRAY_BUFFER,d):(a.v=d=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,d),c.bufferData(c.ARRAY_BUFFER,a.S,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.a.bindTexture();c.uniform1i(b.W.texture,0);c.enableVertexAttribArray(b.ba.texturePosition);c.vertexAttribPointer(b.ba.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.ba.position);c.vertexAttribPointer(b.ba.position,3,c.FLOAT,!1,20,0)}
function J(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.a.h;const d=b.Ga;a.drawArrays(a.TRIANGLE_STRIP,d[c%d.length],b.Gb)}
class L{constructor(a,b){this.a=a;this.v=null;a=this.data={};const c=[];let d=0;for(const e in b){const g=b[e],h=[],f=g.length;if(0===f)throw Error("Sprite declared with 0 points");const k=g[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const l=k/5;for(let n=0;n<f;n++){const q=g[n];if(q.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");h.push(d);c.push.apply(c,q);d+=l}a[e]={Zb:this,name:e,Ga:h,Gb:l}}this.S=new Float32Array(c)}}
function va(a,b){for(var c=a.F;-1!==c&&c<=b;){c=a.S;const d=a.I+1;d===c.length?a.v===a.vb?a.F=c=-1:(a.v++,a.I=0,a.F=c=b+c[0]):(a.I=d,a.F=c=b+c[d])}}function wa(a,b){if(b!==a.a){if(!a.xa.includes(b))throw Error(`${a} does not have mode ${b}`);a.a=b}}
class xa{constructor(a,b,c,d){const e=a.K;this.za=a.name;this.xa=a.pa;this.a=c;this.vb="number"===typeof e?e:e?-1:0;this.Sa=a.set;this.S=b;this.I=this.v=0;this.F=d+b[0];this.rb=a.Hb}wa(){const a=this.rb;return null!=a?a[this.I]:void 0}U(a){I(this.Sa,a);J(this.Sa,this.a,this.I)}name(){return this.za}toString(){return`Sprite/${this.za}`}}
function M(a){const b=a.name,c=a.J,d=a.set.data;let e=-1;a.pa.forEach(h=>{const f=d[h];if(!f)throw Error(`Sprite/${b} has non-existent mode ${h}`);if(-1===e)e=f.Ga.length;else if(e!==f.Ga.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===e)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==e)throw Error(`Sprite/${b} given ${c.length} frame times for ${e} frames`);if(a.wa&&a.wa.length!==e)throw Error(`Sprite/${b} given ${a.wa.length} frame data points for ${e} frames`);
const g="number"===typeof c?Array(e).fill(c):c;return(h,f)=>new xa(a,g,h,f)}function N({x:a=0,y:b=0,z:c=0,width:d,height:e,ma:g,la:h,ja:f,count:k,bc:l=0,cc:n=0,dc:q=g,ac:m=h,ka:u=!1}){const r=[];for(let v=0;v<k;v++){const A=l+v%f*q,H=n+Math.floor(v/f)*m;r.push(ya({x:a,y:b,z:c,width:d,height:e,Sb:A,Qb:A+g,Tb:H,Rb:H+h,ka:u}))}return r}
function ya({x:a=0,y:b=0,z:c=0,width:d,height:e,depth:g=0,Sb:h,Tb:f,Qb:k,Rb:l,ka:n=!1}){n?(n=k,k=a-d):(n=h,h=k,k=-a,a=d-a);return[a,-b,-c,h,l,k,-b,-c,n,l,a,g-b,e-c,h,f,k,g-b,e-c,n,f]};function O(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const za=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function Aa(a,b){const [c,d,e,g,h]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png"),b("assets/Enemy Dying.mp3"),a("creature_death","assets/Enemy Dying.png")]);var f=new L(c,{blink:N({x:.25,z:.25,width:.5,height:.5,ma:108/c.w,la:108/c.o,ja:2,count:6,ka:!0})});a=M({name:"creature_attack",set:new L(e,{bite:N({x:.5,z:.75,width:1,height:2,la:530/e.o,ma:278/e.w,ja:7,count:42,ka:!0})}),pa:["bite"],K:!1,J:1/42});b=M({name:"creature_death",
set:new L(h,{left:N({x:330/(460/1.8),y:.375,z:0,width:660/(460/1.8),height:1.8,ma:660/h.w,la:460/h.o,ja:3,count:12}),right:N({x:1.32,y:.375,z:0,width:2.64,height:1.8,ma:660/h.w,la:450/h.o,ja:3,count:12,ka:!0})}),pa:["left","right"],K:!1,J:.125});var k=Array(6).fill(.125);k[0]=4;f=M({name:"creature_normal",set:f,pa:["blink"],K:!0,J:k});k=[];var l=92,n=-22;const q=Math.sqrt(l*l+n*n);l/=q;n/=q;for(let m=0;29>m;m++){const u=m%5,r=Math.floor(m/5),v=[],A=(H,V)=>{const W=100*H,X=77*V-48;v.push((W*l+X*n)/
q,H,(W*-n+X*l)/360,100*(u+H)/d.w,77*(r+V)/d.o)};A(1,1);A(0,1);A(1,0);A(0,0);k.push(v)}k=new L(d,{wiggle:k});return{Ua:f,yb:a,zb:b,Pb:k,jb:g}}function Ba(a,b,c){const d=b.j;if(d>a.v){var e=a.a;a.a=(e+1)%a.ra.length;e=a.ra[e];c=a.x+.225*c+e.pb;.05<Math.abs(c-e.Da)&&(a.v=d+.125,e.Ya=d+.125,e.Va=e.Da,e.Wa=e.La,e.Xa=e.Ma,e.Da=c,e.La=a.y+e.qb,e.Ma=b.u)}}
class Ca{constructor(a,b,c,d){const e=a.m.ca.Ua("blink",a.j),g=a.u;this.x=this.S=b;this.y=c;this.z=d;this.a=this.v=0;this.ra=[P(0,b,c,-1,1,g),P(1,b,c,-1,-1,g),P(2,b,c,1,1,g),P(3,b,c,1,-1,g)];this.s=e;this.state=Da(this,a)}A(a,b){const c=this.state.Ca;c&&c();this.state=b=b(this,a);b.C(a)}O(a,b,c){this.s=a(c,b)}}
function Da(a,b){return{name:"creature_normal",C:()=>{var c=b.j;a.x=a.S+Math.sin(c);Ba(a,b,.5*Math.cos(c));c=Math.abs(a.x-b.i.l);2>c&&(a.state=.5>c?Ea(a,b):Ia(a,b))},L:(c,d,e)=>{c=d.stack;const g=a.x,h=a.z;z(c,g,a.y,h);let f=e.x<g;e=O(e.z-h,e.x-g);f&&(c.push(za),e=Math.PI-e);B(c,e);a.s.U(d);c.pop();f&&c.pop();c.pop()}}}
function Ia(a,b){const c=b.j;return{name:"creature_hunting",C:()=>{const d=b.j,e=b.i.l,g=Math.abs(a.x-b.i.l);.25<g&&(a.x+=(e<a.x?-1:1)*(.01+.02*Math.min(1,(b.j-c)/3)));Ba(a,b,.5*Math.cos(d));.5>g&&1<d-c&&(a.state=Ea(a,b))},L:(d,e,g)=>{d=e.stack;const h=a.x,f=a.z;z(d,h,a.y,f);let k=g.x<h;g=O(g.z-f,g.x-h);k&&(d.push(za),g=Math.PI-g);B(d,g);a.s.U(e);d.pop();k&&d.pop();d.pop()}}}
function Ea(a,b){const c=b.m.ca.yb("bite",b.j);a.s=c;return{name:"creature_attack",C:()=>{-1===c.F&&(1.5>Math.abs(a.x-b.i.l)&&console.warn("Kill / hurt the hero"),a.state=Ia(a,b),a.s=b.m.ca.Ua("blink",b.j))},L:(d,e,g)=>{d=e.stack;const h=a.x,f=a.z;z(d,h,a.y,f);let k=g.x<h;g=O(g.z-f,g.x-h);k&&(d.push(za),g=Math.PI-g);B(d,g);a.s.U(e);d.pop();k&&d.pop();d.pop()}}}
function Ja(a,b){Ka(b.audio,a,b.m.ca.jb);const c=b.m.ca.zb(b.i.l<a.x?"left":"right",b.j);a.s=c;return{name:"creature_death",C:()=>{1<c.I&&a.ra.length&&(a.ra=[]);-1===c.F&&b.X.splice(b.X.indexOf(a),1)},L:(d,e)=>{console.log("DEATH");d=e.stack;z(d,a.x,a.y,b.u);c.U(e);d.pop()}}}function La(a,b){a.X.push(new Ca(a,b,0,a.u+.75))}function Ma(a){const b=a.j;a.X.forEach(c=>{va(c.s,b);c.state.C(a)})}
function Na(a,b,c){const d=b.stack,e=c.m.ca.Pb,g=c.j,h=Oa(c.i);c.X.forEach(f=>{f.state.L(a,b,h)});I(e,b);c.X.forEach(f=>{const k=f.z-.1875;f.ra.forEach(l=>{var n=f.x+l.fb,q=f.y+l.gb;let m=l.Da,u=l.La,r=l.Ma;var v=l.Ya;g<v&&(v=1-(v-g)/.125,m=Pa(v,l.Va,n,m),u=Pa(v,l.Wa,q,u),r=Pa(v,l.Xa,k,r));n-=m;q-=u;v=k-r;const A=Math.sqrt(n*n+q*q+v*v);z(d,m,u,r);B(d,O(v,n));d.push(new Float32Array([A,0,0,0,0,q,0,0,0,0,1,0,0,0,0,1]));J(e,"wiggle",Math.abs((Math.floor(24*Date.now()/1E3)+l.nb)%57+1-29));d.pop();d.pop();
d.pop()})})}function P(a,b,c,d,e,g){const h=.4*d;e=.1*e;b+=h;c+=e;return{index:a,fb:.05*d,gb:0,pb:h,qb:e,Ya:0,Va:b,Wa:c,Xa:g,Da:b,La:c,Ma:g,nb:0}}function Pa(a,b,c,d){return a*(a*d+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};class Qa{constructor(a){this.a=!1;this.x=a}L(a,b,c){a=b.stack;const d=c.m.oa.ub;z(a,this.x,0,c.u);I(d,b);J(d,this.a?"on":"off",0);a.pop()}}class Ra{constructor(a,b){this.a=b;this.x=a}Ia(){return Sa(this.a,"down")}L(a,b,c){a=b.stack;const d=c.m.oa.Lb;z(a,this.x,0,c.u);I(d,b);J(d,"lowerHatch",0);a.pop()}}class Ta{constructor(a,b){this.a=b;this.x=a}Ia(){return Sa(this.a,"up")}L(a,b,c){a=b.stack;const d=c.m.oa.sb;z(a,this.x,0,c.u);I(d,b);J(d,"main",0);a.pop()}}
function Sa(a,b){return{Na:a,Ub:b,$a:Date.now()/1E3,bb:1}};const Ua=434/1.8,S=405/Ua;function Oa(a){return{x:a.l,z:a.P+1.8-.1}}function Va(a){return(a=a.s.wa())?a.Ra:null}function T(a,b){a.cb=b;0!==b&&(a.qa=Math.sign(b))}
class Wa{constructor(a,b,c){this.l=b;this.ga=0;this.P=c;this.qa=1;this.cb=0;this.s=a.Ka("right",0);this.state={name:"unstarted",C:d=>this.A(d,U),L:()=>{throw Error("Hero did not get processed before rendering!");}}}O(a,b,c=-1===this.qa?"left":"right"){this.s=a(c,b)}U(a,b){a=b.stack;z(a,this.l,this.ga,this.P);this.s.U(b);a.pop()}A(a,b,c){const d=this.state.Ca;d&&d();this.state=b=b(this,a,c);b.C(a)}}function Xa(a,b,c){const d=c.i.state.L;d?d(a,b):c.i.U(a,b)}
function U(a,b){let c=!0;a.O(b.m.i.Ka,b.j);return{name:"normal",C:d=>{const e=d.i,g=d.j;var h=d.input;const f=sa(h,"down","up");if(!f||!d.Aa.some(l=>{if(l instanceof Qa){if(1===f&&!l.a&&.4>Math.abs(e.l-l.x))return e.A(d,Ya,l),!0}else if(l instanceof Ra){if(-1===f)return e.A(d,Za,l),!0}else if(l instanceof Ta&&1===f)return e.A(d,$a,l),!0}))if(G(h,"attack"))e.A(d,ab);else{h=1.2*d.Ea*sa(h,"left","right");var k=e.l+h;k<d.M+S?h=d.M+S-e.l:k>d.N-S&&(h=d.N-S-e.l);T(e,h/d.Ea);k=-1===e.qa?"left":"right";h?
(e.l+=h,c&&(c=!1,e.O(d.m.i.Eb,g))):c||(c=!0,e.O(d.m.i.Ka,g));wa(e.s,k)}}}}function ab(a,b){const c=a.l+300/Ua*a.qa;var d=b.X.find(e=>.4>Math.abs(c-e.x));d&&"creature_death"!==d.state.name&&d.A(b,Ja);a.O(b.m.i.wb,b.j);T(a,0);d=b.m.i.ob;Ka(b.audio,a,d[Math.floor(Math.random()*d.length)]);return{name:"attacking",C:e=>{-1===a.s.F&&a.A(e,U)}}}
function Ya(a,b,c){a.O(b.m.i.Db,b.j,"main");T(a,0);a.l=c.x;return{name:"switch_on",C:()=>{!c.a&&6<=a.s.I&&(Ka(b.audio,c,b.m.i.tb),b.Ta=!0,c.a=!0);-1===a.s.F&&a.A(b,U)}}}function $a(a,b,c){a.O(b.m.i.xb,b.j,"up");T(a,0);a.ga=.55;a.l=c.x;b.transition=c.Ia();return{name:"climbing",C:d=>{-1===a.s.F?a.A(d,U):a.P=d.u+.3*Math.min(5,a.s.I)},Ca:()=>{a.ga=0;a.P=b.u}}}
function bb(a,b){T(a,0);a.O(b.m.i.Ab,b.j,"down");a.ga=.55;return{name:"descending",C:c=>{-1===a.s.F?a.A(c,U):a.P=c.u+.3*Math.min(5,8-a.s.I)},Ca:()=>{a.ga=0;a.P=b.u}}}function Za(a,b,c){T(a,0);a.l=c.x;a.O(b.m.i.Bb,b.j,"enter");b.transition=c.Ia();return{name:"descending",C:d=>{-1===a.s.F&&a.A(d,U)}}}
function cb(a,b){const c=b.j;a.O(b.m.i.Cb,b.j,"exit");T(a,0);b.Ja++;return{name:"entering_hatch",C:()=>{const d=a.s;if(b.j<c+1){var e=b.j;if(!d.xa.includes("exit"))throw Error(`${d} does not have mode ${"exit"}`);d.v=0;d.a="exit";d.I=0;d.F=e+d.S[0]}else-1===d.F?a.A(b,U):a.P=b.u+([-.5,-.5,-.3,-.3][a.s.I]||0)},L:(d,e)=>{b.j<c+1||a.U(d,e)},Ca:()=>{b.Ja--;a.P=b.u}}}
async function db(a,b){const [c,d,e,g,h,f,k,l]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),a("hero_climbing","assets/Climbing Up.png"),a("hero_hatch","assets/climbing_in.png"),a("hero_light","assets/Hero flipping Switch.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")]),b("assets/light.mp3")]);a={name:"hero_hatch_enter",V:h,D:350,B:406,G:161,H:479,
ea:6,K:!1,J:.125,Z:[{f:201,g:137,b:172,c:175},{f:422,g:246,b:461,c:259},{f:67,g:659,b:113,c:651},{f:419,g:658,b:462,c:648},{f:80,g:1041,b:106,c:1067},null],aa:"enter"};b={name:"hero_climbing_up",V:g,D:222,B:412,G:110,H:412,ea:8,K:!1,J:.125,Z:[{f:128,g:60,b:65,c:54},{f:329,g:155,b:277,c:148},{f:579,g:58,b:518,c:56},{f:772,g:157,b:721,c:156},{f:95,g:575,b:65,c:567},{f:337,g:472,b:286,c:465},null,null],aa:"up",scale:1.4};return{ob:k,Ka:Y({name:"hero_idle",V:c,D:405,B:434,G:220,H:434,ea:16,K:!0,J:1/12,
Z:[{f:388,g:104,b:385,c:170},{f:792,g:105,b:790,c:170},{f:1198,g:105,b:1195,c:169},{f:1602,g:106,b:1600,c:170},{f:2008,g:106,b:2005,c:172},{f:388,g:539,b:385,c:604},{f:794,g:540,b:790,c:605},{f:1196,g:539,b:1196,c:604},{f:1602,g:539,b:1602,c:604},{f:2009,g:541,b:2007,c:604},{f:386,g:974,b:385,c:1036},{f:792,g:972,b:790,c:1033},{f:1198,g:974,b:1196,c:1038},{f:1602,g:972,b:1601,c:1036},{f:2010,g:974,b:2005,c:1044},{f:386,g:1406,b:385,c:1477}]}),Eb:Y({name:"hero_walk",V:d,D:424,B:444,G:258,H:444,ea:8,
K:!0,J:.125,Z:[{f:408,g:110,b:404,c:166},{f:830,g:110,b:829,c:166},{f:408,g:554,b:404,c:614},{f:830,g:554,b:829,c:614},{f:408,g:998,b:404,c:1055},{f:830,g:998,b:829,c:1055},{f:408,g:1444,b:404,c:1500},{f:830,g:1444,b:829,c:1500}]}),wb:Y({name:"hero_attack",V:e,D:644,B:565,G:284,H:565,ea:5,K:!1,J:1/12,Z:[{f:422,g:285,b:415,c:353},{f:936,g:367,b:868,c:380},{f:1507,g:311,b:1469,c:318},{f:162,g:948,b:206,c:943},{f:1025,g:934,b:976,c:962}]}),xb:Y(b),Ab:Y({...b,name:"hero_hatch_descend",aa:"down",ab:!0}),
Bb:Y(a),Cb:Y({...a,name:"hero_hatch_exit",aa:"exit",ab:!0}),Db:Y({name:"hero_switch",V:f,D:274,B:444,G:104,H:442,ea:9,K:!1,J:1/12,aa:"main",Z:null}),tb:l}}
function Y(a){var b=a.V;const c=a.D,d=a.B,e=a.G,g=a.H,h=a.ab?m=>[...m].reverse():m=>m,f=Ua/(a.scale||1),k=Math.floor(b.w/c),l={x:e/f,z:(d-g)/f,width:c/f,height:d/f,ma:c/b.w,la:d/b.o,ja:k,count:a.ea},n=a.Z&&a.Z.map((m,u)=>{if(!m)return{Ra:null};const r=m.f,v=m.g;return{Ra:{x:(r-(u%k*c+e))/f,z:(Math.floor(u/k)*d+g-v)/f,angle:O(-(v-m.c),r-m.b)}}});let q;a.aa?(q=[a.aa],b=new L(b,{[a.aa]:h(N(l))})):(q=["left","right"],b=new L(b,{right:h(N(l)),left:h(N({...l,ka:!0}))}));return M({name:a.name,set:b,pa:q,
K:a.K,J:a.J,Hb:n&&h(n)})};function eb(a,b){var c=376/b;const d=c/(484/b),e=c/(268/b);c/=1.25;const g=b/a*c;return{Fb:new Float32Array([g,0,0,0,0,0,1/1.5,(e-d)/1.5,0,c,0,0,0,0,0,(d+e)/2]),Wb:d,Vb:e,Jb:g,Kb:c,D:a,B:b,ia:554/b*d/c-1.25,T:.3}}
async function fb(a,b){const [c,d,e,g,h,f,k]=await Promise.all([b("ladder","assets/ladder.png"),b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png"),b("set_pieces","assets/set_pieces.png"),b("lights","assets/Light Switch Flip.png")]);b=new L(c,{main:[Z(a,c,{G:c.w,H:c.o,D:c.w,B:c.o,offsetY:.55,Ba:1.25})]});var l={};l.barrel1=[Z(a,f,{G:370,H:270,D:338,B:222,offsetY:.55})];l.upperHatch=[Z(a,f,{G:2036,H:725,D:345,B:311,offsetY:.55})];
l.lowerHatch=[Z(a,f,{G:2036,H:725,D:345,B:311,offsetY:.1,kb:!0,Ba:.5})];l=new L(f,l);const n=new L(k,{on:[Z(a,k,{G:316,H:1110,D:118,B:152,offsetY:.75,Ba:1.4})],off:[Z(a,k,{G:316,H:298,D:118,B:152,offsetY:.75,Ba:1.4})]});return{$:a,Yb:d,mb:e,ib:g,Nb:h,sb:b,Lb:l,ub:n}}
function gb({Yb:a,mb:b,ib:c,Nb:d,$:e},g,h){const f=h-e.T;h=h+g+e.T;var k=494/a.o,l=1016/a.o,n=(l-k)*a.o/2.5*g/a.w;a=new L(a,{main:[[h,.75,2.5,n,k,h,.75,0,n,l,f,.75,2.5,0,k,f,.75,0,0,l]]});k=110/b.o;l=220/b.o;n=(l-k)*b.o/1.5*g/b.w;b=new L(b,{main:[[h,-.75,-e.ia,n,1,f,-.75,-e.ia,0,1,h,-.75,0,n,l,f,-.75,0,0,l,h,.75,0,n,k,f,.75,0,0,k]]});k=144/c.o;l=32/c.o;g=(l-k)*c.o/1.5*g/c.w;c=new L(c,{main:[[h,-.75,2.5+e.ia,g,0,f,-.75,2.5+e.ia,0,0,h,-.75,2.5,g,l,f,-.75,2.5,0,l,h,.75,2.5,g,k,f,.75,2.5,0,k]]});g=438/
d.w;k=318/d.w;l=194/d.o;n=1164/d.o;const q=84/d.w;e=[f,-.75,2.5,g,l,f,-.75,0,g,n,f+e.T,-.75,2.5,k,l,f+e.T,-.75,0,k,n,f+e.T,.75,2.5,q,414/d.o,f+e.T,.75,0,q,964/d.o];g=[];for(k=0;k<e.length;k+=5)g.push(h+(f-e[k]),e[k+1],e[k+2],e[k+3],e[k+4]);d=new L(d,{right:[g],left:[e]});return{Xb:a,lb:b,hb:c,Mb:d}}
function Z(a,b,{offsetX:c=0,offsetY:d=0,Ba:e=0,G:g,H:h,D:f,B:k,kb:l=!1,$b:n=!1}){let q=(h-k)/b.o;h/=b.o;l&&(l=q,q=h,h=l);l=(g-f)/b.w;b=g/b.w;n&&(n=l,l=b,b=n);const m=a.Jb;n=a.Kb;g=(d+.75)/1.5;g=a.Wb*(1-g)+a.Vb*g;c=c*m/g;e=e*n/g;f=f/a.D/2;k=k/a.B/2;a=(c-f)*g/m;f=(c+f)*g/m;c=(e+k)*g/n;k=(e-k)*g/n;return[a,d,c,l,q,f,d,c,b,q,a,d,k,l,h,f,d,k,b,h]};function Ka(a,b,c){const d=a.v;var e=d.get(b);e&&e.stop();a=a.a;e=a.createBufferSource();e.buffer=c;e.connect(a.destination);e.start();d.set(b,e)}function hb(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.a.decodeAudioData(c))}class ib{constructor(){this.a=new AudioContext;this.v=new WeakMap}};function jb(a){const b=a.j,c=a.Ea,d=a.i,e=a.Oa,g=Math.floor(48*b)-Math.floor(48*(b-c));for(let m=0;m<g;m++){var h=2*Math.random()+1.4;let u=.1*Math.sin(2*Math.PI*Math.random());var f=Va(d);if(!f)break;const r=d.l+f.x*d.qa,v=f.z+d.P,A=Math.PI/4*(Math.random()-.5)+f.angle;f=h*Math.sin(A);h=h*Math.cos(A)+d.cb;100<e.length&&e.pop();e.push({R:!1,x:r,y:d.ga+.01,z:v,Y:h,na:u,da:f,startTime:b,Qa:b+1.5,Za:!1})}const k=a.u,l=9.8*c,n=0*c,q=1-.8*c;e.forEach(m=>{var u=m.R;if(!u&&b<m.Qa){m.x+=m.Y*c;m.y+=m.na*c;
m.z+=m.da*c;u=m.da;m.Za?(m.Y*=q,m.na*=q):(u-=l,m.Y-=n,m.da=u);if(m.x<a.M||m.x>a.N||m.z>a.u+2.5)m.R=!0;const r=m.y;if(-.75>r||.75<r){const v=0<r?.75:-.75;m.y=v+(v-r);m.na=-m.na}m.z<k&&(-.01<u?(m.z=k,m.da=0,m.Za=!0):(m.z=k+k-m.z,m.da=-.25*u))}else u||(m.R=!0)});e.sort(kb)}
function lb(a){const b=1/18/18,c=g=>Math.max(0,Math.min(255,Math.round(256*(1-b*g*g)))),d=[];for(let g=0;2>g;g++)for(let h=0;18>h;h++)for(let f=0;2>f;f++){let k;var e=void 0;let l;e=h+6*f;18>e?(k=255,e=c(e),l=255):l=e=k=0;c(h+6*f);c(h+6*f+1);for(let n=0;2>n;n++)d.push(k,e,e,l)}a=oa({name:"spark",width:72,height:2,h:a,Ha:new Uint8Array(d)});return new L(a,{fading:N({x:1/180,width:.04,height:2/180,ma:1/18,la:1,ja:18,count:18})})}function kb(a,b){return a.R?b.R?0:1:b.R?-1:a.y-b.y}
function mb(a,b){const c=b.m.Ob,d=a.stack;I(c,a);b.Oa.forEach(e=>{e.R||(z(d,e.x,e.y,e.z),B(d,(0<=e.Y?Math.PI:0)+Math.atan(e.da/e.Y)),J(c,"fading",Math.floor(12*(b.j-e.startTime))),d.pop(),d.pop())})};function nb(a){const b=a.M,c=a.N,d=a.u,e=a.ha;return{name:a.name,m:e.m,input:e.input,audio:e.audio,X:[],j:0,Ib:Date.now()/1E3-1/60,Ea:0,M:b,N:c,u:d,va:gb(e.m.oa,c-b,b),Oa:[],Ta:!1,i:new Wa(e.m.i,(c+b)/2,d),transition:null,Ja:0,ta:0,Aa:[]}};function ob(a,b,c){const d=a.a.h,e=a.v;d.bindFramebuffer(d.FRAMEBUFFER,a.xa);d.viewport(0,0,e.w,e.o);ka(a.a,(g,h)=>{pb(g,h,b,a,c)})}
class qb{constructor(a,b,c,d){b/=4;c/=4;var e=new C({h:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  gl_Position = u_projection * vec4(a_position, 1);\n  v_texturePosition = a_texturePosition;\n}"),g=new C({h:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\nuniform vec4 u_color;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    \n    if (u_threshold != -1.f) {\n      color.a -= u_threshold;\n      if (color.a <= u_threshold) {\n          discard;\n      }\n      output_color = color;\n    } else {\n      if (color.a == 0.f) {\n        discard;\n      }\n      output_color = u_color;\n    }\n}");const h=
new ja({h:a,$:"projection"});ia(h,e,g).link();e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);g=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,g);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0);a.bindFramebuffer(a.FRAMEBUFFER,
null);const f=128/d;d=oa({name:"fade",width:64,height:64,h:a,Ha:rb(d)});this.a=h;this.v=qa({V:e,name:"lighting",width:b,height:c,h:a});this.xa=g;this.S=new L(d,{main:[[f,0,-f,1,0,f,0,f,1,1,-f,0,-f,0,0,-f,0,f,0,1]]});a=oa({name:"solid",width:1,height:1,h:a,Ha:new Uint8Array([255,255,255,255])});this.za=new L(a,{main:[[0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0]]})}}
function pb(a,b,c,d,e){a.blendFunc(a.ONE,a.ONE);a.clearColor(0,0,0,0);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const g=b.W.threshold,h=b.W.color;a.uniform1f(g,-1);const f=b.stack;c(f,()=>{const k=d.za;I(k,b);e.forEach(n=>{a.uniform4f(h,0,0,0,window.lightsOn||n.Ta?1:n.ta);const q=n.m.oa.$,m=n.M-q.T;f.push(new Float32Array([n.N+q.T-m,0,0,0,0,0,0,0,0,0,2*q.ia+2.5,0,m,-.75,n.u-q.ia,1]));J(k,"main",0);f.pop()});const l=d.S;I(l,b);a.uniform4f(h,0,0,0,1);e.forEach(n=>{const q=n.j;n.Oa.forEach(m=>{if(!m.R){var u=
m.startTime;u=(q-u)/(m.Qa-u);a.uniform1f(g,.5*u*u);z(f,m.x,m.y,m.z);J(l,"main",0);f.pop()}})})})}function rb(a){const b=new Uint8Array(16384),c=(g,h)=>{g/=a;h/=a;return g*g+h*h},d=Math.min(c(32,0),c(32,0));for(let g=0;64>g;g++)for(let h=0;64>h;h++){const f=4*(64*g+h);var e=c(h-32,g-32);const k=1-Math.sqrt(e/d);e=1E-4>=e?5:0;const l=Math.max(Math.round(255*k*k),0);b[f]=e+Math.max(Math.round(20*k),0);b[f+1]=e;b[f+2]=e;b[f+3]=l}return b};function sb(a,b){const c=a.a;let d=c.get(b);d||(d=tb(a.ha,b),c.set(b,d));return d}function ub(a,b){a.sa.name!==b&&(a.sa=sb(a,b))}class vb{constructor(a,b){this.ha=a;this.a=new Map([[b.name,b]]);this.sa=b}}
function tb(a,b){switch(b){case "start":return a=nb({ha:a,name:b,N:5,M:-5,u:20}),a.ta=.4,a.i.l=-1,a.Aa.push(new Qa(1),new Ra(3,"second")),a;case "second":return a=nb({ha:a,name:b,N:5,M:-15,u:15}),a.ta=.4,a.Aa.push(new Qa(1),new Ta(3,"start"),new Ra(-10,"r0")),La(a,-8),a;case "r0":return a=nb({ha:a,name:b,M:0,N:12,u:0}),b=a.i,b.l=a.M+4,La(a,b.l+2),a.ta=.1,a;case "r1":return a=nb({ha:a,name:b,M:-12,N:10,u:5.5}),La(a,0),a;default:throw Error(`Unrecognized room name "${b}"`);}}
function wb(a){return{x:Math.min(Math.max(a.i.l,a.M+1),a.N-1),y:0,z:a.u+1.25}};window.onload=async function(){function a(p,t){p.push(u.Fb);z(p,-K.x,-K.y,-K.z);z(p,0,0,Fa);B(p,Ga);t();p.pop();p.pop();p.pop()}function b(p,t,w){const E=t.stack;z(E,0,0,w.u);var y=w.va.Xb;I(y,t);J(y,"main",0);y=w.va.lb;I(y,t);J(y,"main",0);y=w.va.hb;I(y,t);J(y,"main",0);y=w.va.Mb;I(y,t);J(y,"left",0);J(y,"right",0);E.pop();w.Aa.forEach(x=>{x.L(p,t,w)});Xa(p,t,w);Na(p,t,w);mb(t,w)}function c(p,t,w){p.bindFramebuffer(p.FRAMEBUFFER,null);p.viewport(0,0,q,m);p.blendFunc(p.SRC_ALPHA,p.ONE_MINUS_SRC_ALPHA);
p.clearColor(0,0,0,1);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);p.activeTexture(p.TEXTURE1);A.v.bindTexture();p.uniform1i(t.W.lighting,1);p.activeTexture(p.TEXTURE0);a(t.stack,()=>{w.forEach(E=>{const y=t.stack.depth();b(p,t,E);t.stack.depth()!==y&&console.error("yo!")})})}function d(){!pa&&G(f,"fullscreen")&&(pa=g.requestFullscreen());const p=Date.now()/1E3;ba=-1===ba?60:.125/(p-Ha)+.875*ba;e.innerHTML=`fps=${Math.round(ba)}`;Ha=p;var t=Math.sin(Math.PI*(p+0)/8)/2+Math.sin(Math.PI*(p+0)/3)/
8,w=Math.sin(Math.PI*(p+170)/8)/2+Math.sin(Math.PI*(p+130)/3)/8;Ga=Math.asin((t-w)/100);Fa=(t+w)/2;w=Q.sa;t=null;const E=w.transition;E&&(E.$a+E.bb<p?(w.transition=null,ub(Q,E.Na),w=Q.sa):t=sb(Q,E.Na));const y=t?[w,t]:[w];y.forEach(x=>{{const F=p-x.Ib;x.Ea=F-x.j;x.j=F}});K=wb(w);t&&(w=Math.sin(Math.PI/2*((p-E.$a)/E.bb)),t=wb(t),K={x:K.x*(1-w)+t.x*w,y:K.y*(1-w)+t.y*w,z:K.z*(1-w)+t.z*w});ra(f)%2&&(l=!l,window.lightsOn=l);y.forEach(x=>{{let R=x.transition;var F=x.i;va(F.s,x.j);F.state.C(x);if(x.transition&&
!R){R=x.transition;{F=sb(Q,R.Na);const ca=F.i;"up"===R.Ub?(ca.l=x.i.l,ca.A(F,cb)):(ca.l=x.i.l,ca.A(F,bb))}}jb(x);R||x.Ja||Ma(x)}});ob(A,a,y);ka(v,(x,F)=>c(x,F,y));requestAnimationFrame(d)}const e=document.getElementById("fps"),g=document.getElementById("canvas");var h=window.getComputedStyle(g);const f=new ta(document.body);D(f,"left",["a","ArrowLeft"]);D(f,"right",["d","ArrowRight"]);D(f,"showLights",["l"]);D(f,"attack",["f"," "]);D(f,"fullscreen",["u"]);D(f,"up",["w","ArrowUp"]);D(f,"down",["s",
"ArrowDown"]);D(f,"lightUp",["y"]);D(f,"lightDown",["h"]);var k=parseInt(h.getPropertyValue("width"),10);h=parseInt(h.getPropertyValue("height"),10);let l=!1;const n=window.devicePixelRatio||1,q=n*k,m=n*h;g.width=q;g.height=m;const u=eb(k,h),r=g.getContext("webgl2",{antialias:!1,alpha:!1});r.enable(r.BLEND);r.enable(r.DEPTH_TEST);r.depthFunc(r.LEQUAL);k=new C({h:r,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
h=new C({h:r,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const v=new ja({h:r,$:"projection"});ia(v,k,h).link();const A=new qb(r,q,m,360),H=new ib;k=(p,t)=>ma({h:r,name:p,src:t});h=p=>hb(H,p);const [V,W,X]=await Promise.all([fb(u,k),Aa(k,h),db(k,h)]);k={m:{ca:W,i:X,oa:V,Ob:lb(r)},input:f,audio:H};const Q=new vb(k,tb(k,"start"));let ba=-1,pa=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(pa=null)});let K={x:0,y:0,z:0},Ga,Fa,Ha=Date.now();requestAnimationFrame(d);g.onmousemove=()=>{}};
