'use strict';class fa{constructor(c,a,b){this.name=b;this.i=`${a}${b}`;switch(c){case "uniform":this.type=1;if("u_"!==a)throw Error(`uniform field "${this.i}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==a)throw Error(`in field "${this.i}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ha(c){const a=[];c.split("\n").forEach(b=>{(b=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(b))&&a.push(new fa(b[1],b[2],b[3]))});return a}
const v=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function w(c,a){c.a.uniformMatrix4fv(c.c,!1,a);c.b.push(a)}function x(c,a,b,d=0){var e=c.b;e=e.length?e[e.length-1]:v;w(c,new Float32Array([e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],a*e[0]+b*e[4]+d*e[8]+e[12],a*e[1]+b*e[5]+d*e[9]+e[13],a*e[2]+b*e[6]+d*e[10]+e[14],a*e[3]+b*e[7]+d*e[11]+e[15]]))}
function ia(c,a){var b=Math.cos(a);a=Math.sin(a);b=new Float32Array([b,0,a,0,0,1,0,0,-a,0,b,0,0,0,0,1]);a=c.b;0===a.length?w(c,b):(a=a[a.length-1],w(c,new Float32Array([b[0]*a[0]+b[1]*a[4]+b[2]*a[8]+b[3]*a[12],b[0]*a[1]+b[1]*a[5]+b[2]*a[9]+b[3]*a[13],b[0]*a[2]+b[1]*a[6]+b[2]*a[10]+b[3]*a[14],b[0]*a[3]+b[1]*a[7]+b[2]*a[11]+b[3]*a[15],b[4]*a[0]+b[5]*a[4]+b[6]*a[8]+b[7]*a[12],b[4]*a[1]+b[5]*a[5]+b[6]*a[9]+b[7]*a[13],b[4]*a[2]+b[5]*a[6]+b[6]*a[10]+b[7]*a[14],b[4]*a[3]+b[5]*a[7]+b[6]*a[11]+b[7]*a[15],
b[8]*a[0]+b[9]*a[4]+b[10]*a[8]+b[11]*a[12],b[8]*a[1]+b[9]*a[5]+b[10]*a[9]+b[11]*a[13],b[8]*a[2]+b[9]*a[6]+b[10]*a[10]+b[11]*a[14],b[8]*a[3]+b[9]*a[7]+b[10]*a[11]+b[11]*a[15],b[12]*a[0]+b[13]*a[4]+b[14]*a[8]+b[15]*a[12],b[12]*a[1]+b[13]*a[5]+b[14]*a[9]+b[15]*a[13],b[12]*a[2]+b[13]*a[6]+b[14]*a[10]+b[15]*a[14],b[12]*a[3]+b[13]*a[7]+b[14]*a[11]+b[15]*a[15]])))}class ja{constructor(c,a){this.a=c;this.c=a;this.b=[];c.uniformMatrix4fv(a,!1,v)}pop(){return this.b.pop()}}
class z{constructor(c,a){this.name=c.name;var b=this.a=c.a;c=this.type=c.type;switch(c){case "vertex":var d=this.a.VERTEX_SHADER;break;case "fragment":d=this.a.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${c}"`);}d=this.b=b.createShader(d);b.shaderSource(d,a);b.compileShader(d);if(!b.getShaderParameter(d,b.COMPILE_STATUS))throw a=`Failed to compile ${this.name} ${c}-shader: ${b.getShaderInfoLog(d)}`,b.deleteShader(d),Error(a);this.I=ha(a)}}
function ka(c,...a){const b=c.a,d=c.o;a.forEach(e=>{c.v.push(e);b.attachShader(d,e.b)});return c}function A(c,a){c.g.includes(a)||c.g.push(a);requestAnimationFrame(c.M)}
class la{constructor(c){this.name=c.name;this.s=c.s;c=this.a=c.a;this.B=!1;this.o=c.createProgram();this.v=[];this.c={};this.b={};this.stack=null;this.g=[];this.M=()=>{var a=this.a,b=this.o;a.useProgram(b);for(var d={},e={},k=this.v,g=0;g<k.length;g++)for(var f=k[g].I,l=0;l<f.length;l++){var p=f[l];1===p.type?p.i in d||(d[p.name]=a.getUniformLocation(b,p.i)):p.i in e||(e[p.name]=a.getAttribLocation(b,p.i))}this.c=d;this.b=e;if(b=this.s)if(b in this.c)this.stack=new ja(a,this.c[b]);else throw Error(`No anchor point "${b}" in program`);
try{var q=this.g;this.g=[];for(g=0;g<q.length;q++)q[g](a,this)}finally{this.c={},this.b={},this.stack=null}}}link(){if(this.B)return this;var c=this.a,a=this.o;c.linkProgram(a);if(!c.getProgramParameter(a,c.LINK_STATUS)){var b=`Failed to link ${this.name} program: ${c.getProgramInfoLog(a)}`;c.deleteProgram(a);throw Error(b);}this.B=!0;return this}}
class D{constructor(c,a,b,d,e){this.a=c;this.name=a;this.w=b;this.f=d;a=this.b=c.createTexture();c.bindTexture(c.TEXTURE_2D,a);e(c);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST);c.bindTexture(c.TEXTURE_2D,null)}bindTexture(){this.a.bindTexture(this.a.TEXTURE_2D,this.b)}}
function J(c){return(new Promise((a,b)=>{const d=new Image;d.onload=()=>void a(d);d.onerror=()=>{b(Error(`failed to load ${c.src}`))};d.mode="no-cors";d.src=c.src})).then(a=>{const b=a.naturalWidth,d=a.naturalHeight;return new D(c.a,c.name,b,d,e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,b,d,0,e.RGBA,e.UNSIGNED_BYTE,a)})})}function ma(c){const a=c.width,b=c.height;return new D(c.a,c.name,a,b,d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a,b,0,d.RGBA,d.UNSIGNED_BYTE,c.K,0)})};function K(c,a){const b=c.b.a;let d=c.c;null!=d?b.bindBuffer(b.ARRAY_BUFFER,d):(c.c=d=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,d),b.bufferData(b.ARRAY_BUFFER,c.g,b.STATIC_DRAW));b.activeTexture(b.TEXTURE0);c.b.bindTexture();b.uniform1i(a.c.texture,0);b.enableVertexAttribArray(a.b.texturePosition);b.vertexAttribPointer(a.b.texturePosition,2,b.FLOAT,!1,20,12);b.enableVertexAttribArray(a.b.position);b.vertexAttribPointer(a.b.position,3,b.FLOAT,!1,20,0)}
function L(c,a,b){if(!c.data.hasOwnProperty(a))throw Error(`Can not render unknown "${a}"`);a=c.data[a];c=c.b.a;const d=a.J;c.drawArrays(c.TRIANGLE_STRIP,d[b%d.length],a.N)}
class M{constructor(c,a){this.b=c;this.c=null;c=this.data={};const b=[];let d=0;for(const e in a){const k=a[e],g=[],f=k.length;if(0===f)throw Error("Sprite declared with 0 points");const l=k[0].length;if(0==l)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const p=l/5;for(let q=0;q<f;q++){const t=k[q];if(t.length!==l)throw Error("Sprite declared with inconsistent lengths of elements");g.push(d);b.push.apply(b,t);d+=p}c[e]={T:this,name:e,J:g,N:p}}this.g=new Float32Array(b)}}
;function N(c,a,b){c=c.c;null!=b?c.set(a,b):c.delete(a)}function O(c,a){a=c.c.get(a);const b=c.b;return!!a&&a.some(d=>b.get(d))}function na(c){const a=O(c,"left")?1:0;return(O(c,"right")?1:0)-a}class oa{constructor(c){this.b=new Map;this.c=new Map;c.addEventListener("keydown",a=>{P(this,a,!0)});c.addEventListener("keyup",a=>{P(this,a,!1)});c.onblur=()=>{this.b.clear()};c.onfocus=()=>{this.b.clear()}}}
function P(c,a,b){a=a.key;c=c.b;const d=c.get(a);b?null==d&&c.set(a,Date.now()):null!=d&&c.delete(a)};function pa(){const c=new Uint8Array(4096),a=(e,k)=>{e/=360;k/=360;return e*e+k*k},b=Math.min(a(16,0),a(16,0));for(let e=0;32>e;e++)for(let k=0;32>k;k++){const g=4*(32*e+k),f=a(k-16,e-16);if(1E-4>=f)c[g]=255,c[g+1]=255,c[g+2]=255,c[g+3]=255;else{var d=Math.sqrt(1E-4/f);const l=Math.floor(256*d);d=Math.floor(256*d*d);c[g]=255;c[g+1]=d;c[g+2]=d;c[g+3]=f>=b?0:l}}return c}
function Q({H:c=0,U:a=0,V:b=0,G:d,A:e,F:k,j:g,count:f}){const l=d/360,p=e/360;return R({x:c*l,y:a,z:b*p,width:l,height:p,D:d/k.w,C:e/k.f,j:g,count:f})}function R({x:c=0,y:a=0,z:b=0,width:d,height:e,D:k,C:g,j:f,count:l}){const p=[];for(let q=0;q<l;q++){const t=Math.floor(q/f),B=q%f;p.push(qa({x:c,y:a,z:b,width:d,height:e,R:B*k,O:(B+1)*k,S:t*g,P:(t+1)*g}))}return p}function qa({x:c=0,y:a=0,z:b=0,width:d,height:e,R:k,S:g,O:f,P:l}){return[d-c,a,-b,f,l,-c,a,-b,k,l,d-c,a,e-b,f,g,-c,a,e-b,k,g]}
window.onload=async function(){function c(r,m){r=Date.now();const u=(r-S)/1E3;S=r;a.innerHTML=`fps=${Math.round(1/u)}`;w(m.stack,ra);r=(r-sa)/1E3;const T=Math.sin(Math.PI*(y+0)/8)/2+Math.sin(Math.PI*(y+0)/3)/8,U=Math.sin(Math.PI*(y+170)/8)/2+Math.sin(Math.PI*(y+130)/3)/8,F=Math.asin((T-U)/100),ta=Math.cos(F),ua=Math.sin(F);G=u*na(e);H+=G;const va=Math.floor(10*r)-Math.floor(10*y);for(let h=0;h<va;h++){var E=(Math.random()-.5)*Math.PI/4+Math.PI/2;const V=2*Math.random()+1,xa=H-wa/2+282/360,ya=326/
360,za=V*Math.sin(E);E=V*Math.cos(E);100<C.length&&C.shift();C.push({l:!1,x:xa,y:0,z:ya,m:E,L:.1*Math.sin(2*Math.PI*Math.random()),h:za})}C.forEach(h=>{h.l||(h.h-=9.8*ta*u,h.m-=9.8*ua*u,h.x+=h.m*u,h.y+=h.L*u,h.z+=h.h*u,0>h.z?(h.z=-h.z,h.h*=-.25):.01>h.z&&.1>Math.abs(h.h)&&(h.l=!0))});y=r;x(m.stack,-1.5,0,n.d/2+n.f+.5);ia(m.stack,F);x(m.stack,0,0,(T+U)/2);K(W,m);L(W,"main",0);K(X,m);L(X,"main",0);x(m.stack,H,0,0);0===G?(K(Y,m),L(Y,"idle",Math.floor(12*r))):(K(Z,m),L(Z,"walk",Math.floor(12*r)));m.stack.pop();
K(aa,m);C.forEach(h=>{h.l||(x(m.stack,h.x,h.y,h.z),L(aa,"main",0),m.stack.pop())});m.stack.pop();m.stack.pop();m.stack.pop();x(m.stack,ba/180,0,(g-ca)/180);r=Math.floor(8*r)%38;K(da,m);L(da,"blink",6>r?r:0);A(m,c)}const a=document.getElementById("fps"),b=document.getElementById("canvas");var d=window.getComputedStyle(b);const e=new oa(document.body);N(e,"left",["a","ArrowLeft"]);N(e,"right",["d","ArrowRight"]);let k=parseInt(d.getPropertyValue("width"),10),g=parseInt(d.getPropertyValue("height"),
10);d=window.devicePixelRatio||1;b.width=d*k;b.height=d*g;var f=b.getContext("webgl2",{antialias:!1,alpha:!1});f.enable(f.BLEND);f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA);f.enable(f.DEPTH_TEST);f.depthFunc(f.LEQUAL);const l=new z({a:f,type:"vertex"},"#version 300 es\n\n    in vec3 a_position;\n    in vec2 a_texturePosition;\n\n    uniform mat4 u_projection;\n\n    out vec2 v_texturePosition;\n\n    void main() {\n        vec4 position = u_projection * vec4(a_position, 1);\n        float variance = 1.f / (position.z + 1.f);\n\n        vec4 result = vec4(position.x, position.y * variance, -.5f * (position.z - 1.f) * variance, position.w * variance);\n        gl_Position = result;\n\n        v_texturePosition = a_texturePosition;\n    }\n"),
p=new z({a:f,type:"fragment"},"#version 300 es\n    precision mediump float;\n\n    uniform sampler2D u_texture;\n\n    in vec2 v_texturePosition;\n    out vec4 output_color;\n\n    void main() {\n        vec4 color = texture(u_texture, v_texturePosition.st);\n        if (color.a == 0.0) {\n            discard;\n        }\n        output_color = color;\n    }\n");d=new la({a:f,s:"projection"});ka(d,l,p).link();const [q,t,B,I,ea]=await Promise.all([J({a:f,src:"assets/Back Wall.png",name:"wall"}),J({a:f,
src:"assets/Floor 2.png",name:"floor"}),J({a:f,src:"assets/Hero Breathing.png",name:"idle"}),J({a:f,src:"assets/Enemy.png",name:"enemy"}),J({a:f,src:"assets/Hero Walking 2.png",name:"walk"})]),n={w:t.w/360,f:34/360,d:175/360,u:175/209},W=new M(q,{main:[[q.w/360,-n.d/2,q.f/360,1,0,q.w/360,-n.d/2,0,1,1,0,-n.d/2,q.f/360,0,0,0,-n.d/2,0,0,1]]}),X=new M(t,{main:[[n.w,n.d/2,-n.f,1,1,0,n.d/2,-n.f,0,1,n.w,n.d/2,0,1,n.u,0,n.d/2,0,0,n.u,n.w,-n.d/2,0,1,0,0,-n.d/2,0,0,0]]}),wa=296/360,Y=new M(B,{idle:Q({H:.5,
G:296,A:434,F:B,j:6,count:16})}),Z=new M(ea,{walk:Q({H:.5,G:322,A:442,F:ea,j:3,count:8})});f=ma({name:"fade",width:32,height:32,a:f,K:pa()});const da=new M(I,{blink:R({x:.15,width:.3,height:.3,D:108/I.w,C:108/I.f,j:2,count:6})}),aa=new M(f,{main:[[16/360,0,-16/360,1,0,16/360,0,16/360,1,1,-16/360,0,-16/360,0,0,-16/360,0,16/360,0,1]]});let ba=0,ca=0;const ra=new Float32Array([360/k,0,0,0,0,-360/g,.25,0,0,360/g,0,0,-1,-1,0,1]),C=[];let sa=Date.now(),S=Date.now(),y=0,H=4,G=0;A(d,c);b.onmousemove=r=>{ba=
r.offsetX;ca=r.offsetY}};
