'use strict';class aa{constructor(a,b,c){this.name=c;this.I=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.I}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.I}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ba(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new aa(c[1],c[2],c[3]))});return b}
const ca=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function D(a,b){a.f.uniformMatrix4fv(a.i,!1,b);a.a.push(b)}function G(a,b,c,e=0){var d=a.a;d=d.length?d[d.length-1]:ca;D(a,new Float32Array([d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],b*d[0]+c*d[4]+e*d[8]+d[12],b*d[1]+c*d[5]+e*d[9]+d[13],b*d[2]+c*d[6]+e*d[10]+d[14],b*d[3]+c*d[7]+e*d[11]+d[15]]))}function H(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class da{constructor(a,b){this.f=a;this.i=b;this.a=[];a.uniformMatrix4fv(b,!1,ca)}pop(){return this.a.pop()}push(a){var b=this.a;0===b.length?D(this,a):(b=b[b.length-1],D(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*b[3]+a[5]*b[7]+
a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class J{constructor(a,b){this.name=a.name;var c=this.f=a.f;a=this.type=a.type;switch(a){case "vertex":var e=this.f.VERTEX_SHADER;break;case "fragment":e=this.f.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}e=this.a=c.createShader(e);c.shaderSource(e,b);c.compileShader(e);if(!c.getShaderParameter(e,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(e)}`,c.deleteShader(e),Error(b);this.Ha=ba(b)}}
function ea(a,...b){const c=a.f,e=a.fa;b.forEach(d=>{a.sa.push(d);c.attachShader(e,d.a)});return a}class fa{constructor(a){this.name=a.name;this.K=a.K;a=this.f=a.f;this.a=!1;this.fa=a.createProgram();this.sa=[];this.F={};this.G={};this.stack=null}link(){if(this.a)return this;var a=this.f,b=this.fa;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.a=!0;return this}}
function ha(a,b){var c=a.f,e=a.fa;c.useProgram(e);for(var d={},h={},g=a.sa,f=0;f<g.length;f++)for(var k=g[f].Ha,l=0;l<k.length;l++){var m=k[l];1===m.type?m.I in d||(d[m.name]=c.getUniformLocation(e,m.I)):m.I in h||(h[m.name]=c.getAttribLocation(e,m.I))}a.F=d;a.G=h;if(e=a.K)if(e in a.F)a.stack=new da(c,a.F[e]);else throw Error(`No anchor point "${e}" in program`);try{b(c,a)}finally{a.F={},a.G={},a.stack=null}}
class ja{constructor(a,b,c,e,d){this.f=a;this.name=b;this.w=c;this.j=e;this.a=d(a)}bindTexture(){this.f.bindTexture(this.f.TEXTURE_2D,this.a)}}function ka(a){return(new Promise((b,c)=>{const e=new Image;e.onload=()=>void b(e);e.onerror=()=>{c(Error(`failed to load ${a.src}`))};e.mode="no-cors";e.src=a.src})).then(b=>{const c=b.naturalWidth,e=b.naturalHeight;return new ja(a.f,a.name,c,e,la(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,e,0,d.RGBA,d.UNSIGNED_BYTE,b)}))})}
function ma(a){const b=a.width,c=a.height;return new ja(a.f,a.name,b,c,la(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,b,c,0,e.RGBA,e.UNSIGNED_BYTE,a.ta,0)}))}function na(a){return new ja(a.f,a.name,a.width,a.height,()=>a.R)}
function la(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function L(a,b){const c=a.a.f;let e=a.i;null!=e?c.bindBuffer(c.ARRAY_BUFFER,e):(a.i=e=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,e),c.bufferData(c.ARRAY_BUFFER,a.B,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.a.bindTexture();c.uniform1i(b.F.texture,0);c.enableVertexAttribArray(b.G.texturePosition);c.vertexAttribPointer(b.G.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.G.position);c.vertexAttribPointer(b.G.position,3,c.FLOAT,!1,20,0)}
function M(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.a.f;const e=b.ga;a.drawArrays(a.TRIANGLE_STRIP,e[c%e.length],b.ab)}
class P{constructor(a,b){this.a=a;this.i=null;a=this.data={};const c=[];let e=0;for(const d in b){const h=b[d],g=[],f=h.length;if(0===f)throw Error("Sprite declared with 0 points");const k=h[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const l=k/5;for(let m=0;m<f;m++){const t=h[m];if(t.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");g.push(e);c.push.apply(c,t);e+=l}a[d]={sb:this,name:d,ga:g,ab:l}}this.B=new Float32Array(c)}}
function oa(a,b){for(var c=a.i;-1!==c&&c<=b;){c=a.Wa;const e=a.a+1;e===c.length?a.X===a.gb?a.i=c=-1:(a.X++,a.a=0,a.i=c=b+c[0]):(a.a=e,a.i=c=b+c[e])}}class pa{constructor(a,b,c,e){const d=a.D;this.wa=a.name;this.bb=a.$;this.B=c;this.gb="number"===typeof d?d:d?-1:0;this.xa=a.set;this.Wa=b;this.a=this.X=0;this.i=e+b[0];this.Ua=a.eb}W(){const a=this.Ua;return null!=a?a[this.a]:void 0}O(a){L(this.xa,a);M(this.xa,this.B,this.a)}name(){return this.wa}toString(){return`Sprite/${this.wa}`}}
function qa(a){const b=a.name,c=a.C,e=a.set.data;let d=-1;a.$.forEach(g=>{const f=e[g];if(!f)throw Error(`Sprite/${b} has non-existent mode ${g}`);if(-1===d)d=f.ga.length;else if(d!==f.ga.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===d)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==d)throw Error(`Sprite/${b} given ${c.length} frame times for ${d} frames`);if(a.W&&a.W.length!==d)throw Error(`Sprite/${b} given ${a.W.length} frame data points for ${d} frames`);
const h="number"===typeof c?Array(d).fill(c):c;return(g,f)=>new pa(a,h,g,f)}function Q({x:a=0,y:b=0,z:c=0,width:e,height:d,ea:h,da:g,aa:f,count:k,xb:l=0,yb:m=0,zb:t=h,wb:y=g,P:v=!1}){const z=[];for(let r=0;r<k;r++){const w=l+r%f*t,K=m+Math.floor(r/f)*y;z.push(ra({x:a,y:b,z:c,width:e,height:d,nb:w,lb:w+h,ob:K,mb:K+g,P:v}))}return z}function ra({x:a=0,y:b=0,z:c=0,width:e,height:d,nb:h,ob:g,lb:f,mb:k,P:l=!1}){l?(l=f,f=a-e):(l=h,h=f,f=-a,a=e-a);return[a,b,-c,h,k,f,b,-c,l,k,a,b,d-c,h,g,f,b,d-c,l,g]};function S(a,b,c){a=a.i;null!=c?a.set(b,c):a.delete(b)}function T(a,b){b=a.i.get(b);const c=a.a;return!!b&&!!b.some(e=>(e=c.get(e))?(e.T=0,null!=e.Y):!1)}function sa(a){const b=a.i.get("showLights");if(b){const c=a.a;return b.reduce((e,d)=>(d=c.get(d))?(e+=d.T,d.T=0,e):e,0)}return 0}function Ba(a,b,c){b=T(a,b)?1:0;return(T(a,c)?1:0)-b}
class Ca{constructor(a){this.a=new Map;this.i=new Map;a.addEventListener("keydown",b=>{Da(this,b,!0)});a.addEventListener("keyup",b=>{Da(this,b,!1)});a.onblur=()=>{this.a.clear()};a.onfocus=()=>{this.a.clear()}}}function Da(a,b,c){b=b.key;a=a.a;const e=a.get(b);c?null==e?a.set(b,{Y:Date.now(),T:1}):(null==e.Y&&(e.Y=Date.now()),e.T++):null!=e&&(e.Y=null)};function Ea(a,b){const c=a.a.f,e=a.i;c.enable(c.BLEND);c.blendFunc(c.ONE,c.ONE);c.bindFramebuffer(c.FRAMEBUFFER,a.X);c.viewport(0,0,e.w,e.j);ha(a.a,(d,h)=>{Fa(d,h,a,b)})}
class Ga{constructor(a,b,c,e){b/=4;c/=4;var d=new J({f:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  vec4 position = u_projection * vec4(a_position, 1);\n  // float inverse = 1.f / (1.f - position.z * .2f);\n\n  // vec4 result = vec4(position.x, -inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n  // gl_Position = result;\n  gl_Position = position;\n  \n  v_texturePosition = a_texturePosition;\n}"),h=
new J({f:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    color.a -= u_threshold;\n    if (color.a <= u_threshold) {\n        discard;\n    }\n    output_color = color;\n}");const g=new fa({f:a,K:"projection"});ea(g,d,h).link();d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,
0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);h=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,h);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.bindFramebuffer(a.FRAMEBUFFER,null);const f=128/e;e=ma({name:"fade",width:64,height:64,f:a,ta:Ha(e)});this.a=g;this.i=na({R:d,name:"lighting",
width:b,height:c,f:a});this.X=h;this.B=new P(e,{main:[[f,0,-f,1,0,f,0,f,1,1,-f,0,-f,0,0,-f,0,f,0,1]]})}}function Fa(a,b,c,e){e.Va?a.clearColor(0,0,0,1):a.clearColor(0,0,0,window.a);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);e.fb(a,b,()=>{const d=c.B;L(d,b);const h=b.F.threshold,g=e.pb;e.cb.forEach(f=>{if(!f.v){var k=f.startTime;k=(g-k)/(f.va-k);a.uniform1f(h,.5*k*k);G(b.stack,f.x,f.y,f.z);M(d,"main",0);b.stack.pop()}})})}
function Ha(a){const b=new Uint8Array(16384),c=(h,g)=>{h/=a;g/=a;return h*h+g*g},e=Math.min(c(32,0),c(32,0));for(let h=0;64>h;h++)for(let g=0;64>g;g++){const f=4*(64*h+g);var d=c(g-32,h-32);const k=1-Math.sqrt(d/e);d=1E-4>=d?5:0;const l=Math.max(Math.round(255*k*k),0);b[f]=d+Math.max(Math.round(20*k),0);b[f+1]=d;b[f+2]=d;b[f+3]=l}return b};function Ia(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const U=434/1.8,V=405/U;function Ja(a,b,c){c=c(a,b);a.state=c;c.ca(b)}function W(a){return-1===a.a?"left":"right"}function Ka(a){return(a=a.o.W())?a.Na:null}function La(a,b){a.i=b;0!==b&&(a.a=Math.sign(b))}class Ma{constructor(a,b){this.s=b;this.a=1;this.i=0;this.o=a.ja("right",0);this.state={name:"unstarted",ca:c=>Ja(this,c,Na),O:()=>{throw Error("Hero did not get processed before rendering!");}}}O(a,b){a=b.stack;G(a,this.s,0,0);this.o.O(b);a.pop()}}
function Oa(a){const b=a.l;oa(b.o,a.m);b.state.ca(a)}function Pa(a,b,c){const e=c.l.state.Fa;e?e(a,b,c):c.l.O(a,b)}
function Na(a,b){let c=!0;a.o=(0,b.u.l.ja)(W(a),b.m);return{name:"normal",ca:e=>{const d=e.l,h=e.m;var g=e.input;if(T(g,"attack"))Ja(d,e,Qa);else{g=1.2*e.na*Ba(g,"left","right");var f=d.s+g;f<e.L+V?g=e.L+V-d.s:f>e.M-V&&(g=e.M-V-d.s);La(d,g/e.na);f=W(d);g?(d.s+=g,c&&(c=!1,d.o=(0,e.u.l.Za)(W(d),h))):c||(c=!0,d.o=(0,e.u.l.ja)(W(d),h));e=d.o;if(f!==e.B){if(!e.bb.includes(f))throw Error(`${e} does not have mode ${f}`);e.B=f}}},Fa:null}}
function Qa(a,b){a.o=(0,b.u.l.Xa)(W(a),b.m);La(a,0);const c=b.u.l.Ra;Ra(b.audio,a,c[Math.floor(Math.random()*c.length)]);return{name:"attacking",ca:e=>{-1===a.o.i&&Ja(a,e,Na)},Fa:null}}
async function Sa(a,b){const [c,e,d,h]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")])]);a=Ta({name:"hero_idle",R:c,pa:405,ia:434,qa:220,ra:434,ha:16,D:!0,C:1/12,V:[{g:388,h:104,b:385,c:170},{g:792,h:105,b:790,c:170},{g:1198,h:105,b:1195,c:169},{g:1602,h:106,b:1600,c:170},{g:2008,h:106,b:2005,c:172},{g:388,
h:539,b:385,c:604},{g:794,h:540,b:790,c:605},{g:1196,h:539,b:1196,c:604},{g:1602,h:539,b:1602,c:604},{g:2009,h:541,b:2007,c:604},{g:386,h:974,b:385,c:1036},{g:792,h:972,b:790,c:1033},{g:1198,h:974,b:1196,c:1038},{g:1602,h:972,b:1601,c:1036},{g:2010,h:974,b:2005,c:1044},{g:386,h:1406,b:385,c:1477}]});b=Ta({name:"hero_walk",R:e,pa:424,ia:444,qa:258,ra:444,ha:8,D:!0,C:.125,V:[{g:408,h:110,b:404,c:166},{g:830,h:110,b:829,c:166},{g:408,h:554,b:404,c:614},{g:830,h:554,b:829,c:614},{g:408,h:998,b:404,c:1055},
{g:830,h:998,b:829,c:1055},{g:408,h:1444,b:404,c:1500},{g:830,h:1444,b:829,c:1500}]});const g=Ta({name:"hero_attack",R:d,pa:644,ia:565,qa:284,ra:565,ha:5,D:!1,C:1/12,V:[{g:422,h:285,b:415,c:353},{g:936,h:367,b:868,c:380},{g:1507,h:311,b:1469,c:318},{g:162,h:948,b:206,c:943},{g:1025,h:934,b:976,c:962}]});return{ja:a,Za:b,Xa:g,Ra:h}}
function Ta(a){var b=a.R;const c=a.pa,e=a.ia,d=a.qa,h=a.ra,g=Math.floor(b.w/c),f={x:d/U,z:(e-h)/U,width:c/U,height:e/U,ea:c/b.w,da:e/b.j,aa:g,count:a.ha},k=a.V&&a.V.map(({g:l,h:m,b:t,c:y},v)=>({Na:{x:(l-(v%g*c+d))/U,z:(Math.floor(v/g)*e+h-m)/U,angle:Ia(-(m-y),l-t)}}));b=new P(b,{right:Q(f),left:Q({...f,P:!0})});return qa({name:a.name,set:b,$:["left","right"],D:a.D,C:a.C,eb:k})};function Ua(a,b){var c=376/b;const e=c/(484/b),d=c/(268/b);c/=1.25;a=b/a*c;return{$a:new Float32Array([a,0,0,0,0,0,1,d-e,0,c,0,0,0,0,0,(e+d)/2]),Bb:e,Ab:d,ub:a,vb:c,Z:554/b*e/c-1.25,J:.3}}async function Va(a,b){const [c,e,d,h]=await Promise.all([b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png")]);return{K:a,rb:c,Pa:e,La:d,ib:h}}
function Wa({rb:a,Pa:b,La:c,ib:e,K:d},h,g){g=-g-d.J;const f=2*d.J+g+h;var k=494/a.j,l=1016/a.j,m=(l-k)*a.j/2.5*h/a.w;a=new P(a,{main:[[f,.5,2.5,m,k,f,.5,0,m,l,g,.5,2.5,0,k,g,.5,0,0,l]]});k=110/b.j;l=220/b.j;m=(l-k)*b.j*h/b.w;b=new P(b,{main:[[f,-.5,-d.Z,m,1,g,-.5,-d.Z,0,1,f,-.5,0,m,l,g,-.5,0,0,l,f,.5,0,m,k,g,.5,0,0,k]]});k=144/c.j;l=32/c.j;h=(l-k)*c.j*h/c.w;c=new P(c,{main:[[f,-.5,2.5+d.Z,h,0,g,-.5,2.5+d.Z,0,0,f,-.5,2.5,h,l,g,-.5,2.5,0,l,f,.5,2.5,h,k,g,.5,2.5,0,k]]});h=438/e.w;k=318/e.w;l=194/e.j;
m=1164/e.j;const t=84/e.w;d=[g,-.5,2.5,h,l,g,-.5,0,h,m,g+d.J,-.5,2.5,k,l,g+d.J,-.5,0,k,m,g+d.J,.5,2.5,t,414/e.j,g+d.J,.5,0,t,964/e.j];h=[];for(k=0;k<d.length;k+=5)h.push(f+(g-d[k]),d[k+1],d[k+2],d[k+3],d[k+4]);e=new P(e,{right:[h],left:[d]});return{qb:a,Oa:b,Ka:c,hb:e}};function Ra(a,b,c){const e=a.i;var d=e.get(b);d&&d.stop();a=a.a;d=a.createBufferSource();d.buffer=c;d.connect(a.destination);d.start();e.set(b,d)}function Xa(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.a.decodeAudioData(c))}class Ya{constructor(){this.a=new AudioContext;this.i=new WeakMap}};function Za(a){const b=a.L,c=a.M;return{u:a.u,input:a.input,audio:a.audio,S:[],m:a.m,na:0,L:b,M:c,Ga:a.Ga,ma:a.ma,U:Wa(a.u.Ma,c-b,b),l:a.l}};const $a=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function ab(a){const [b,c,e]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png")]);var d=new P(b,{blink:Q({x:.25,z:.25,width:.5,height:.5,ea:108/b.w,da:108/b.j,aa:2,count:6,P:!0})});a=qa({name:"creature_attack",set:new P(e,{bite:Q({x:.5,z:.75,width:1,height:2,da:530/e.j,ea:278/e.w,aa:7,count:42,P:!0})}),$:["bite"],D:!0,C:1/12});var h=Array(6).fill(.125);h[0]=4;d=qa({name:"creature_normal",set:d,$:["blink"],D:!0,
C:h});h=[];var g=92,f=-22;const k=Math.sqrt(g*g+f*f);g/=k;f/=k;for(let l=0;29>l;l++){const m=l%5,t=Math.floor(l/5),y=[],v=(z,r)=>{const w=100*z,K=77*r-48;y.push((w*g+K*f)/k,z,(w*-f+K*g)/360,100*(m+z)/c.w,77*(t+r)/c.j)};v(1,1);v(0,1);v(1,0);v(0,0);h.push(y)}h=new P(c,{wiggle:h});return{Ya:d,tb:a,kb:h}}class bb{constructor(a,b,c,e){a=a.u.ua.Ya("blink",a.m);this.x=this.jb=b;this.y=c;this.z=e;this.Ca=this.Da=0;this.oa=[Z(0,b,c,-1,1),Z(1,b,c,-1,-1),Z(2,b,c,1,1),Z(3,b,c,1,-1)];this.o=a}}
function cb(a){const b=a.m;a.S.forEach(c=>{c.x=c.jb+Math.sin(b);var e=.5*Math.cos(b);oa(c.o,a.m);if(b>c.Da){var d=c.Ca;c.Ca=(d+1)%c.oa.length;d=c.oa[d];e=c.x+.225*e+d.Sa;.05<Math.abs(e-d.ba)&&(c.Da=b+.125,d.Ba=b+.125,d.ya=d.ba,d.za=d.ka,d.Aa=d.la,d.ba=e,d.ka=c.y+d.Ta,d.la=0)}})}
function db(a,b){const c=a.stack,e=b.u.ua.kb,d=b.m,{x:h,z:g}={x:b.l.s,z:1.7};b.S.forEach(f=>{var k=f.x;const l=f.z;G(c,k,f.y,l);let m=h<k;k=Ia(g-l,h-k);m&&(c.push($a),k=Math.PI-k);H(c,k);f.o.O(a);c.pop();m&&c.pop();c.pop()});L(e,a);b.S.forEach(f=>{const k=f.z-.1875;f.oa.forEach(l=>{var m=f.x+l.Ia,t=f.y+l.Ja;let y=l.ba,v=l.ka,z=l.la;var r=l.Ba;d<r&&(r=1-(r-d)/.125,y=eb(r,l.ya,m,y),v=eb(r,l.za,t,v),z=eb(r,l.Aa,k,z));m-=y;t-=v;r=k-z;const w=Math.sqrt(m*m+t*t+r*r);G(c,y,v,z);H(c,Ia(r,m));c.push(new Float32Array([w,
0,0,0,0,t,0,0,0,0,1,0,0,0,0,1]));M(e,"wiggle",Math.abs((Math.floor(24*d)+l.Qa)%57+1-29));c.pop();c.pop();c.pop()})})}function Z(a,b,c,e,d){const h=.4*e;d=.1*d;b+=h;c+=d;return{index:a,Ia:.05*e,Ja:0,Sa:h,Ta:d,Ba:0,ya:b,za:c,Aa:0,ba:b,ka:c,la:0,Qa:0}}function eb(a,b,c,e){return a*(a*e+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};window.a=.1;function fb(a){const b=1/18/18,c=h=>Math.max(0,Math.min(255,Math.round(256*(1-b*h*h)))),e=[];for(let h=0;2>h;h++)for(let g=0;18>g;g++)for(let f=0;2>f;f++){let k;var d=void 0;let l;d=g+6*f;18>d?(k=255,d=c(d),l=255):l=d=k=0;c(g+6*f);c(g+6*f+1);for(let m=0;2>m;m++)e.push(k,d,d,l)}a=ma({name:"spark",width:72,height:2,f:a,ta:new Uint8Array(e)});return new P(a,{fading:Q({x:1/180,width:.04,height:2/180,ea:1/18,da:1,aa:18,count:18})})}function gb(a,b){return a.v?b.v?0:1:b.v?-1:a.y-b.y}
window.onload=async function(){function a(){var p=Math.sin(Math.PI*(A+0)/8)/2+Math.sin(Math.PI*(A+0)/3)/8,q=Math.sin(Math.PI*(A+170)/8)/2+Math.sin(Math.PI*(A+130)/3)/8;X=Math.asin((p-q)/100);ta=Math.cos(X);ua=Math.sin(X);va=(p+q)/2;Oa(x);p=Math.floor(48*A)-Math.floor(48*(A-B));for(q=0;q<p;q++){var C=2*Math.random()+1.4;let n=.1*Math.sin(2*Math.PI*Math.random());var u=Ka(O);if(!u)continue;const I=O.s+1*u.x,E=u.z,R=Math.PI/4*(Math.random()-.5)+u.angle;u=C*Math.sin(R);C=C*Math.cos(R)+O.i;100<N.length&&
N.pop();N.push({v:!1,x:I,y:.01,z:E,A:C,N:n,H:u,startTime:A,va:A+1.5,Ea:!1})}const F=9.8*ta*B,hb=9.8*ua*B,wa=1-.8*B;N.forEach(n=>{var I=n.v;if(!I&&A<n.va){n.x+=n.A*B;n.y+=n.N*B;n.z+=n.H*B;I=n.H;n.Ea?(n.A*=wa,n.N*=wa):(I-=F,n.A-=hb,n.H=I);if(n.x<x.L||n.x>x.M)n.v=!0;var E=n.y;if(-.5>E||.5<E){const R=0<E?.5:-.5;n.y=R+(R-E);n.N=-n.N}E=x.ma;n.z<E&&(-.01<I?(n.z=180,n.H=E,n.Ea=!0):(n.z=E-n.z,n.H=-.25*I))}else I||(n.v=!0)});N.sort(gb);cb(x)}function b(p,q,C){q.stack.push(r.$a);G(q.stack,-Math.min(Math.max(O.s,
x.L+1),x.M-1),0,-z);H(q.stack,X);G(q.stack,0,0,va);C(p,q);q.stack.pop();q.stack.pop();q.stack.pop()}function c(p,q){const C=q.stack;var u=x.U.qb;L(u,q);M(u,"main",0);u=x.U.Oa;L(u,q);M(u,"main",0);u=x.U.Ka;L(u,q);M(u,"main",0);u=x.U.hb;L(u,q);M(u,"left",0);M(u,"right",0);Pa(p,q,x);db(q,x);L(xa,q);N.forEach(F=>{F.v||(G(C,F.x,F.y,F.z),H(C,(0<=F.A?Math.PI:0)+Math.atan(F.H/F.A)),M(xa,"fading",Math.floor(12*(A-F.startTime))),C.pop(),C.pop())})}function e(p,q){p.bindFramebuffer(p.FRAMEBUFFER,null);p.viewport(0,
0,y,v);p.disable(p.BLEND);p.clearColor(0,0,0,1);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);p.activeTexture(p.TEXTURE1);ya.i.bindTexture();p.uniform1i(q.F.lighting,1);p.activeTexture(p.TEXTURE0);b(p,q,c)}function d(){{const p=(Date.now()-ib)/1E3;x.na=B=p-x.m;x.m=A=p;Y=-1===Y?60:1/B/16+.9375*Y;h.innerHTML=`fps=${Math.round(Y)}`}window.a=Math.max(0,Math.min(1,window.a+B/4*Ba(k,"lightDown","lightUp")));sa(k)%2&&(m=!m);!ia&&T(k,"fullscreen")&&(ia=g.requestFullscreen());z+=B*Ba(k,"down","up");window.cameraZ=
z;a();Ea(ya,{fb:b,pb:A,cb:N,Va:m});ha(K,e);requestAnimationFrame(d)}const h=document.getElementById("fps"),g=document.getElementById("canvas");var f=window.getComputedStyle(g);const k=new Ca(document.body);S(k,"left",["a","ArrowLeft"]);S(k,"right",["d","ArrowRight"]);S(k,"showLights",["l"]);S(k,"attack",["f"," "]);S(k,"fullscreen",["u"]);S(k,"up",["w","ArrowUp"]);S(k,"down",["s","ArrowDown"]);S(k,"lightUp",["y"]);S(k,"lightDown",["h"]);var l=parseInt(f.getPropertyValue("width"),10);f=parseInt(f.getPropertyValue("height"),
10);let m=!1;const t=window.devicePixelRatio||1,y=t*l,v=t*f;g.width=y;g.height=v;let z=1.25;const r=Ua(l,f);console.log(r);const w=g.getContext("webgl2",{antialias:!1,alpha:!1});w.enable(w.DEPTH_TEST);w.depthFunc(w.LEQUAL);l=new J({f:w,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
f=new J({f:w,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const K=new fa({f:w,K:"projection"});ea(K,l,f).link();const ya=new Ga(w,y,v,360),za=new Ya;l=(p,q)=>ka({f:w,name:p,src:q});const [jb,kb,Aa]=await Promise.all([Va(r,l),ab(l),Sa(l,p=>Xa(za,p))]),O=new Ma(Aa,2),x=Za({u:{ua:kb,l:Aa,Ma:jb},input:k,audio:za,m:0,L:0,M:12,Ga:2.5,ma:0,l:O}),xa=fb(w),N=[];let ib=Date.now(),A=0,Y=-1,B=0,ia=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(ia=null)});x.S.push(new bb(x,O.s+2,0,.75));let X,ua,ta,va;requestAnimationFrame(d);g.onmousemove=
()=>{}};
