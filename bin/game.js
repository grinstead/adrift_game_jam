'use strict';class ha{constructor(c,a,b){this.name=b;this.j=`${a}${b}`;switch(c){case "uniform":this.type=1;if("u_"!==a)throw Error(`uniform field "${this.j}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==a)throw Error(`in field "${this.j}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ia(c){const a=[];c.split("\n").forEach(b=>{(b=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(b))&&a.push(new ha(b[1],b[2],b[3]))});return a}
const v=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function w(c,a){c.a.uniformMatrix4fv(c.c,!1,a);c.b.push(a)}function x(c,a,b,d=0){var e=c.b;e=e.length?e[e.length-1]:v;w(c,new Float32Array([e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],a*e[0]+b*e[4]+d*e[8]+e[12],a*e[1]+b*e[5]+d*e[9]+e[13],a*e[2]+b*e[6]+d*e[10]+e[14],a*e[3]+b*e[7]+d*e[11]+e[15]]))}
function ja(c,a){var b=Math.cos(a);a=Math.sin(a);b=new Float32Array([b,0,a,0,0,1,0,0,-a,0,b,0,0,0,0,1]);a=c.b;0===a.length?w(c,b):(a=a[a.length-1],w(c,new Float32Array([b[0]*a[0]+b[1]*a[4]+b[2]*a[8]+b[3]*a[12],b[0]*a[1]+b[1]*a[5]+b[2]*a[9]+b[3]*a[13],b[0]*a[2]+b[1]*a[6]+b[2]*a[10]+b[3]*a[14],b[0]*a[3]+b[1]*a[7]+b[2]*a[11]+b[3]*a[15],b[4]*a[0]+b[5]*a[4]+b[6]*a[8]+b[7]*a[12],b[4]*a[1]+b[5]*a[5]+b[6]*a[9]+b[7]*a[13],b[4]*a[2]+b[5]*a[6]+b[6]*a[10]+b[7]*a[14],b[4]*a[3]+b[5]*a[7]+b[6]*a[11]+b[7]*a[15],
b[8]*a[0]+b[9]*a[4]+b[10]*a[8]+b[11]*a[12],b[8]*a[1]+b[9]*a[5]+b[10]*a[9]+b[11]*a[13],b[8]*a[2]+b[9]*a[6]+b[10]*a[10]+b[11]*a[14],b[8]*a[3]+b[9]*a[7]+b[10]*a[11]+b[11]*a[15],b[12]*a[0]+b[13]*a[4]+b[14]*a[8]+b[15]*a[12],b[12]*a[1]+b[13]*a[5]+b[14]*a[9]+b[15]*a[13],b[12]*a[2]+b[13]*a[6]+b[14]*a[10]+b[15]*a[14],b[12]*a[3]+b[13]*a[7]+b[14]*a[11]+b[15]*a[15]])))}class ka{constructor(c,a){this.a=c;this.c=a;this.b=[];c.uniformMatrix4fv(a,!1,v)}pop(){return this.b.pop()}}
class B{constructor(c,a){this.name=c.name;var b=this.a=c.a;c=this.type=c.type;switch(c){case "vertex":var d=this.a.VERTEX_SHADER;break;case "fragment":d=this.a.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${c}"`);}d=this.b=b.createShader(d);b.shaderSource(d,a);b.compileShader(d);if(!b.getShaderParameter(d,b.COMPILE_STATUS))throw a=`Failed to compile ${this.name} ${c}-shader: ${b.getShaderInfoLog(d)}`,b.deleteShader(d),Error(a);this.J=ia(a)}}
function la(c,...a){const b=c.a,d=c.B;a.forEach(e=>{c.F.push(e);b.attachShader(d,e.b)});return c}function C(c,a){c.h.includes(a)||c.h.push(a);requestAnimationFrame(c.N)}
class ma{constructor(c){this.name=c.name;this.C=c.C;c=this.a=c.a;this.G=!1;this.B=c.createProgram();this.F=[];this.c={};this.b={};this.stack=null;this.h=[];this.N=()=>{var a=this.a,b=this.B;a.useProgram(b);for(var d={},e={},k=this.F,g=0;g<k.length;g++)for(var f=k[g].J,q=0;q<f.length;q++){var l=f[q];1===l.type?l.j in d||(d[l.name]=a.getUniformLocation(b,l.j)):l.j in e||(e[l.name]=a.getAttribLocation(b,l.j))}this.c=d;this.b=e;if(b=this.C)if(b in this.c)this.stack=new ka(a,this.c[b]);else throw Error(`No anchor point "${b}" in program`);
try{var m=this.h;this.h=[];for(g=0;g<m.length;m++)m[g](a,this)}finally{this.c={},this.b={},this.stack=null}}}link(){if(this.G)return this;var c=this.a,a=this.B;c.linkProgram(a);if(!c.getProgramParameter(a,c.LINK_STATUS)){var b=`Failed to link ${this.name} program: ${c.getProgramInfoLog(a)}`;c.deleteProgram(a);throw Error(b);}this.G=!0;return this}}
class F{constructor(c,a,b,d,e){this.a=c;this.name=a;this.w=b;this.f=d;a=this.b=c.createTexture();c.bindTexture(c.TEXTURE_2D,a);e(c);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST);c.bindTexture(c.TEXTURE_2D,null)}bindTexture(){this.a.bindTexture(this.a.TEXTURE_2D,this.b)}}
function G(c){return(new Promise((a,b)=>{const d=new Image;d.onload=()=>void a(d);d.onerror=()=>{b(Error(`failed to load ${c.src}`))};d.mode="no-cors";d.src=c.src})).then(a=>{const b=a.naturalWidth,d=a.naturalHeight;return new F(c.a,c.name,b,d,e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,b,d,0,e.RGBA,e.UNSIGNED_BYTE,a)})})}function na(c){const a=c.width,b=c.height;return new F(c.a,c.name,a,b,d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a,b,0,d.RGBA,d.UNSIGNED_BYTE,c.L,0)})};function M(c,a){const b=c.b.a;let d=c.c;null!=d?b.bindBuffer(b.ARRAY_BUFFER,d):(c.c=d=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,d),b.bufferData(b.ARRAY_BUFFER,c.h,b.STATIC_DRAW));b.activeTexture(b.TEXTURE0);c.b.bindTexture();b.uniform1i(a.c.texture,0);b.enableVertexAttribArray(a.b.texturePosition);b.vertexAttribPointer(a.b.texturePosition,2,b.FLOAT,!1,20,12);b.enableVertexAttribArray(a.b.position);b.vertexAttribPointer(a.b.position,3,b.FLOAT,!1,20,0)}
function N(c,a,b){if(!c.data.hasOwnProperty(a))throw Error(`Can not render unknown "${a}"`);a=c.data[a];c=c.b.a;const d=a.K;c.drawArrays(c.TRIANGLE_STRIP,d[b%d.length],a.O)}
class O{constructor(c,a){this.b=c;this.c=null;c=this.data={};const b=[];let d=0;for(const e in a){const k=a[e],g=[],f=k.length;if(0===f)throw Error("Sprite declared with 0 points");const q=k[0].length;if(0==q)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const l=q/5;for(let m=0;m<f;m++){const t=k[m];if(t.length!==q)throw Error("Sprite declared with inconsistent lengths of elements");g.push(d);b.push.apply(b,t);d+=l}c[e]={U:this,name:e,K:g,O:l}}this.h=new Float32Array(b)}}
;function P(c,a,b){c=c.c;null!=b?c.set(a,b):c.delete(a)}function Q(c,a){a=c.c.get(a);const b=c.b;return!!a&&a.some(d=>b.get(d))}function oa(c){const a=Q(c,"left")?1:0;return(Q(c,"right")?1:0)-a}class pa{constructor(c){this.b=new Map;this.c=new Map;c.addEventListener("keydown",a=>{R(this,a,!0)});c.addEventListener("keyup",a=>{R(this,a,!1)});c.onblur=()=>{this.b.clear()};c.onfocus=()=>{this.b.clear()}}}
function R(c,a,b){a=a.key;c=c.b;const d=c.get(a);b?null==d&&c.set(a,Date.now()):null!=d&&c.delete(a)};function qa(){const c=new Uint8Array(4096),a=(e,k)=>{e/=360;k/=360;return e*e+k*k},b=Math.min(a(16,0),a(16,0));for(let e=0;32>e;e++)for(let k=0;32>k;k++){const g=4*(32*e+k),f=a(k-16,e-16);if(1E-4>=f)c[g]=255,c[g+1]=255,c[g+2]=255,c[g+3]=255;else{var d=Math.sqrt(1E-4/f);const q=Math.floor(256*d);d=Math.floor(256*d*d);c[g]=255;c[g+1]=d;c[g+2]=d;c[g+3]=f>=b?0:q}}return c}
function S({u:c=0,V:a=0,W:b=0,s:d,m:e,o:k,g,count:f,l:q=!1}){const l=d/360,m=e/360;return T({x:c*l,y:a,z:b*m,width:l,height:m,I:d/k.w,H:e/k.f,g,count:f,l:q})}function T({x:c=0,y:a=0,z:b=0,width:d,height:e,I:k,H:g,g:f,count:q,l=!1}){const m=[];for(let t=0;t<q;t++){const y=Math.floor(t/f),z=t%f;m.push(ra({x:c,y:a,z:b,width:d,height:e,S:z*k,P:(z+1)*k,T:y*g,R:(y+1)*g,l}))}return m}
function ra({x:c=0,y:a=0,z:b=0,width:d,height:e,S:k,T:g,P:f,R:q,l=!1}){l?l=f:(l=k,k=f);return[d-c,a,-b,k,q,-c,a,-b,l,q,d-c,a,e-b,k,g,-c,a,e-b,l,g]}
window.onload=async function(){function c(r,n){r=Date.now();const u=(r-U)/1E3;U=r;a.innerHTML=`fps=${Math.round(1/u)}`;w(n.stack,sa);r=(r-ta)/1E3;const V=Math.sin(Math.PI*(A+0)/8)/2+Math.sin(Math.PI*(A+0)/3)/8,W=Math.sin(Math.PI*(A+170)/8)/2+Math.sin(Math.PI*(A+130)/3)/8,J=Math.asin((V-W)/100),ua=Math.cos(J),va=Math.sin(J);D=1.2*u*oa(e);0!==D&&(K+=D,H=0>D);const wa=Math.floor(10*r)-Math.floor(10*A);for(let h=0;h<wa;h++){var I=(Math.random()-.5)*Math.PI/4+Math.PI/2;const X=2*Math.random()+1,ya=K+(282/
360-xa/2)*(H?-1:1),za=326/360,Aa=X*Math.sin(I);I=X*Math.cos(I);100<E.length&&E.shift();E.push({v:!1,x:ya,y:0,z:za,A:I,M:.1*Math.sin(2*Math.PI*Math.random()),i:Aa})}E.forEach(h=>{h.v||(h.i-=9.8*ua*u,h.A-=9.8*va*u,h.x+=h.A*u,h.y+=h.M*u,h.z+=h.i*u,0>h.z?(h.z=-h.z,h.i*=-.25):.01>h.z&&.1>Math.abs(h.i)&&(h.v=!0))});A=r;x(n.stack,-1.5,0,p.d/2+p.f+.5);ja(n.stack,J);x(n.stack,0,0,(V+W)/2);M(Y,n);N(Y,"main",0);M(Z,n);N(Z,"main",0);x(n.stack,K,0,0);0===D?(M(aa,n),N(aa,H?"left":"right",Math.floor(12*r))):(M(ba,
n),N(ba,H?"left":"right",Math.floor(8*r)));n.stack.pop();M(ca,n);E.forEach(h=>{h.v||(x(n.stack,h.x,h.y,h.z),N(ca,"main",0),n.stack.pop())});n.stack.pop();n.stack.pop();n.stack.pop();x(n.stack,da/180,0,(g-ea)/180);r=Math.floor(8*r)%38;M(fa,n);N(fa,"blink",6>r?r:0);C(n,c)}const a=document.getElementById("fps"),b=document.getElementById("canvas");var d=window.getComputedStyle(b);const e=new pa(document.body);P(e,"left",["a","ArrowLeft"]);P(e,"right",["d","ArrowRight"]);let k=parseInt(d.getPropertyValue("width"),
10),g=parseInt(d.getPropertyValue("height"),10);d=window.devicePixelRatio||1;b.width=d*k;b.height=d*g;var f=b.getContext("webgl2",{antialias:!1,alpha:!1});f.enable(f.BLEND);f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA);f.enable(f.DEPTH_TEST);f.depthFunc(f.LEQUAL);const q=new B({a:f,type:"vertex"},"#version 300 es\n\n    in vec3 a_position;\n    in vec2 a_texturePosition;\n\n    uniform mat4 u_projection;\n\n    out vec2 v_texturePosition;\n\n    void main() {\n        vec4 position = u_projection * vec4(a_position, 1);\n        float variance = 1.f / (position.z + 1.f);\n\n        vec4 result = vec4(position.x, position.y * variance, -.5f * (position.z - 1.f) * variance, position.w * variance);\n        gl_Position = result;\n\n        v_texturePosition = a_texturePosition;\n    }\n"),
l=new B({a:f,type:"fragment"},"#version 300 es\n    precision mediump float;\n\n    uniform sampler2D u_texture;\n\n    in vec2 v_texturePosition;\n    out vec4 output_color;\n\n    void main() {\n        vec4 color = texture(u_texture, v_texturePosition.st);\n        if (color.a == 0.0) {\n            discard;\n        }\n        output_color = color;\n    }\n");d=new ma({a:f,C:"projection"});la(d,q,l).link();const [m,t,y,z,L]=await Promise.all([G({a:f,src:"assets/Back Wall.png",name:"wall"}),G({a:f,
src:"assets/Floor 2.png",name:"floor"}),G({a:f,src:"assets/Hero Breathing.png",name:"idle"}),G({a:f,src:"assets/Enemy.png",name:"enemy"}),G({a:f,src:"assets/Hero Walking 2.png",name:"walk"})]),p={w:t.w/360,f:34/360,d:175/360,D:175/209},Y=new O(m,{main:[[m.w/360,-p.d/2,m.f/360,1,0,m.w/360,-p.d/2,0,1,1,0,-p.d/2,m.f/360,0,0,0,-p.d/2,0,0,1]]}),Z=new O(t,{main:[[p.w,p.d/2,-p.f,1,1,0,p.d/2,-p.f,0,1,p.w,p.d/2,0,1,p.D,0,p.d/2,0,0,p.D,p.w,-p.d/2,0,1,0,0,-p.d/2,0,0,0]]}),xa=296/360,aa=new O(y,{right:S({u:.5,
s:296,m:434,o:y,g:6,count:16}),left:S({u:.5,s:296,m:434,o:y,g:6,count:16,l:!0})}),ba=new O(L,{right:S({u:.5,s:322,m:442,o:L,g:3,count:8}),left:S({u:.5,s:322,m:442,o:L,g:3,count:8,l:!0})});f=na({name:"fade",width:32,height:32,a:f,L:qa()});const fa=new O(z,{blink:T({x:.15,width:.3,height:.3,I:108/z.w,H:108/z.f,g:2,count:6})}),ca=new O(f,{main:[[16/360,0,-16/360,1,0,16/360,0,16/360,1,1,-16/360,0,-16/360,0,0,-16/360,0,16/360,0,1]]});let da=0,ea=0;const sa=new Float32Array([360/k,0,0,0,0,-360/g,.25,0,
0,360/g,0,0,-1,-1,0,1]),E=[];let ta=Date.now(),U=Date.now(),A=0,K=4,D=0,H=!1;C(d,c);b.onmousemove=r=>{da=r.offsetX;ea=r.offsetY}};
