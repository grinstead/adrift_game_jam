'use strict';class aa{constructor(a,b,c){this.name=c;this.V=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.V}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.V}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ba(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new aa(c[1],c[2],c[3]))});return b}
const da=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function A(a,b){a.h.uniformMatrix4fv(a.i,!1,b);a.g.push(b)}function C(a,b,c,e=0){var d=a.g;d=d.length?d[d.length-1]:da;A(a,new Float32Array([d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],b*d[0]+c*d[4]+e*d[8]+d[12],b*d[1]+c*d[5]+e*d[9]+d[13],b*d[2]+c*d[6]+e*d[10]+d[14],b*d[3]+c*d[7]+e*d[11]+d[15]]))}function D(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class ea{constructor(a,b){this.h=a;this.i=b;this.g=[];a.uniformMatrix4fv(b,!1,da)}depth(){return this.g.length}pop(){return this.g.pop()}push(a){var b=this.g;0===b.length?A(this,a):(b=b[b.length-1],A(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+
a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class E{constructor(a,b){this.name=a.name;var c=this.h=a.h;a=this.type=a.type;switch(a){case "vertex":var e=this.h.VERTEX_SHADER;break;case "fragment":e=this.h.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}e=this.g=c.createShader(e);c.shaderSource(e,b);c.compileShader(e);if(!c.getShaderParameter(e,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(e)}`,c.deleteShader(e),Error(b);this.cb=ba(b)}}
function fa(a,...b){const c=a.h,e=a.ya;b.forEach(d=>{a.Ka.push(d);c.attachShader(e,d.g)});return a}class ha{constructor(a){this.name=a.name;this.O=a.O;a=this.h=a.h;this.g=!1;this.ya=a.createProgram();this.Ka=[];this.L={};this.S={};this.stack=null}link(){if(this.g)return this;var a=this.h,b=this.ya;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.g=!0;return this}}
function ia(a,b){var c=a.h,e=a.ya;c.useProgram(e);for(var d={},h={},g=a.Ka,f=0;f<g.length;f++)for(var k=g[f].cb,m=0;m<k.length;m++){var n=k[m];1===n.type?n.V in d||(d[n.name]=c.getUniformLocation(e,n.V)):n.V in h||(h[n.name]=c.getAttribLocation(e,n.V))}a.L=d;a.S=h;if(e=a.O)if(e in a.L)a.stack=new ea(c,a.L[e]);else throw Error(`No anchor point "${e}" in program`);try{b(c,a)}finally{a.L={},a.S={},a.stack=null}}
class F{constructor(a,b,c,e,d){this.h=a;this.name=b;this.w=c;this.l=e;this.g=d(a)}bindTexture(){this.h.bindTexture(this.h.TEXTURE_2D,this.g)}}function ja(a){return(new Promise((b,c)=>{const e=new Image;e.onload=()=>void b(e);e.onerror=()=>{c(Error(`failed to load ${a.src}`))};e.mode="no-cors";e.src=a.src})).then(b=>{const c=b.naturalWidth,e=b.naturalHeight;return new F(a.h,a.name,c,e,ka(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,e,0,d.RGBA,d.UNSIGNED_BYTE,b)}))})}
function I(a){const b=a.width,c=a.height;return new F(a.h,a.name,b,c,ka(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,b,c,0,e.RGBA,e.UNSIGNED_BYTE,a.Aa,0)}))}function la(a){return new F(a.h,a.name,a.width,a.height,()=>a.R)}
function ka(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function J(a,b,c){a=a.i;null!=c?a.set(b,c):a.delete(b)}function L(a,b){b=a.i.get(b);const c=a.g;return!!b&&!!b.some(e=>(e=c.get(e))?(e.ia=0,null!=e.ma):!1)}function ma(a){const b=a.i.get("showLights");if(b){const c=a.g;return b.reduce((e,d)=>(d=c.get(d))?(e+=d.ia,d.ia=0,e):e,0)}return 0}class na{constructor(a){this.g=new Map;this.i=new Map;a.addEventListener("keydown",b=>{oa(this,b,!0)});a.addEventListener("keyup",b=>{oa(this,b,!1)});a.onblur=()=>{this.g.clear()};a.onfocus=()=>{this.g.clear()}}}
function oa(a,b,c){b=b.key;a=a.g;const e=a.get(b);c?null==e?a.set(b,{ma:Date.now(),ia:1}):(null==e.ma&&(e.ma=Date.now()),e.ia++):null!=e&&(e.ma=null)};function N(a,b){const c=a.g.h;let e=a.i;null!=e?c.bindBuffer(c.ARRAY_BUFFER,e):(a.i=e=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,e),c.bufferData(c.ARRAY_BUFFER,a.I,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.g.bindTexture();c.uniform1i(b.L.texture,0);c.enableVertexAttribArray(b.S.texturePosition);c.vertexAttribPointer(b.S.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.S.position);c.vertexAttribPointer(b.S.position,3,c.FLOAT,!1,20,0)}
function O(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.g.h;const e=b.za;a.drawArrays(a.TRIANGLE_STRIP,e[c%e.length],b.xb)}
class P{constructor(a,b){this.g=a;this.i=null;a=this.data={};const c=[];let e=0;for(const d in b){const h=b[d],g=[],f=h.length;if(0===f)throw Error("Sprite declared with 0 points");const k=h[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const m=k/5;for(let n=0;n<f;n++){const r=h[n];if(r.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");g.push(e);c.push.apply(c,r);e+=m}a[d]={Hb:this,name:d,za:g,xb:m}}this.I=new Float32Array(c)}}
function pa(a,b){for(var c=a.F;-1!==c&&c<=b;){c=a.I;const e=a.M+1;e===c.length?a.i===a.qb?a.F=c=-1:(a.i++,a.M=0,a.F=c=b+c[0]):(a.M=e,a.F=c=b+c[e])}}class qa{constructor(a,b,c,e){const d=a.B;this.oa=a.name;this.la=a.qa;this.g=c;this.qb="number"===typeof d?d:d?-1:0;this.Pa=a.set;this.I=b;this.M=this.i=0;this.F=e+b[0];this.ob=a.yb}ka(){const a=this.ob;return null!=a?a[this.M]:void 0}ba(a){N(this.Pa,a);O(this.Pa,this.g,this.M)}name(){return this.oa}toString(){return`Sprite/${this.oa}`}}
function Q(a){const b=a.name,c=a.A,e=a.set.data;let d=-1;a.qa.forEach(g=>{const f=e[g];if(!f)throw Error(`Sprite/${b} has non-existent mode ${g}`);if(-1===d)d=f.za.length;else if(d!==f.za.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===d)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==d)throw Error(`Sprite/${b} given ${c.length} frame times for ${d} frames`);if(a.ka&&a.ka.length!==d)throw Error(`Sprite/${b} given ${a.ka.length} frame data points for ${d} frames`);
const h="number"===typeof c?Array(d).fill(c):c;return(g,f)=>new qa(a,h,g,f)}function R({x:a=0,y:b=0,z:c=0,width:e,height:d,xa:h,wa:g,ra:f,count:k,Nb:m=0,Ob:n=0,Pb:r=h,Mb:l=g,ca:p=!1}){const w=[];for(let u=0;u<k;u++){const B=m+u%f*r,H=n+Math.floor(u/f)*l;w.push(va({x:a,y:b,z:c,width:e,height:d,ab:B,Za:B+h,bb:H,$a:H+g,ca:p}))}return w}
function va({x:a=0,y:b=0,z:c=0,width:e,height:d,depth:h=0,ab:g,bb:f,Za:k,$a:m,ca:n=!1}){n?(n=k,k=a-e):(n=g,g=k,k=-a,a=e-a);return[a,-b,-c,g,m,k,-b,-c,n,m,a,h-b,d-c,g,f,k,h-b,d-c,n,f]};function S(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const wa=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function xa(a){const [b,c,e]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png")]);var d=new P(b,{blink:R({x:.25,z:.25,width:.5,height:.5,xa:108/b.w,wa:108/b.l,ra:2,count:6,ca:!0})});a=Q({name:"creature_attack",set:new P(e,{bite:R({x:.5,z:.75,width:1,height:2,wa:530/e.l,xa:278/e.w,ra:7,count:42,ca:!0})}),qa:["bite"],B:!0,A:1/12});var h=Array(6).fill(.125);h[0]=4;d=Q({name:"creature_normal",set:d,qa:["blink"],B:!0,
A:h});h=[];var g=92,f=-22;const k=Math.sqrt(g*g+f*f);g/=k;f/=k;for(let m=0;29>m;m++){const n=m%5,r=Math.floor(m/5),l=[],p=(w,u)=>{const B=100*w,H=77*u-48;l.push((B*g+H*f)/k,w,(B*-f+H*g)/360,100*(n+w)/c.w,77*(r+u)/c.l)};p(1,1);p(0,1);p(1,0);p(0,0);h.push(l)}h=new P(c,{wiggle:h});return{tb:d,Ib:a,Eb:h}}
class ya{constructor(a,b,c,e){const d=a.o.Ma.tb("blink",a.j),h=a.u;this.x=this.I=b;this.y=c;this.z=e;this.g=this.i=0;this.Ja=[V(0,b,c,-1,1,h),V(1,b,c,-1,-1,h),V(2,b,c,1,1,h),V(3,b,c,1,-1,h)];this.v=d;this.state=za(this,a)}G(a,b){const c=this.state.Ea;c&&c();this.state=b=b(this,a);b.C(a)}P(a,b,c){this.v=a(c,b)}}
function za(a,b){return{name:"creature_normal",C:()=>{var c=b.j;a.x=a.I+Math.sin(c);var e=.5*Math.cos(c);c=b.j;if(c>a.i){var d=a.g;a.g=(d+1)%a.Ja.length;d=a.Ja[d];e=a.x+.225*e+d.mb;.05<Math.abs(e-d.sa)&&(a.i=c+.125,d.Ua=c+.125,d.Ra=d.sa,d.Sa=d.Fa,d.Ta=d.Ga,d.sa=e,d.Fa=a.y+d.nb,d.Ga=b.u)}},ta:(c,e,d)=>{c=e.stack;const h=a.x,g=a.z;C(c,h,a.y,g);let f=d.x<h;d=S(d.z-g,d.x-h);f&&(c.push(wa),d=Math.PI-d);D(c,d);a.v.ba(e);c.pop();f&&c.pop();c.pop()}}}
function Aa(a){const b=a.j;a.X.forEach(c=>{pa(c.v,b);c.state.C(a)})}
function Ba(a,b,c){const e=b.stack,d=c.o.Ma.Eb,h=c.j,g=Ca(c.m);c.X.forEach(f=>{f.state.ta(a,b,g)});N(d,b);c.X.forEach(f=>{const k=f.z-.1875;f.Ja.forEach(m=>{var n=f.x+m.eb,r=f.y+m.fb;let l=m.sa,p=m.Fa,w=m.Ga;var u=m.Ua;h<u&&(u=1-(u-h)/.125,l=Da(u,m.Ra,n,l),p=Da(u,m.Sa,r,p),w=Da(u,m.Ta,k,w));n-=l;r-=p;u=k-w;const B=Math.sqrt(n*n+r*r+u*u);C(e,l,p,w);D(e,S(u,n));e.push(new Float32Array([B,0,0,0,0,r,0,0,0,0,1,0,0,0,0,1]));O(d,"wiggle",Math.abs((Math.floor(24*Date.now()/1E3)+m.kb)%57+1-29));e.pop();e.pop();
e.pop()})})}function V(a,b,c,e,d,h){const g=.4*e;d=.1*d;b+=g;c+=d;return{index:a,eb:.05*e,fb:0,mb:g,nb:d,Ua:0,Ra:b,Sa:c,Ta:h,sa:b,Fa:c,Ga:h,kb:0}}function Da(a,b,c,e){return a*(a*e+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};const Ea=434/1.8,W=405/Ea;function Ca(a){return{x:a.s,z:a.aa+1.8-.1}}function Fa(a){return(a=a.v.ka())?a.Oa:null}function X(a,b){a.Ya=b;0!==b&&(a.ua=Math.sign(b))}
class Ga{constructor(a,b,c){this.s=b;this.na=0;this.aa=c;this.ua=1;this.Ya=0;this.v=a.Da("right",0);this.state={name:"unstarted",C:e=>this.G(e,Y),ta:()=>{throw Error("Hero did not get processed before rendering!");}}}P(a,b,c=-1===this.ua?"left":"right"){this.v=a(c,b)}ba(a,b){a=b.stack;C(a,this.s,this.na,this.aa);this.v.ba(b);a.pop()}G(a,b){const c=this.state.Ea;c&&c();this.state=b=b(this,a);b.C(a)}}
function Y(a,b){let c=!0;a.P(b.o.m.Da,b.j);return{name:"normal",C:e=>{const d=e.m,h=e.j;var g=e.input;if("r0"===e.name&&L(g,"up"))d.G(e,Ha);else if(L(g,"attack"))d.G(e,Ia);else{var f=1.2*e.va;{const k=L(g,"left")?1:0;g=(L(g,"right")?1:0)-k}f*=g;g=d.s+f;g<e.D+W?f=e.D+W-d.s:g>e.K-W&&(f=e.K-W-d.s);X(d,f/e.va);g=-1===d.ua?"left":"right";f?(d.s+=f,c&&(c=!1,d.P(e.o.m.vb,h))):c||(c=!0,d.P(e.o.m.Da,h));e=d.v;if(g!==e.g){if(!e.la.includes(g))throw Error(`${e} does not have mode ${g}`);e.g=g}}}}}
function Ia(a,b){a.P(b.o.m.rb,b.j);X(a,0);const c=b.o.m.lb;Ja(b.audio,a,c[Math.floor(Math.random()*c.length)]);return{name:"attacking",C:e=>{-1===a.v.F&&a.G(e,Y)}}}function Ha(a,b){a.P(b.o.m.sb,b.j,"up");X(a,0);a.na=.75;b.transition={Ha:"r1",Qb:"up",Wa:Date.now()/1E3,Xa:1};return{name:"climbing",C:c=>{-1===a.v.F?a.G(c,Y):a.aa=c.u+.3*Math.min(5,a.v.M)},Ea:()=>{a.na=0;a.aa=b.u}}}
function Ka(a,b){const c=b.j;a.P(b.o.m.ub,b.j,"exit");X(a,0);b.Ca++;return{name:"entering_hatch",C:()=>{const e=a.v;if(b.j<c+1){var d=b.j;if(!e.la.includes("exit"))throw Error(`${e} does not have mode ${"exit"}`);e.i=0;e.g="exit";e.M=0;e.F=d+e.I[0]}else-1===e.F&&a.G(b,Y)},ta:(e,d)=>{b.j<c+1||a.ba(e,d)},Ea:()=>{b.Ca--}}}
async function La(a,b){const [c,e,d,h,g,f]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),a("hero_climbing","assets/Climbing Up.png"),a("hero_hatch","assets/climbing_in.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")])]);a={name:"hero_hatch_enter",R:g,ea:350,$:406,fa:161,ga:479,Z:6,B:!1,A:.125,U:[{c:201,f:137,a:172,b:175},{c:422,f:246,a:461,b:259},
{c:67,f:659,a:113,b:651},{c:419,f:658,a:462,b:648},{c:80,f:1041,a:106,b:1067},null],da:"enter"};return{lb:f,Da:Z({name:"hero_idle",R:c,ea:405,$:434,fa:220,ga:434,Z:16,B:!0,A:1/12,U:[{c:388,f:104,a:385,b:170},{c:792,f:105,a:790,b:170},{c:1198,f:105,a:1195,b:169},{c:1602,f:106,a:1600,b:170},{c:2008,f:106,a:2005,b:172},{c:388,f:539,a:385,b:604},{c:794,f:540,a:790,b:605},{c:1196,f:539,a:1196,b:604},{c:1602,f:539,a:1602,b:604},{c:2009,f:541,a:2007,b:604},{c:386,f:974,a:385,b:1036},{c:792,f:972,a:790,b:1033},
{c:1198,f:974,a:1196,b:1038},{c:1602,f:972,a:1601,b:1036},{c:2010,f:974,a:2005,b:1044},{c:386,f:1406,a:385,b:1477}]}),vb:Z({name:"hero_walk",R:e,ea:424,$:444,fa:258,ga:444,Z:8,B:!0,A:.125,U:[{c:408,f:110,a:404,b:166},{c:830,f:110,a:829,b:166},{c:408,f:554,a:404,b:614},{c:830,f:554,a:829,b:614},{c:408,f:998,a:404,b:1055},{c:830,f:998,a:829,b:1055},{c:408,f:1444,a:404,b:1500},{c:830,f:1444,a:829,b:1500}]}),rb:Z({name:"hero_attack",R:d,ea:644,$:565,fa:284,ga:565,Z:5,B:!1,A:1/12,U:[{c:422,f:285,a:415,
b:353},{c:936,f:367,a:868,b:380},{c:1507,f:311,a:1469,b:318},{c:162,f:948,a:206,b:943},{c:1025,f:934,a:976,b:962}]}),sb:Z({name:"hero_climbing_up",R:h,ea:222,$:412,fa:110,ga:412,Z:8,B:!1,A:.125,U:[{c:128,f:60,a:65,b:54},{c:329,f:155,a:277,b:148},{c:579,f:58,a:518,b:56},{c:772,f:157,a:721,b:156},{c:95,f:575,a:65,b:567},{c:337,f:472,a:286,b:465},null,null],da:"up",scale:1.4}),Jb:Z(a),ub:Z({...a,name:"hero_hatch_exit",da:"exit",zb:!0})}}
function Z(a){var b=a.R;const c=a.ea,e=a.$,d=a.fa,h=a.ga,g=a.zb?l=>[...l].reverse():l=>l,f=Ea/(a.scale||1),k=Math.floor(b.w/c),m={x:d/f,z:(e-h)/f,width:c/f,height:e/f,xa:c/b.w,wa:e/b.l,ra:k,count:a.Z},n=a.U&&a.U.map((l,p)=>{if(!l)return{Oa:null};const w=l.c,u=l.f;return{Oa:{x:(w-(p%k*c+d))/f,z:(Math.floor(p/k)*e+h-u)/f,angle:S(-(u-l.b),w-l.a)}}});let r;a.da?(r=[a.da],b=new P(b,{[a.da]:g(R(m))})):(r=["left","right"],b=new P(b,{right:g(R(m)),left:g(R({...m,ca:!0}))}));return Q({name:a.name,set:b,qa:r,
B:a.B,A:a.A,yb:n&&g(n)})};function Ma(a,b){var c=376/b;const e=c/(484/b),d=c/(268/b);c/=1.25;a=b/a*c;return{wb:new Float32Array([a,0,0,0,0,0,1/1.5,(d-e)/1.5,0,c,0,0,0,0,0,(e+d)/2]),Sb:e,Rb:d,Kb:a,Lb:c,W:554/b*e/c-1.25,J:.3}}
async function Na(a,b){const [c,e,d,h,g]=await Promise.all([b("ladder","assets/ladder.png"),b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png")]);b=2.5*c.w/c.l;b=new P(c,{main:[va({x:b/2,y:-.75,width:b,height:2.5,ab:0,bb:.5,Za:1,$a:1})]});return{O:a,Gb:e,jb:d,hb:h,Cb:g,pb:b}}
function Oa({Gb:a,jb:b,hb:c,Cb:e,O:d},h,g){const f=g-d.J;g=g+h+d.J;var k=494/a.l,m=1016/a.l,n=(m-k)*a.l/2.5*h/a.w;a=new P(a,{main:[[g,.75,2.5,n,k,g,.75,0,n,m,f,.75,2.5,0,k,f,.75,0,0,m]]});k=110/b.l;m=220/b.l;n=(m-k)*b.l/1.5*h/b.w;b=new P(b,{main:[[g,-.75,-d.W,n,1,f,-.75,-d.W,0,1,g,-.75,0,n,m,f,-.75,0,0,m,g,.75,0,n,k,f,.75,0,0,k]]});k=144/c.l;m=32/c.l;h=(m-k)*c.l/1.5*h/c.w;c=new P(c,{main:[[g,-.75,2.5+d.W,h,0,f,-.75,2.5+d.W,0,0,g,-.75,2.5,h,m,f,-.75,2.5,0,m,g,.75,2.5,h,k,f,.75,2.5,0,k]]});h=438/e.w;
k=318/e.w;m=194/e.l;n=1164/e.l;const r=84/e.w;d=[f,-.75,2.5,h,m,f,-.75,0,h,n,f+d.J,-.75,2.5,k,m,f+d.J,-.75,0,k,n,f+d.J,.75,2.5,r,414/e.l,f+d.J,.75,0,r,964/e.l];h=[];for(k=0;k<d.length;k+=5)h.push(g+(f-d[k]),d[k+1],d[k+2],d[k+3],d[k+4]);e=new P(e,{right:[h],left:[d]});return{Fb:a,ib:b,gb:c,Bb:e}};function Ja(a,b,c){const e=a.i;var d=e.get(b);d&&d.stop();a=a.g;d=a.createBufferSource();d.buffer=c;d.connect(a.destination);d.start();e.set(b,d)}function Pa(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.g.decodeAudioData(c))}class Qa{constructor(){this.g=new AudioContext;this.i=new WeakMap}};function Ra(a){const b=a.j,c=a.va,e=a.m,d=a.Ia,h=Math.floor(48*b)-Math.floor(48*(b-c));for(let l=0;l<h;l++){var g=2*Math.random()+1.4;let p=.1*Math.sin(2*Math.PI*Math.random());var f=Fa(e);if(!f)break;const w=e.s+f.x*e.ua,u=f.z+e.aa,B=Math.PI/4*(Math.random()-.5)+f.angle;f=g*Math.sin(B);g=g*Math.cos(B)+e.Ya;100<d.length&&d.pop();d.push({H:!1,x:w,y:e.na+.01,z:u,N:g,Y:p,T:f,startTime:b,Na:b+1.5,Va:!1})}const k=a.u,m=9.8*c,n=0*c,r=1-.8*c;d.forEach(l=>{var p=l.H;if(!p&&b<l.Na){l.x+=l.N*c;l.y+=l.Y*c;l.z+=
l.T*c;p=l.T;l.Va?(l.N*=r,l.Y*=r):(p-=m,l.N-=n,l.T=p);if(l.x<a.D||l.x>a.K)l.H=!0;const w=l.y;if(-.75>w||.75<w){const u=0<w?.75:-.75;l.y=u+(u-w);l.Y=-l.Y}l.z<k&&(-.01<p?(l.z=k,l.T=0,l.Va=!0):(l.z=k+k-l.z,l.T=-.25*p))}else p||(l.H=!0)});d.sort(Sa)}
function Ta(a){const b=1/18/18,c=h=>Math.max(0,Math.min(255,Math.round(256*(1-b*h*h)))),e=[];for(let h=0;2>h;h++)for(let g=0;18>g;g++)for(let f=0;2>f;f++){let k;var d=void 0;let m;d=g+6*f;18>d?(k=255,d=c(d),m=255):m=d=k=0;c(g+6*f);c(g+6*f+1);for(let n=0;2>n;n++)e.push(k,d,d,m)}a=I({name:"spark",width:72,height:2,h:a,Aa:new Uint8Array(e)});return new P(a,{fading:R({x:1/180,width:.04,height:2/180,xa:1/18,wa:1,ra:18,count:18})})}function Sa(a,b){return a.H?b.H?0:1:b.H?-1:a.y-b.y}
function Ua(a,b){const c=b.o.Db,e=a.stack;N(c,a);b.Ia.forEach(d=>{d.H||(C(e,d.x,d.y,d.z),D(e,(0<=d.N?Math.PI:0)+Math.atan(d.T/d.N)),O(c,"fading",Math.floor(12*(b.j-d.startTime))),e.pop(),e.pop())})};function Va(a){const b=a.D,c=a.K,e=a.u,d=a.pa;return{name:a.name,o:d.o,input:d.input,audio:d.audio,X:[],j:0,Ab:Date.now()/1E3-1/60,va:0,D:b,K:c,u:e,ja:Oa(d.o.Ba,c-b,b),Ia:[],Qa:!1,m:new Ga(d.o.m,(c+b)/2,e),transition:null,Ca:0,La:0}};function Wa(a,b,c){const e=a.g.h,d=a.i;e.bindFramebuffer(e.FRAMEBUFFER,a.la);e.viewport(0,0,d.w,d.l);ia(a.g,(h,g)=>{Xa(h,g,b,a,c)})}
class Ya{constructor(a,b,c,e){b/=4;c/=4;var d=new E({h:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  gl_Position = u_projection * vec4(a_position, 1);\n  v_texturePosition = a_texturePosition;\n}"),h=new E({h:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\nuniform vec4 u_color;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    \n    if (u_threshold != -1.f) {\n      color.a -= u_threshold;\n      if (color.a <= u_threshold) {\n          discard;\n      }\n      output_color = color;\n    } else {\n      if (color.a == 0.f) {\n        discard;\n      }\n      output_color = u_color;\n    }\n}");const g=
new ha({h:a,O:"projection"});fa(g,d,h).link();d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);h=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,h);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.bindFramebuffer(a.FRAMEBUFFER,
null);const f=128/e;e=I({name:"fade",width:64,height:64,h:a,Aa:Za(e)});this.g=g;this.i=la({R:d,name:"lighting",width:b,height:c,h:a});this.la=h;this.I=new P(e,{main:[[f,0,-f,1,0,f,0,f,1,1,-f,0,-f,0,0,-f,0,f,0,1]]});a=I({name:"solid",width:1,height:1,h:a,Aa:new Uint8Array([255,255,255,255])});this.oa=new P(a,{main:[[0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0]]})}}
function Xa(a,b,c,e,d){a.blendFunc(a.ONE,a.ONE);a.clearColor(0,0,0,0);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const h=b.L.threshold,g=b.L.color;a.uniform1f(h,-1);const f=b.stack;c(f,()=>{const k=e.oa;N(k,b);d.forEach(n=>{a.uniform4f(g,0,0,0,window.Qa?1:n.La);const r=n.o.Ba.O,l=n.D-r.J;f.push(new Float32Array([n.K+r.J-l,0,0,0,0,0,0,0,0,0,2*r.W+2.5,0,l,-.75,n.u-r.W,1]));O(k,"main",0);f.pop()});const m=e.I;N(m,b);a.uniform4f(g,0,0,0,1);d.forEach(n=>{const r=n.j;n.Ia.forEach(l=>{if(!l.H){var p=
l.startTime;p=(r-p)/(l.Na-p);a.uniform1f(h,.5*p*p);C(f,l.x,l.y,l.z);O(m,"main",0);f.pop()}})})})}function Za(a){const b=new Uint8Array(16384),c=(h,g)=>{h/=a;g/=a;return h*h+g*g},e=Math.min(c(32,0),c(32,0));for(let h=0;64>h;h++)for(let g=0;64>g;g++){const f=4*(64*h+g);var d=c(g-32,h-32);const k=1-Math.sqrt(d/e);d=1E-4>=d?5:0;const m=Math.max(Math.round(255*k*k),0);b[f]=d+Math.max(Math.round(20*k),0);b[f+1]=d;b[f+2]=d;b[f+3]=m}return b};function $a(a,b){const c=a.g;let e=c.get(b);e||(e=ab(a.pa,b),c.set(b,e));return e}function bb(a,b){a.ha.name!==b&&(a.ha=$a(a,b))}class cb{constructor(a,b){this.pa=a;this.g=new Map([[b.name,b]]);this.ha=b}}function ab(a,b){switch(b){case "r0":return a=Va({pa:a,name:b,D:0,K:12,u:0}),b=a.m,b.s=a.D+4,a.X.push(new ya(a,b.s+2,0,a.u+.75)),a.La=.1,a;case "r1":return a=Va({pa:a,name:b,D:-12,K:10,u:5.5}),a.X.push(new ya(a,0,0,a.u+.75)),a;default:throw Error(`Unrecognized room name "${b}"`);}}
function db(a){return{x:Math.min(Math.max(a.m.s,a.D+1),a.K-1),y:0,z:a.u+1.25}};window.onload=async function(){function a(q,t){q.push(l.wb);C(q,-G.x,-G.y,-G.z);C(q,0,0,ra);D(q,sa);t();q.pop();q.pop();q.pop()}function b(q,t,y){q.bindFramebuffer(q.FRAMEBUFFER,null);q.viewport(0,0,n,r);q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA);q.clearColor(0,0,0,1);q.clear(q.COLOR_BUFFER_BIT|q.DEPTH_BUFFER_BIT);q.activeTexture(q.TEXTURE1);u.i.bindTexture();q.uniform1i(t.L.lighting,1);q.activeTexture(q.TEXTURE0);a(t.stack,()=>{y.forEach(z=>{const K=t.stack.depth();var x=t.stack;C(x,0,0,z.u);
var v=z.ja.Fb;N(v,t);O(v,"main",0);v=z.ja.ib;N(v,t);O(v,"main",0);v=z.ja.gb;N(v,t);O(v,"main",0);v=z.ja.Bb;N(v,t);O(v,"left",0);O(v,"right",0);C(x,2,0,0);v=z.o.Ba.pb;N(v,t);O(v,"main",0);x.pop();x.pop();(x=z.m.state.ta)?x(q,t):z.m.ba(q,t);Ba(q,t,z);Ua(t,z);t.stack.depth()!==K&&console.error("yo!")})})}function c(){!ca&&L(g,"fullscreen")&&(ca=d.requestFullscreen());const q=Date.now()/1E3;T=-1===T?60:.125/(q-ta)+.875*T;e.innerHTML=`fps=${Math.round(T)}`;ta=q;var t=Math.sin(Math.PI*(q+0)/8)/2+Math.sin(Math.PI*
(q+0)/3)/8,y=Math.sin(Math.PI*(q+170)/8)/2+Math.sin(Math.PI*(q+130)/3)/8;sa=Math.asin((t-y)/100);ra=(t+y)/2;y=M.ha;t=null;const z=y.transition;z&&(z.Wa+z.Xa<q?(y.transition=null,bb(M,z.Ha),y=M.ha):t=$a(M,z.Ha));const K=t?[y,t]:[y];K.forEach(x=>{{const v=q-x.Ab;x.va=v-x.j;x.j=v}});G=db(y);t&&(y=Math.sin(Math.PI/2*((q-z.Wa)/z.Xa)),t=db(t),G={x:G.x*(1-y)+t.x*y,y:G.y*(1-y)+t.y*y,z:G.z*(1-y)+t.z*y});ma(g)%2&&(k=!k,window.Qa=k);K.forEach(x=>{{let U=x.transition;var v=x.m;pa(v.v,x.j);v.state.C(x);if(x.transition&&
!U){U=x.transition;{v=$a(M,U.Ha);const ua=v.m;ua.s=x.m.s;ua.G(v,Ka)}}Ra(x);U||x.Ca||Aa(x)}});Wa(u,a,K);ia(w,(x,v)=>b(x,v,K));requestAnimationFrame(c)}const e=document.getElementById("fps"),d=document.getElementById("canvas");var h=window.getComputedStyle(d);const g=new na(document.body);J(g,"left",["a","ArrowLeft"]);J(g,"right",["d","ArrowRight"]);J(g,"showLights",["l"]);J(g,"attack",["f"," "]);J(g,"fullscreen",["u"]);J(g,"up",["w","ArrowUp"]);J(g,"down",["s","ArrowDown"]);J(g,"lightUp",["y"]);J(g,
"lightDown",["h"]);var f=parseInt(h.getPropertyValue("width"),10);h=parseInt(h.getPropertyValue("height"),10);let k=!1;const m=window.devicePixelRatio||1,n=m*f,r=m*h;d.width=n;d.height=r;const l=Ma(f,h),p=d.getContext("webgl2",{antialias:!1,alpha:!1});p.enable(p.BLEND);p.enable(p.DEPTH_TEST);p.depthFunc(p.LEQUAL);f=new E({h:p,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
h=new E({h:p,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const w=new ha({h:p,O:"projection"});fa(w,f,h).link();const u=new Ya(p,n,r,360),B=new Qa;f=(q,t)=>ja({h:p,name:q,src:t});const [H,eb,fb]=await Promise.all([Na(l,f),xa(f),La(f,q=>Pa(B,q))]);f={o:{Ma:eb,m:fb,Ba:H,Db:Ta(p)},input:g,audio:B};const M=new cb(f,ab(f,"r0"));let T=-1,ca=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(ca=null)});let G={x:0,y:0,z:0},sa,ra,ta=Date.now();requestAnimationFrame(c);d.onmousemove=()=>{}};
