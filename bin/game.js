'use strict';class aa{constructor(b,a,c){this.name=c;this.j=`${a}${c}`;switch(b){case "uniform":this.type=1;if("u_"!==a)throw Error(`uniform field "${this.j}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==a)throw Error(`in field "${this.j}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ba(b){const a=[];b.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&a.push(new aa(c[1],c[2],c[3]))});return a}
const w=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function x(b,a){b.a.uniformMatrix4fv(b.f,!1,a);b.b.push(a)}function y(b,a,c,e=0){var d=b.b;d=d.length?d[d.length-1]:w;x(b,new Float32Array([d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],a*d[0]+c*d[4]+e*d[8]+d[12],a*d[1]+c*d[5]+e*d[9]+d[13],a*d[2]+c*d[6]+e*d[10]+d[14],a*d[3]+c*d[7]+e*d[11]+d[15]]))}
function ca(b,a){var c=Math.cos(a);a=Math.sin(a);c=new Float32Array([c,0,a,0,0,1,0,0,-a,0,c,0,0,0,0,1]);a=b.b;0===a.length?x(b,c):(a=a[a.length-1],x(b,new Float32Array([c[0]*a[0]+c[1]*a[4]+c[2]*a[8]+c[3]*a[12],c[0]*a[1]+c[1]*a[5]+c[2]*a[9]+c[3]*a[13],c[0]*a[2]+c[1]*a[6]+c[2]*a[10]+c[3]*a[14],c[0]*a[3]+c[1]*a[7]+c[2]*a[11]+c[3]*a[15],c[4]*a[0]+c[5]*a[4]+c[6]*a[8]+c[7]*a[12],c[4]*a[1]+c[5]*a[5]+c[6]*a[9]+c[7]*a[13],c[4]*a[2]+c[5]*a[6]+c[6]*a[10]+c[7]*a[14],c[4]*a[3]+c[5]*a[7]+c[6]*a[11]+c[7]*a[15],
c[8]*a[0]+c[9]*a[4]+c[10]*a[8]+c[11]*a[12],c[8]*a[1]+c[9]*a[5]+c[10]*a[9]+c[11]*a[13],c[8]*a[2]+c[9]*a[6]+c[10]*a[10]+c[11]*a[14],c[8]*a[3]+c[9]*a[7]+c[10]*a[11]+c[11]*a[15],c[12]*a[0]+c[13]*a[4]+c[14]*a[8]+c[15]*a[12],c[12]*a[1]+c[13]*a[5]+c[14]*a[9]+c[15]*a[13],c[12]*a[2]+c[13]*a[6]+c[14]*a[10]+c[15]*a[14],c[12]*a[3]+c[13]*a[7]+c[14]*a[11]+c[15]*a[15]])))}class ra{constructor(b,a){this.a=b;this.f=a;this.b=[];b.uniformMatrix4fv(a,!1,w)}pop(){return this.b.pop()}}
class A{constructor(b,a){this.name=b.name;var c=this.a=b.a;b=this.type=b.type;switch(b){case "vertex":var e=this.a.VERTEX_SHADER;break;case "fragment":e=this.a.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${b}"`);}e=this.b=c.createShader(e);c.shaderSource(e,a);c.compileShader(e);if(!c.getShaderParameter(e,c.COMPILE_STATUS))throw a=`Failed to compile ${this.name} ${b}-shader: ${c.getShaderInfoLog(e)}`,c.deleteShader(e),Error(a);this.O=ba(a)}}
function B(b,...a){const c=b.a,e=b.B;a.forEach(d=>{b.G.push(d);c.attachShader(e,d.b)});return b}class G{constructor(b){this.name=b.name;this.s=b.s;b=this.a=b.a;this.b=!1;this.B=b.createProgram();this.G=[];this.m={};this.h={};this.stack=null}link(){if(this.b)return this;var b=this.a,a=this.B;b.linkProgram(a);if(!b.getProgramParameter(a,b.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${b.getProgramInfoLog(a)}`;b.deleteProgram(a);throw Error(c);}this.b=!0;return this}}
function H(b,a){var c=b.a,e=b.B;c.useProgram(e);for(var d={},f={},h=b.G,m=0;m<h.length;m++)for(var p=h[m].O,q=0;q<p.length;q++){var r=p[q];1===r.type?r.j in d||(d[r.name]=c.getUniformLocation(e,r.j)):r.j in f||(f[r.name]=c.getAttribLocation(e,r.j))}b.m=d;b.h=f;if(e=b.s)if(e in b.m)b.stack=new ra(c,b.m[e]);else throw Error(`No anchor point "${e}" in program`);try{a(c,b)}finally{b.m={},b.h={},b.stack=null}}
class I{constructor(b,a,c,e,d){this.a=b;this.name=a;this.w=c;this.c=e;this.b=d(b)}bindTexture(){this.a.bindTexture(this.a.TEXTURE_2D,this.b)}}function O(b){return(new Promise((a,c)=>{const e=new Image;e.onload=()=>void a(e);e.onerror=()=>{c(Error(`failed to load ${b.src}`))};e.mode="no-cors";e.src=b.src})).then(a=>{const c=a.naturalWidth,e=a.naturalHeight;return new I(b.a,b.name,c,e,T(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,e,0,d.RGBA,d.UNSIGNED_BYTE,a)}))})}
function sa(b){const a=b.width,c=b.height;return new I(b.a,b.name,a,c,T(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,c,0,e.RGBA,e.UNSIGNED_BYTE,b.R,0)}))}function ta(b){return new I(b.a,b.name,b.width,b.height,()=>b.V)}
function T(b){return a=>{const c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c);b(a);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindTexture(a.TEXTURE_2D,null);return c}};function U(b,a){const c=b.b.a;let e=b.f;null!=e?c.bindBuffer(c.ARRAY_BUFFER,e):(b.f=e=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,e),c.bufferData(c.ARRAY_BUFFER,b.F,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);b.b.bindTexture();c.uniform1i(a.m.texture,0);c.enableVertexAttribArray(a.h.texturePosition);c.vertexAttribPointer(a.h.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(a.h.position);c.vertexAttribPointer(a.h.position,3,c.FLOAT,!1,20,0)}
function V(b,a,c){if(!b.data.hasOwnProperty(a))throw Error(`Can not render unknown "${a}"`);a=b.data[a];b=b.b.a;const e=a.P;b.drawArrays(b.TRIANGLE_STRIP,e[c%e.length],a.U)}
class W{constructor(b,a){this.b=b;this.f=null;b=this.data={};const c=[];let e=0;for(const d in a){const f=a[d],h=[],m=f.length;if(0===m)throw Error("Sprite declared with 0 points");const p=f[0].length;if(0==p)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const q=p/5;for(let r=0;r<m;r++){const t=f[r];if(t.length!==p)throw Error("Sprite declared with inconsistent lengths of elements");h.push(e);c.push.apply(c,t);e+=q}b[d]={W:this,name:d,P:h,U:q}}this.F=new Float32Array(c)}}
;function X(b,a,c){b=b.f;null!=c?b.set(a,c):b.delete(a)}function Y(b,a){a=b.f.get(a);const c=b.b;return!!a&&a.some(e=>c.get(e))}function ua(b){const a=Y(b,"left")?1:0;return(Y(b,"right")?1:0)-a}class va{constructor(b){this.b=new Map;this.f=new Map;b.addEventListener("keydown",a=>{wa(this,a,!0)});b.addEventListener("keyup",a=>{wa(this,a,!1)});b.onblur=()=>{this.b.clear()};b.onfocus=()=>{this.b.clear()}}}
function wa(b,a,c){a=a.key;b=b.b;const e=b.get(a);c?null==e&&b.set(a,Date.now()):null!=e&&b.delete(a)};class xa{constructor(b){var a=new A({a:b,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    gl_Position = position;\n    v_texturePosition = a_texturePosition;\n}"),c=new A({a:b,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n    output_color = color;\n}");
const e=new G({a:b,s:"projection"});B(e,a,c).link();a=b.createTexture();b.bindTexture(b.TEXTURE_2D,a);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,512,256,0,b.RGBA,b.UNSIGNED_BYTE,null);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);c=b.createFramebuffer();b.bindFramebuffer(b.FRAMEBUFFER,c);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,a,0);this.b=
e;this.T=ta({V:a,name:"lighting",width:512,height:256,a:b});this.f=c;this.F=d=>{d.clearColor(0,1,0,1);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT)}}};function ya(){const b=new Uint8Array(4096),a=(d,f)=>{d/=360;f/=360;return d*d+f*f},c=Math.min(a(16,0),a(16,0));for(let d=0;32>d;d++)for(let f=0;32>f;f++){const h=4*(32*d+f),m=a(f-16,d-16);if(1E-4>=m)b[h]=255,b[h+1]=255,b[h+2]=255,b[h+3]=255;else{var e=Math.sqrt(1E-4/m);const p=Math.floor(256*e);e=Math.floor(256*e*e);b[h]=255;b[h+1]=e;b[h+2]=e;b[h+3]=m>=c?0:p}}return b}
function Z({A:b=0,X:a=0,Y:c=0,v:e,o:d,u:f,g:h,count:m,l:p=!1}){const q=e/360,r=d/360;return za({x:b*q,y:a,z:c*r,width:q,height:r,N:e/f.w,K:d/f.c,g:h,count:m,l:p})}function za({x:b=0,y:a=0,z:c=0,width:e,height:d,N:f,K:h,g:m,count:p,l:q=!1}){const r=[];for(let t=0;t<p;t++){const J=Math.floor(t/m),C=t%m;r.push(Aa({x:b,y:a,z:c,width:e,height:d,L:C*f,I:(C+1)*f,M:J*h,J:(J+1)*h,l:q}))}return r}
function Aa({x:b=0,y:a=0,z:c=0,width:e,height:d,L:f,M:h,I:m,J:p,l:q=!1}){q?q=m:(q=f,f=m);return[e-b,a,-c,f,p,-b,a,-c,q,p,e-b,a,d-c,f,h,-b,a,d-c,q,h]}
window.onload=async function(){function b(){var k=Date.now();const g=(k-da)/1E3;da=k;e.innerHTML=`fps=${Math.round(1/g)}`;k=(k-Ba)/1E3;var v=Math.sin(Math.PI*(u+0)/8)/2+Math.sin(Math.PI*(u+0)/3)/8,D=Math.sin(Math.PI*(u+170)/8)/2+Math.sin(Math.PI*(u+130)/3)/8;K=Math.asin((v-D)/100);ea=Math.cos(K);fa=Math.sin(K);ha=(v+D)/2;z=1.2*g*ua(h);0!==z&&(P+=z,L=0>z);v=Math.floor(10*k)-Math.floor(10*u);for(D=0;D<v;D++){var M=(Math.random()-.5)*Math.PI/4+Math.PI/2;const l=2*Math.random()+1,Da=P+(Ca-(z?.05:0))*
(L?-1:1),Ea=326/360,Fa=l*Math.sin(M);M=l*Math.cos(M);100<E.length&&E.shift();E.push({C:!1,x:Da,y:0,z:Ea,D:M,S:.1*Math.sin(2*Math.PI*Math.random()),i:Fa})}E.forEach(l=>{l.C||(l.i-=9.8*ea*g,l.D-=9.8*fa*g,l.x+=l.D*g,l.y+=l.S*g,l.z+=l.i*g,0>l.z?(l.z=-l.z,l.i*=-.25):.01>l.z&&.1>Math.abs(l.i)&&(l.C=!0))});u=k}function a(k,g){k.bindFramebuffer(k.FRAMEBUFFER,null);k.viewport(0,0,q,r);k.clearColor(0,0,0,1);k.clear(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT);x(g.stack,Ga);y(g.stack,-1.5,0,n.d/2+n.c+.5);ca(g.stack,
K);y(g.stack,0,0,ha);U(ia,g);V(ia,"main",0);U(ja,g);V(ja,"main",0);y(g.stack,P,0,0);0===z?(U(ka,g),V(ka,L?"left":"right",Math.floor(12*u))):(U(la,g),V(la,L?"left":"right",Math.floor(8*u)));g.stack.pop();U(ma,g);E.forEach(v=>{v.C||(y(g.stack,v.x,v.y,v.z),V(ma,"main",0),g.stack.pop())});g.stack.pop();g.stack.pop();g.stack.pop();y(g.stack,na/180,0,(p-oa)/180);k=Math.floor(8*u)%38;U(pa,g);V(pa,"blink",6>k?k:0)}function c(){b();{var k=qa;const g=k.b.a;g.bindFramebuffer(g.FRAMEBUFFER,k.f);g.viewport(0,
0,512,256);H(k.b,k.F)}H(C,a);requestAnimationFrame(c)}const e=document.getElementById("fps"),d=document.getElementById("canvas");var f=window.getComputedStyle(d);const h=new va(document.body);X(h,"left",["a","ArrowLeft"]);X(h,"right",["d","ArrowRight"]);let m=parseInt(f.getPropertyValue("width"),10),p=parseInt(f.getPropertyValue("height"),10);const q=m,r=p;d.width=q;d.height=r;f=d.getContext("webgl2",{antialias:!1,alpha:!1});f.enable(f.DEPTH_TEST);f.depthFunc(f.LEQUAL);var t=new A({a:f,type:"vertex"},
"#version 300 es\n\n    in vec3 a_position;\n    in vec2 a_texturePosition;\n\n    uniform mat4 u_projection;\n\n    out vec2 v_texturePosition;\n\n    void main() {\n        vec4 position = u_projection * vec4(a_position, 1);\n        float variance = 1.f / (position.z + 1.f);\n\n        vec4 result = vec4(position.x, position.y * variance, -.5f * (position.z - 1.f) * variance, position.w * variance);\n        gl_Position = result;\n\n        v_texturePosition = a_texturePosition;\n    }");const J=
new A({a:f,type:"fragment"},"#version 300 es\n    precision mediump float;\n\n    uniform sampler2D u_texture;\n\n    in vec2 v_texturePosition;\n    out vec4 output_color;\n\n    void main() {\n        vec4 color = texture(u_texture, v_texturePosition.st);\n        if (color.a == 0.0) {\n            discard;\n        }\n        output_color = color;\n    }"),C=new G({a:f,s:"projection"});B(C,t,J).link();const qa=new xa(f),[F,N,Q,R,S]=await Promise.all([O({a:f,src:"assets/Back Wall.png",name:"wall"}),
O({a:f,src:"assets/new floor Floor.png",name:"floor"}),O({a:f,src:"assets/Hero Breathing with axe.png",name:"idle"}),O({a:f,src:"assets/Enemy.png",name:"enemy"}),O({a:f,src:"assets/Hero Walking with axe.png",name:"walk"})]),n={top:52/N.c,w:N.w/360,c:38/360,d:166/360,H:218/N.c},ia=new W(F,{main:[[F.w/360,-n.d/2,F.c/360,1,0,F.w/360,-n.d/2,0,1,1,0,-n.d/2,F.c/360,0,0,0,-n.d/2,0,0,1]]}),ja=new W(N,{main:[[n.w,n.d/2,-n.c,1,1,0,n.d/2,-n.c,0,1,n.w,n.d/2,0,1,n.H,0,n.d/2,0,0,n.H,n.w,-n.d/2,0,1,n.top,0,-n.d/
2,0,0,n.top]]});t=220/405;const Ca=1.125*(387/405-t),ka=new W(Q,{right:Z({A:t,v:405,o:434,u:Q,g:5,count:16}),left:Z({A:1-t,v:405,o:434,u:Q,g:5,count:16,l:!0})}),la=new W(S,{right:Z({A:258/424,v:424,o:442,u:S,g:2,count:8}),left:Z({A:1-258/424,v:424,o:442,u:S,g:2,count:8,l:!0})});f=sa({name:"fade",width:32,height:32,a:f,R:ya()});const pa=new W(R,{blink:za({x:.15,width:.3,height:.3,N:108/R.w,K:108/R.c,g:2,count:6})}),ma=new W(f,{main:[[16/360,0,-16/360,1,0,16/360,0,16/360,1,1,-16/360,0,-16/360,0,0,-16/
360,0,16/360,0,1]]});new W(qa.T,{main:[Aa({width:2,height:1,L:0,M:0,I:1,J:1})]});let na=0,oa=0;const Ga=new Float32Array([360/m,0,0,0,0,-360/p,.25,0,0,360/p,0,0,-1,-1,0,1]),E=[];let Ba=Date.now(),da=Date.now(),u=0,P=4,z=0,L=!1,K,fa,ea,ha;requestAnimationFrame(c);d.onmousemove=k=>{na=k.offsetX;oa=k.offsetY}};
