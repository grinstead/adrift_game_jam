'use strict';class aa{constructor(a,b,c){this.name=c;this.S=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.S}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.S}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ba(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new aa(c[1],c[2],c[3]))});return b}
const ca=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function A(a,b){a.h.uniformMatrix4fv(a.m,!1,b);a.g.push(b)}function C(a,b,c,e=0){var d=a.g;d=d.length?d[d.length-1]:ca;A(a,new Float32Array([d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],b*d[0]+c*d[4]+e*d[8]+d[12],b*d[1]+c*d[5]+e*d[9]+d[13],b*d[2]+c*d[6]+e*d[10]+d[14],b*d[3]+c*d[7]+e*d[11]+d[15]]))}function D(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class da{constructor(a,b){this.h=a;this.m=b;this.g=[];a.uniformMatrix4fv(b,!1,ca)}depth(){return this.g.length}pop(){return this.g.pop()}push(a){var b=this.g;0===b.length?A(this,a):(b=b[b.length-1],A(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+
a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class E{constructor(a,b){this.name=a.name;var c=this.h=a.h;a=this.type=a.type;switch(a){case "vertex":var e=this.h.VERTEX_SHADER;break;case "fragment":e=this.h.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}e=this.g=c.createShader(e);c.shaderSource(e,b);c.compileShader(e);if(!c.getShaderParameter(e,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(e)}`,c.deleteShader(e),Error(b);this.bb=ba(b)}}
function fa(a,...b){const c=a.h,e=a.va;b.forEach(d=>{a.Ha.push(d);c.attachShader(e,d.g)});return a}class ha{constructor(a){this.name=a.name;this.L=a.L;a=this.h=a.h;this.g=!1;this.va=a.createProgram();this.Ha=[];this.I={};this.N={};this.stack=null}link(){if(this.g)return this;var a=this.h,b=this.va;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.g=!0;return this}}
function ia(a,b){var c=a.h,e=a.va;c.useProgram(e);for(var d={},h={},g=a.Ha,f=0;f<g.length;f++)for(var k=g[f].bb,m=0;m<k.length;m++){var n=k[m];1===n.type?n.S in d||(d[n.name]=c.getUniformLocation(e,n.S)):n.S in h||(h[n.name]=c.getAttribLocation(e,n.S))}a.I=d;a.N=h;if(e=a.L)if(e in a.I)a.stack=new da(c,a.I[e]);else throw Error(`No anchor point "${e}" in program`);try{b(c,a)}finally{a.I={},a.N={},a.stack=null}}
class F{constructor(a,b,c,e,d){this.h=a;this.name=b;this.w=c;this.i=e;this.g=d(a)}bindTexture(){this.h.bindTexture(this.h.TEXTURE_2D,this.g)}}function ja(a){return(new Promise((b,c)=>{const e=new Image;e.onload=()=>void b(e);e.onerror=()=>{c(Error(`failed to load ${a.src}`))};e.mode="no-cors";e.src=a.src})).then(b=>{const c=b.naturalWidth,e=b.naturalHeight;return new F(a.h,a.name,c,e,ka(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,e,0,d.RGBA,d.UNSIGNED_BYTE,b)}))})}
function I(a){const b=a.width,c=a.height;return new F(a.h,a.name,b,c,ka(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,b,c,0,e.RGBA,e.UNSIGNED_BYTE,a.ya,0)}))}function la(a){return new F(a.h,a.name,a.width,a.height,()=>a.M)}
function ka(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function J(a,b){const c=a.g.h;let e=a.m;null!=e?c.bindBuffer(c.ARRAY_BUFFER,e):(a.m=e=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,e),c.bufferData(c.ARRAY_BUFFER,a.P,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.g.bindTexture();c.uniform1i(b.I.texture,0);c.enableVertexAttribArray(b.N.texturePosition);c.vertexAttribPointer(b.N.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.N.position);c.vertexAttribPointer(b.N.position,3,c.FLOAT,!1,20,0)}
function K(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.g.h;const e=b.wa;a.drawArrays(a.TRIANGLE_STRIP,e[c%e.length],b.wb)}
class L{constructor(a,b){this.g=a;this.m=null;a=this.data={};const c=[];let e=0;for(const d in b){const h=b[d],g=[],f=h.length;if(0===f)throw Error("Sprite declared with 0 points");const k=h[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const m=k/5;for(let n=0;n<f;n++){const r=h[n];if(r.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");g.push(e);c.push.apply(c,r);e+=m}a[d]={Ib:this,name:d,wa:g,wb:m}}this.P=new Float32Array(c)}}
function ma(a,b){for(var c=a.D;-1!==c&&c<=b;){c=a.P;const e=a.J+1;e===c.length?a.m===a.pb?a.D=c=-1:(a.m++,a.J=0,a.D=c=b+c[0]):(a.J=e,a.D=c=b+c[e])}}class na{constructor(a,b,c,e){const d=a.B;this.ma=a.name;this.ja=a.oa;this.g=c;this.pb="number"===typeof d?d:d?-1:0;this.La=a.set;this.P=b;this.J=this.m=0;this.D=e+b[0];this.nb=a.xb}ia(){const a=this.nb;return null!=a?a[this.J]:void 0}V(a){J(this.La,a);K(this.La,this.g,this.J)}name(){return this.ma}toString(){return`Sprite/${this.ma}`}}
function oa(a){const b=a.name,c=a.A,e=a.set.data;let d=-1;a.oa.forEach(g=>{const f=e[g];if(!f)throw Error(`Sprite/${b} has non-existent mode ${g}`);if(-1===d)d=f.wa.length;else if(d!==f.wa.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===d)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==d)throw Error(`Sprite/${b} given ${c.length} frame times for ${d} frames`);if(a.ia&&a.ia.length!==d)throw Error(`Sprite/${b} given ${a.ia.length} frame data points for ${d} frames`);
const h="number"===typeof c?Array(d).fill(c):c;return(g,f)=>new na(a,h,g,f)}function N({x:a=0,y:b=0,z:c=0,width:e,height:d,ua:h,ta:g,pa:f,count:k,Ob:m=0,Pb:n=0,Qb:r=h,Nb:l=g,aa:p=!1}){const w=[];for(let u=0;u<k;u++){const B=m+u%f*r,H=n+Math.floor(u/f)*l;w.push(pa({x:a,y:b,z:c,width:e,height:d,$a:B,Ya:B+h,ab:H,Za:H+g,aa:p}))}return w}
function pa({x:a=0,y:b=0,z:c=0,width:e,height:d,depth:h=0,$a:g,ab:f,Ya:k,Za:m,aa:n=!1}){n?(n=k,k=a-e):(n=g,g=k,k=-a,a=e-a);return[a,-b,-c,g,m,k,-b,-c,n,m,a,h-b,d-c,g,f,k,h-b,d-c,n,f]};function P(a,b,c){a=a.m;null!=c?a.set(b,c):a.delete(b)}function Q(a,b){b=a.m.get(b);const c=a.g;return!!b&&!!b.some(e=>(e=c.get(e))?(e.ga=0,null!=e.ka):!1)}function qa(a){const b=a.m.get("showLights");if(b){const c=a.g;return b.reduce((e,d)=>(d=c.get(d))?(e+=d.ga,d.ga=0,e):e,0)}return 0}class ra{constructor(a){this.g=new Map;this.m=new Map;a.addEventListener("keydown",b=>{sa(this,b,!0)});a.addEventListener("keyup",b=>{sa(this,b,!1)});a.onblur=()=>{this.g.clear()};a.onfocus=()=>{this.g.clear()}}}
function sa(a,b,c){b=b.key;a=a.g;const e=a.get(b);c?null==e?a.set(b,{ka:Date.now(),ga:1}):(null==e.ka&&(e.ka=Date.now()),e.ga++):null!=e&&(e.ka=null)};function xa(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const ya=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function za(a){const [b,c,e]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png")]);var d=new L(b,{blink:N({x:.25,z:.25,width:.5,height:.5,ua:108/b.w,ta:108/b.i,pa:2,count:6,aa:!0})});a=oa({name:"creature_attack",set:new L(e,{bite:N({x:.5,z:.75,width:1,height:2,ta:530/e.i,ua:278/e.w,pa:7,count:42,aa:!0})}),oa:["bite"],B:!0,A:1/12});var h=Array(6).fill(.125);h[0]=4;d=oa({name:"creature_normal",set:d,oa:["blink"],
B:!0,A:h});h=[];var g=92,f=-22;const k=Math.sqrt(g*g+f*f);g/=k;f/=k;for(let m=0;29>m;m++){const n=m%5,r=Math.floor(m/5),l=[],p=(w,u)=>{const B=100*w,H=77*u-48;l.push((B*g+H*f)/k,w,(B*-f+H*g)/360,100*(n+w)/c.w,77*(r+u)/c.i)};p(1,1);p(0,1);p(1,0);p(0,0);h.push(l)}h=new L(c,{wiggle:h});return{sb:d,Jb:a,Fb:h}}
class Aa{constructor(a,b,c,e){const d=a.o.Ia.sb("blink",a.l);a=a.u;this.x=this.Eb=b;this.y=c;this.z=e;this.Ra=this.Sa=0;this.Ga=[R(0,b,c,-1,1,a),R(1,b,c,-1,-1,a),R(2,b,c,1,1,a),R(3,b,c,1,-1,a)];this.v=d}}function Ba(a){const b=a.l;a.W.forEach(c=>{c.x=c.Eb+Math.sin(b);var e=.5*Math.cos(b);ma(c.v,a.l);if(b>c.Sa){var d=c.Ra;c.Ra=(d+1)%c.Ga.length;d=c.Ga[d];e=c.x+.225*e+d.lb;.05<Math.abs(e-d.qa)&&(c.Sa=b+.125,d.Qa=b+.125,d.Na=d.qa,d.Oa=d.Ca,d.Pa=d.Da,d.qa=e,d.Ca=c.y+d.mb,d.Da=a.u)}})}
function Ca(a,b){const c=a.stack,e=b.o.Ia.Fb,d=b.l,{x:h,z:g}=Da(b.j);b.W.forEach(f=>{var k=f.x;const m=f.z;C(c,k,f.y,m);let n=h<k;k=xa(g-m,h-k);n&&(c.push(ya),k=Math.PI-k);D(c,k);f.v.V(a);c.pop();n&&c.pop();c.pop()});J(e,a);b.W.forEach(f=>{const k=f.z-.1875;f.Ga.forEach(m=>{var n=f.x+m.cb,r=f.y+m.eb;let l=m.qa,p=m.Ca,w=m.Da;var u=m.Qa;d<u&&(u=1-(u-d)/.125,l=Ea(u,m.Na,n,l),p=Ea(u,m.Oa,r,p),w=Ea(u,m.Pa,k,w));n-=l;r-=p;u=k-w;const B=Math.sqrt(n*n+r*r+u*u);C(c,l,p,w);D(c,xa(u,n));c.push(new Float32Array([B,
0,0,0,0,r,0,0,0,0,1,0,0,0,0,1]));K(e,"wiggle",Math.abs((Math.floor(24*Date.now()/1E3)+m.jb)%57+1-29));c.pop();c.pop();c.pop()})})}function R(a,b,c,e,d,h){const g=.4*e;d=.1*d;b+=g;c+=d;return{index:a,cb:.05*e,eb:0,lb:g,mb:d,Qa:0,Na:b,Oa:c,Pa:h,qa:b,Ca:c,Da:h,jb:0}}function Ea(a,b,c,e){return a*(a*e+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};const Fa=434/1.8,S=405/Fa;function Da(a){return{x:a.s,z:a.$+1.8-.1}}function T(a,b,c){const e=a.state.Ta;e&&e();c=c(a,b);a.state=c;c.U(b)}function Ga(a){return(a=a.v.ia())?a.Ka:null}function U(a,b){a.Xa=b;0!==b&&(a.ra=Math.sign(b))}function X(a,b,c,e=-1===a.ra?"left":"right"){a.v=b(e,c)}
class Ha{constructor(a,b,c){this.s=b;this.la=0;this.$=c;this.ra=1;this.Xa=0;this.v=a.Ba("right",0);this.state={name:"unstarted",U:e=>T(this,e,Y),V:()=>{throw Error("Hero did not get processed before rendering!");}}}V(a,b){a=b.stack;C(a,this.s,this.la,this.$);this.v.V(b);a.pop()}}
function Y(a,b){let c=!0;X(a,b.o.j.Ba,b.l);return{name:"normal",U:e=>{const d=e.j,h=e.l;var g=e.input;if("r0"===e.name&&Q(g,"up"))T(d,e,Ia);else if(Q(g,"attack"))T(d,e,Ja);else{var f=1.2*e.sa;{const k=Q(g,"left")?1:0;g=(Q(g,"right")?1:0)-k}f*=g;g=d.s+f;g<e.C+S?f=e.C+S-d.s:g>e.H-S&&(f=e.H-S-d.s);U(d,f/e.sa);g=-1===d.ra?"left":"right";f?(d.s+=f,c&&(c=!1,X(d,e.o.j.ub,h))):c||(c=!0,X(d,e.o.j.Ba,h));e=d.v;if(g!==e.g){if(!e.ja.includes(g))throw Error(`${e} does not have mode ${g}`);e.g=g}}}}}
function Ja(a,b){X(a,b.o.j.qb,b.l);U(a,0);const c=b.o.j.kb;Ka(b.audio,a,c[Math.floor(Math.random()*c.length)]);return{name:"attacking",U:e=>{-1===a.v.D&&T(a,e,Y)}}}function Ia(a,b){X(a,b.o.j.rb,b.l,"up");U(a,0);a.la=.75;b.transition={Ea:"r1",Rb:"up",Va:Date.now()/1E3,Wa:1};return{name:"climbing",U:c=>{-1===a.v.D?T(a,c,Y):a.$=c.u+.3*Math.min(5,a.v.J)},Ta:()=>{a.la=0;a.$=b.u}}}
function La(a,b){const c=b.l;X(a,b.o.j.tb,b.l,"exit");U(a,0);b.Aa++;return{name:"entering_hatch",U:()=>{const e=a.v;if(b.l<c+1){var d=b.l;if(!e.ja.includes("exit"))throw Error(`${e} does not have mode ${"exit"}`);e.m=0;e.g="exit";e.J=0;e.D=d+e.P[0]}else-1===e.D&&T(a,b,Y)},yb:(e,d)=>{b.l<c+1||a.V(e,d,b)},Ta:()=>{b.Aa--}}}
async function Ma(a,b){const [c,e,d,h,g,f]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),a("hero_climbing","assets/Climbing Up.png"),a("hero_hatch","assets/climbing_in.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")])]);a={name:"hero_hatch_enter",M:g,ca:350,Z:406,da:161,ea:479,Y:6,B:!1,A:.125,R:[{c:201,f:137,a:172,b:175},{c:422,f:246,a:461,b:259},
{c:67,f:659,a:113,b:651},{c:419,f:658,a:462,b:648},{c:80,f:1041,a:106,b:1067},null],ba:"enter"};return{kb:f,Ba:Z({name:"hero_idle",M:c,ca:405,Z:434,da:220,ea:434,Y:16,B:!0,A:1/12,R:[{c:388,f:104,a:385,b:170},{c:792,f:105,a:790,b:170},{c:1198,f:105,a:1195,b:169},{c:1602,f:106,a:1600,b:170},{c:2008,f:106,a:2005,b:172},{c:388,f:539,a:385,b:604},{c:794,f:540,a:790,b:605},{c:1196,f:539,a:1196,b:604},{c:1602,f:539,a:1602,b:604},{c:2009,f:541,a:2007,b:604},{c:386,f:974,a:385,b:1036},{c:792,f:972,a:790,b:1033},
{c:1198,f:974,a:1196,b:1038},{c:1602,f:972,a:1601,b:1036},{c:2010,f:974,a:2005,b:1044},{c:386,f:1406,a:385,b:1477}]}),ub:Z({name:"hero_walk",M:e,ca:424,Z:444,da:258,ea:444,Y:8,B:!0,A:.125,R:[{c:408,f:110,a:404,b:166},{c:830,f:110,a:829,b:166},{c:408,f:554,a:404,b:614},{c:830,f:554,a:829,b:614},{c:408,f:998,a:404,b:1055},{c:830,f:998,a:829,b:1055},{c:408,f:1444,a:404,b:1500},{c:830,f:1444,a:829,b:1500}]}),qb:Z({name:"hero_attack",M:d,ca:644,Z:565,da:284,ea:565,Y:5,B:!1,A:1/12,R:[{c:422,f:285,a:415,
b:353},{c:936,f:367,a:868,b:380},{c:1507,f:311,a:1469,b:318},{c:162,f:948,a:206,b:943},{c:1025,f:934,a:976,b:962}]}),rb:Z({name:"hero_climbing_up",M:h,ca:222,Z:412,da:110,ea:412,Y:8,B:!1,A:.125,R:[{c:128,f:60,a:65,b:54},{c:329,f:155,a:277,b:148},{c:579,f:58,a:518,b:56},{c:772,f:157,a:721,b:156},{c:95,f:575,a:65,b:567},{c:337,f:472,a:286,b:465},null,null],ba:"up",scale:1.4}),Kb:Z(a),tb:Z({...a,name:"hero_hatch_exit",ba:"exit",zb:!0})}}
function Z(a){var b=a.M;const c=a.ca,e=a.Z,d=a.da,h=a.ea,g=a.zb?l=>[...l].reverse():l=>l,f=Fa/(a.scale||1),k=Math.floor(b.w/c),m={x:d/f,z:(e-h)/f,width:c/f,height:e/f,ua:c/b.w,ta:e/b.i,pa:k,count:a.Y},n=a.R&&a.R.map((l,p)=>{if(!l)return{Ka:null};const w=l.c,u=l.f;return{Ka:{x:(w-(p%k*c+d))/f,z:(Math.floor(p/k)*e+h-u)/f,angle:xa(-(u-l.b),w-l.a)}}});let r;a.ba?(r=[a.ba],b=new L(b,{[a.ba]:g(N(m))})):(r=["left","right"],b=new L(b,{right:g(N(m)),left:g(N({...m,aa:!0}))}));return oa({name:a.name,set:b,
oa:r,B:a.B,A:a.A,xb:n&&g(n)})};function Na(a,b){var c=376/b;const e=c/(484/b),d=c/(268/b);c/=1.25;a=b/a*c;return{vb:new Float32Array([a,0,0,0,0,0,1/1.5,(d-e)/1.5,0,c,0,0,0,0,0,(e+d)/2]),Tb:e,Sb:d,Lb:a,Mb:c,T:554/b*e/c-1.25,G:.3}}
async function Oa(a,b){const [c,e,d,h,g]=await Promise.all([b("ladder","assets/ladder.png"),b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png")]);b=2.5*c.w/c.i;b=new L(c,{main:[pa({x:b/2,y:-.75,width:b,height:2.5,$a:0,ab:.5,Ya:1,Za:1})]});return{L:a,Hb:e,ib:d,gb:h,Cb:g,ob:b}}
function Pa({Hb:a,ib:b,gb:c,Cb:e,L:d},h,g){const f=g-d.G;g=g+h+d.G;var k=494/a.i,m=1016/a.i,n=(m-k)*a.i/2.5*h/a.w;a=new L(a,{main:[[g,.75,2.5,n,k,g,.75,0,n,m,f,.75,2.5,0,k,f,.75,0,0,m]]});k=110/b.i;m=220/b.i;n=(m-k)*b.i/1.5*h/b.w;b=new L(b,{main:[[g,-.75,-d.T,n,1,f,-.75,-d.T,0,1,g,-.75,0,n,m,f,-.75,0,0,m,g,.75,0,n,k,f,.75,0,0,k]]});k=144/c.i;m=32/c.i;h=(m-k)*c.i/1.5*h/c.w;c=new L(c,{main:[[g,-.75,2.5+d.T,h,0,f,-.75,2.5+d.T,0,0,g,-.75,2.5,h,m,f,-.75,2.5,0,m,g,.75,2.5,h,k,f,.75,2.5,0,k]]});h=438/e.w;
k=318/e.w;m=194/e.i;n=1164/e.i;const r=84/e.w;d=[f,-.75,2.5,h,m,f,-.75,0,h,n,f+d.G,-.75,2.5,k,m,f+d.G,-.75,0,k,n,f+d.G,.75,2.5,r,414/e.i,f+d.G,.75,0,r,964/e.i];h=[];for(k=0;k<d.length;k+=5)h.push(g+(f-d[k]),d[k+1],d[k+2],d[k+3],d[k+4]);e=new L(e,{right:[h],left:[d]});return{Gb:a,hb:b,fb:c,Bb:e}};function Ka(a,b,c){const e=a.m;var d=e.get(b);d&&d.stop();a=a.g;d=a.createBufferSource();d.buffer=c;d.connect(a.destination);d.start();e.set(b,d)}function Qa(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.g.decodeAudioData(c))}class Ra{constructor(){this.g=new AudioContext;this.m=new WeakMap}};function Sa(a){const b=a.l,c=a.sa,e=a.j,d=a.Fa,h=Math.floor(48*b)-Math.floor(48*(b-c));for(let l=0;l<h;l++){var g=2*Math.random()+1.4;let p=.1*Math.sin(2*Math.PI*Math.random());var f=Ga(e);if(!f)break;const w=e.s+f.x*e.ra,u=f.z+e.$,B=Math.PI/4*(Math.random()-.5)+f.angle;f=g*Math.sin(B);g=g*Math.cos(B)+e.Xa;100<d.length&&d.pop();d.push({F:!1,x:w,y:e.la+.01,z:u,K:g,X:p,O:f,startTime:b,Ja:b+1.5,Ua:!1})}const k=a.u,m=9.8*c,n=0*c,r=1-.8*c;d.forEach(l=>{var p=l.F;if(!p&&b<l.Ja){l.x+=l.K*c;l.y+=l.X*c;l.z+=
l.O*c;p=l.O;l.Ua?(l.K*=r,l.X*=r):(p-=m,l.K-=n,l.O=p);if(l.x<a.C||l.x>a.H)l.F=!0;const w=l.y;if(-.75>w||.75<w){const u=0<w?.75:-.75;l.y=u+(u-w);l.X=-l.X}l.z<k&&(-.01<p?(l.z=k,l.O=0,l.Ua=!0):(l.z=k+k-l.z,l.O=-.25*p))}else p||(l.F=!0)});d.sort(Ta)}
function Ua(a){const b=1/18/18,c=h=>Math.max(0,Math.min(255,Math.round(256*(1-b*h*h)))),e=[];for(let h=0;2>h;h++)for(let g=0;18>g;g++)for(let f=0;2>f;f++){let k;var d=void 0;let m;d=g+6*f;18>d?(k=255,d=c(d),m=255):m=d=k=0;c(g+6*f);c(g+6*f+1);for(let n=0;2>n;n++)e.push(k,d,d,m)}a=I({name:"spark",width:72,height:2,h:a,ya:new Uint8Array(e)});return new L(a,{fading:N({x:1/180,width:.04,height:2/180,ua:1/18,ta:1,pa:18,count:18})})}function Ta(a,b){return a.F?b.F?0:1:b.F?-1:a.y-b.y}
function Va(a,b){const c=b.o.Db,e=a.stack;J(c,a);b.Fa.forEach(d=>{d.F||(C(e,d.x,d.y,d.z),D(e,(0<=d.K?Math.PI:0)+Math.atan(d.O/d.K)),K(c,"fading",Math.floor(12*(b.l-d.startTime))),e.pop(),e.pop())})};function Wa(a){const b=a.C,c=a.H,e=a.u,d=a.na;return{name:a.name,o:d.o,input:d.input,audio:d.audio,W:[],l:0,Ab:Date.now()/1E3-1/60,sa:0,C:b,H:c,u:e,ha:Pa(d.o.za,c-b,b),Fa:[],Ma:!1,j:new Ha(d.o.j,(c+b)/2,e),transition:null,Aa:0,xa:0}};function Xa(a,b,c){const e=a.g.h,d=a.m;e.bindFramebuffer(e.FRAMEBUFFER,a.ja);e.viewport(0,0,d.w,d.i);ia(a.g,(h,g)=>{Ya(h,g,b,a,c)})}
class Za{constructor(a,b,c,e){b/=4;c/=4;var d=new E({h:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  gl_Position = u_projection * vec4(a_position, 1);\n  v_texturePosition = a_texturePosition;\n}"),h=new E({h:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\nuniform vec4 u_color;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    \n    if (u_threshold != -1.f) {\n      color.a -= u_threshold;\n      if (color.a <= u_threshold) {\n          discard;\n      }\n      output_color = color;\n    } else {\n      if (color.a == 0.f) {\n        discard;\n      }\n      output_color = u_color;\n    }\n}");const g=
new ha({h:a,L:"projection"});fa(g,d,h).link();d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);h=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,h);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.bindFramebuffer(a.FRAMEBUFFER,
null);const f=128/e;e=I({name:"fade",width:64,height:64,h:a,ya:$a(e)});this.g=g;this.m=la({M:d,name:"lighting",width:b,height:c,h:a});this.ja=h;this.P=new L(e,{main:[[f,0,-f,1,0,f,0,f,1,1,-f,0,-f,0,0,-f,0,f,0,1]]});a=I({name:"solid",width:1,height:1,h:a,ya:new Uint8Array([255,255,255,255])});this.ma=new L(a,{main:[[0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0]]})}}
function Ya(a,b,c,e,d){a.blendFunc(a.ONE,a.ONE);a.clearColor(0,0,0,0);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const h=b.I.threshold,g=b.I.color;a.uniform1f(h,-1);const f=b.stack;c(f,()=>{const k=e.ma;J(k,b);d.forEach(n=>{a.uniform4f(g,0,0,0,window.Ma?1:n.xa);const r=n.o.za.L,l=n.C-r.G;f.push(new Float32Array([n.H+r.G-l,0,0,0,0,0,0,0,0,0,2*r.T+2.5,0,l,-.75,n.u-r.T,1]));K(k,"main",0);f.pop()});const m=e.P;J(m,b);a.uniform4f(g,0,0,0,1);d.forEach(n=>{const r=n.l;n.Fa.forEach(l=>{if(!l.F){var p=
l.startTime;p=(r-p)/(l.Ja-p);a.uniform1f(h,.5*p*p);C(f,l.x,l.y,l.z);K(m,"main",0);f.pop()}})})})}function $a(a){const b=new Uint8Array(16384),c=(h,g)=>{h/=a;g/=a;return h*h+g*g},e=Math.min(c(32,0),c(32,0));for(let h=0;64>h;h++)for(let g=0;64>g;g++){const f=4*(64*h+g);var d=c(g-32,h-32);const k=1-Math.sqrt(d/e);d=1E-4>=d?5:0;const m=Math.max(Math.round(255*k*k),0);b[f]=d+Math.max(Math.round(20*k),0);b[f+1]=d;b[f+2]=d;b[f+3]=m}return b};function ab(a,b){const c=a.g;let e=c.get(b);e||(e=bb(a.na,b),c.set(b,e));return e}function cb(a,b){a.fa.name!==b&&(a.fa=ab(a,b))}class db{constructor(a,b){this.na=a;this.g=new Map([[b.name,b]]);this.fa=b}}function bb(a,b){switch(b){case "r0":return a=Wa({na:a,name:b,C:0,H:12,u:0}),b=a.j,b.s=a.C+4,a.W.push(new Aa(a,b.s+2,0,a.u+.75)),a.xa=.1,a;case "r1":return a=Wa({na:a,name:b,C:-12,H:10,u:8.5}),a.W.push(new Aa(a,0,0,a.u+.75)),a;default:throw Error(`Unrecognized room name "${b}"`);}}
function eb(a){return{x:Math.min(Math.max(a.j.s,a.C+1),a.H-1),y:0,z:a.u+1.25}};window.xa=.1;
window.onload=async function(){function a(q,t){q.push(l.vb);C(q,-G.x,-G.y,-G.z);C(q,0,0,ta);D(q,ua);t();q.pop();q.pop();q.pop()}function b(q,t,z){q.bindFramebuffer(q.FRAMEBUFFER,null);q.viewport(0,0,n,r);q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA);q.clearColor(0,0,0,1);q.clear(q.COLOR_BUFFER_BIT|q.DEPTH_BUFFER_BIT);q.activeTexture(q.TEXTURE1);u.m.bindTexture();q.uniform1i(t.I.lighting,1);q.activeTexture(q.TEXTURE0);a(t.stack,()=>{z.forEach(y=>{const M=t.stack.depth();var x=t.stack;C(x,0,0,y.u);
var v=y.ha.Gb;J(v,t);K(v,"main",0);v=y.ha.hb;J(v,t);K(v,"main",0);v=y.ha.fb;J(v,t);K(v,"main",0);v=y.ha.Bb;J(v,t);K(v,"left",0);K(v,"right",0);C(x,2,0,0);v=y.o.za.ob;J(v,t);K(v,"main",0);x.pop();x.pop();(x=y.j.state.yb)?x(q,t):y.j.V(q,t,y);Ca(t,y);Va(t,y);t.stack.depth()!==M&&console.error("yo!")})})}function c(){!ea&&Q(g,"fullscreen")&&(ea=d.requestFullscreen());const q=Date.now()/1E3;V=-1===V?60:.125/(q-va)+.875*V;e.innerHTML=`fps=${Math.round(V)}`;va=q;var t=Math.sin(Math.PI*(q+0)/8)/2+Math.sin(Math.PI*
(q+0)/3)/8,z=Math.sin(Math.PI*(q+170)/8)/2+Math.sin(Math.PI*(q+130)/3)/8;ua=Math.asin((t-z)/100);ta=(t+z)/2;z=O.fa;t=null;const y=z.transition;y&&(y.Va+y.Wa<q?(z.transition=null,cb(O,y.Ea),z=O.fa):t=ab(O,y.Ea));const M=t?[z,t]:[z];M.forEach(x=>{{const v=q-x.Ab;x.sa=v-x.l;x.l=v}});G=eb(z);t&&(z=Math.sin(Math.PI/2*((q-y.Va)/y.Wa)),t=eb(t),G={x:G.x*(1-z)+t.x*z,y:G.y*(1-z)+t.y*z,z:G.z*(1-z)+t.z*z});qa(g)%2&&(k=!k,window.Ma=k);M.forEach(x=>{{let W=x.transition;var v=x.j;ma(v.v,x.l);v.state.U(x);if(x.transition&&
!W){W=x.transition;{v=ab(O,W.Ea);const wa=v.j;wa.s=x.j.s;T(wa,v,La)}}Sa(x);W||x.Aa||Ba(x)}});Xa(u,a,M);ia(w,(x,v)=>b(x,v,M));requestAnimationFrame(c)}const e=document.getElementById("fps"),d=document.getElementById("canvas");var h=window.getComputedStyle(d);const g=new ra(document.body);P(g,"left",["a","ArrowLeft"]);P(g,"right",["d","ArrowRight"]);P(g,"showLights",["l"]);P(g,"attack",["f"," "]);P(g,"fullscreen",["u"]);P(g,"up",["w","ArrowUp"]);P(g,"down",["s","ArrowDown"]);P(g,"lightUp",["y"]);P(g,
"lightDown",["h"]);var f=parseInt(h.getPropertyValue("width"),10);h=parseInt(h.getPropertyValue("height"),10);let k=!1;const m=window.devicePixelRatio||1,n=m*f,r=m*h;d.width=n;d.height=r;const l=Na(f,h),p=d.getContext("webgl2",{antialias:!1,alpha:!1});p.enable(p.BLEND);p.enable(p.DEPTH_TEST);p.depthFunc(p.LEQUAL);f=new E({h:p,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
h=new E({h:p,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const w=new ha({h:p,L:"projection"});fa(w,f,h).link();const u=new Za(p,n,r,360),B=new Ra;f=(q,t)=>ja({h:p,name:q,src:t});const [H,fb,gb]=await Promise.all([Oa(l,f),za(f),Ma(f,q=>Qa(B,q))]);f={o:{Ia:fb,j:gb,za:H,Db:Ua(p)},input:g,audio:B};const O=new db(f,bb(f,"r0"));let V=-1,ea=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(ea=null)});let G={x:0,y:0,z:0},ua,ta,va=Date.now();requestAnimationFrame(c);d.onmousemove=()=>{}};
