'use strict';class aa{constructor(a,b,c){this.name=c;this.ca=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.ca}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.ca}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ba(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new aa(c[1],c[2],c[3]))});return b}
const ca=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function da(a,b){a.h.uniformMatrix4fv(a.m,!1,b);a.a.push(b)}function z(a,b,c,e=0){var d=a.a;d=d.length?d[d.length-1]:ca;da(a,new Float32Array([d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],b*d[0]+c*d[4]+e*d[8]+d[12],b*d[1]+c*d[5]+e*d[9]+d[13],b*d[2]+c*d[6]+e*d[10]+d[14],b*d[3]+c*d[7]+e*d[11]+d[15]]))}function C(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class ea{constructor(a,b){this.h=a;this.m=b;this.a=[];a.uniformMatrix4fv(b,!1,ca)}depth(){return this.a.length}pop(){return this.a.pop()}push(a){var b=this.a;0===b.length?da(this,a):(b=b[b.length-1],da(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+
a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class D{constructor(a,b){this.name=a.name;var c=this.h=a.h;a=this.type=a.type;switch(a){case "vertex":var e=this.h.VERTEX_SHADER;break;case "fragment":e=this.h.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}e=this.a=c.createShader(e);c.shaderSource(e,b);c.compileShader(e);if(!c.getShaderParameter(e,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(e)}`,c.deleteShader(e),Error(b);this.ab=ba(b)}}
function fa(a,...b){const c=a.h,e=a.Ca;b.forEach(d=>{a.Pa.push(d);c.attachShader(e,d.a)});return a}class ha{constructor(a){this.name=a.name;this.Y=a.Y;a=this.h=a.h;this.a=!1;this.Ca=a.createProgram();this.Pa=[];this.U={};this.$={};this.stack=null}link(){if(this.a)return this;var a=this.h,b=this.Ca;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.a=!0;return this}}
function ia(a,b){var c=a.h,e=a.Ca;c.useProgram(e);for(var d={},h={},g=a.Pa,f=0;f<g.length;f++)for(var k=g[f].ab,l=0;l<k.length;l++){var n=k[l];1===n.type?n.ca in d||(d[n.name]=c.getUniformLocation(e,n.ca)):n.ca in h||(h[n.name]=c.getAttribLocation(e,n.ca))}a.U=d;a.$=h;if(e=a.Y)if(e in a.U)a.stack=new ea(c,a.U[e]);else throw Error(`No anchor point "${e}" in program`);try{b(c,a)}finally{a.U={},a.$={},a.stack=null}}
class ja{constructor(a,b,c,e,d){this.h=a;this.name=b;this.w=c;this.i=e;this.a=d(a)}bindTexture(){this.h.bindTexture(this.h.TEXTURE_2D,this.a)}}function la(a){return(new Promise((b,c)=>{const e=new Image;e.onload=()=>void b(e);e.onerror=()=>{c(Error(`failed to load ${a.src}`))};e.mode="no-cors";e.src=a.src})).then(b=>{const c=b.naturalWidth,e=b.naturalHeight;return new ja(a.h,a.name,c,e,ma(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,e,0,d.RGBA,d.UNSIGNED_BYTE,b)}))})}
function na(a){const b=a.width,c=a.height;return new ja(a.h,a.name,b,c,ma(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,b,c,0,e.RGBA,e.UNSIGNED_BYTE,a.Fa,0)}))}function oa(a){return new ja(a.h,a.name,a.width,a.height,()=>a.T)}
function ma(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function E(a,b,c){a=a.m;null!=c?a.set(b,c):a.delete(b)}function G(a,b){b=a.m.get(b);const c=a.a;return!!b&&!!b.some(e=>(e=c.get(e))?(e.ra=0,null!=e.va):!1)}function pa(a){const b=a.m.get("showLights");if(b){const c=a.a;return b.reduce((e,d)=>(d=c.get(d))?(e+=d.ra,d.ra=0,e):e,0)}return 0}function qa(a){const b=G(a,"left")?1:0;return(G(a,"right")?1:0)-b}
class ra{constructor(a){this.a=new Map;this.m=new Map;a.addEventListener("keydown",b=>{sa(this,b,!0)});a.addEventListener("keyup",b=>{sa(this,b,!1)});a.onblur=()=>{this.a.clear()};a.onfocus=()=>{this.a.clear()}}}function sa(a,b,c){b=b.key;a=a.a;const e=a.get(b);c?null==e?a.set(b,{va:Date.now(),ra:1}):(null==e.va&&(e.va=Date.now()),e.ra++):null!=e&&(e.va=null)};function I(a,b){const c=a.a.h;let e=a.m;null!=e?c.bindBuffer(c.ARRAY_BUFFER,e):(a.m=e=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,e),c.bufferData(c.ARRAY_BUFFER,a.P,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.a.bindTexture();c.uniform1i(b.U.texture,0);c.enableVertexAttribArray(b.$.texturePosition);c.vertexAttribPointer(b.$.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.$.position);c.vertexAttribPointer(b.$.position,3,c.FLOAT,!1,20,0)}
function K(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.a.h;const e=b.Da;a.drawArrays(a.TRIANGLE_STRIP,e[c%e.length],b.Ab)}
class L{constructor(a,b){this.a=a;this.m=null;a=this.data={};const c=[];let e=0;for(const d in b){const h=b[d],g=[],f=h.length;if(0===f)throw Error("Sprite declared with 0 points");const k=h[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const l=k/5;for(let n=0;n<f;n++){const q=h[n];if(q.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");g.push(e);c.push.apply(c,q);e+=l}a[d]={Sb:this,name:d,Da:g,Ab:l}}this.P=new Float32Array(c)}}
function ta(a,b){for(var c=a.K;-1!==c&&c<=b;){c=a.P;const e=a.J+1;e===c.length?a.m===a.rb?a.K=c=-1:(a.m++,a.J=0,a.K=c=b+c[0]):(a.J=e,a.K=c=b+c[e])}}function ua(a,b){if(b!==a.a){if(!a.ua.includes(b))throw Error(`${a} does not have mode ${b}`);a.a=b}}
class va{constructor(a,b,c,e){const d=a.H;this.xa=a.name;this.ua=a.ma;this.a=c;this.rb="number"===typeof d?d:d?-1:0;this.Sa=a.set;this.P=b;this.J=this.m=0;this.K=e+b[0];this.ob=a.Bb}ta(){const a=this.ob;return null!=a?a[this.J]:void 0}fa(a){I(this.Sa,a);K(this.Sa,this.a,this.J)}name(){return this.xa}toString(){return`Sprite/${this.xa}`}}
function M(a){const b=a.name,c=a.G,e=a.set.data;let d=-1;a.ma.forEach(g=>{const f=e[g];if(!f)throw Error(`Sprite/${b} has non-existent mode ${g}`);if(-1===d)d=f.Da.length;else if(d!==f.Da.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===d)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==d)throw Error(`Sprite/${b} given ${c.length} frame times for ${d} frames`);if(a.ta&&a.ta.length!==d)throw Error(`Sprite/${b} given ${a.ta.length} frame data points for ${d} frames`);
const h="number"===typeof c?Array(d).fill(c):c;return(g,f)=>new va(a,h,g,f)}function N({x:a=0,y:b=0,z:c=0,width:e,height:d,ja:h,ia:g,ea:f,count:k,Zb:l=0,$b:n=0,ac:q=h,Yb:m=g,ga:u=!1}){const r=[];for(let v=0;v<k;v++){const A=l+v%f*q,H=n+Math.floor(v/f)*m;r.push(Aa({x:a,y:b,z:c,width:e,height:d,Mb:A,Kb:A+h,Nb:H,Lb:H+g,ga:u}))}return r}
function Aa({x:a=0,y:b=0,z:c=0,width:e,height:d,depth:h=0,Mb:g,Nb:f,Kb:k,Lb:l,ga:n=!1}){n?(n=k,k=a-e):(n=g,g=k,k=-a,a=e-a);return[a,-b,-c,g,l,k,-b,-c,n,l,a,h-b,d-c,g,f,k,h-b,d-c,n,f]};function Ba(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const Ca=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function Da(a,b){const [c,e,d,h,g]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png"),b("assets/Enemy Dying.mp3"),a("creature_death","assets/Enemy Dying.png")]);var f=new L(c,{blink:N({x:.25,z:.25,width:.5,height:.5,ja:108/c.w,ia:108/c.i,ea:2,count:6,ga:!0})});a=M({name:"creature_attack",set:new L(d,{bite:N({x:.5,z:.75,width:1,height:2,ia:530/d.i,ja:278/d.w,ea:7,count:42,ga:!0})}),ma:["bite"],H:!0,G:1/12});b=M({name:"creature_death",
set:new L(g,{left:N({x:330/(460/1.8),y:.375,z:0,width:660/(460/1.8),height:1.8,ja:660/g.w,ia:460/g.i,ea:3,count:12}),right:N({x:1.32,y:.375,z:0,width:2.64,height:1.8,ja:660/g.w,ia:450/g.i,ea:3,count:12,ga:!0})}),ma:["left","right"],H:!1,G:.125});var k=Array(6).fill(.125);k[0]=4;f=M({name:"creature_normal",set:f,ma:["blink"],H:!0,G:k});k=[];var l=92,n=-22;const q=Math.sqrt(l*l+n*n);l/=q;n/=q;for(let m=0;29>m;m++){const u=m%5,r=Math.floor(m/5),v=[],A=(H,T)=>{const U=100*H,V=77*T-48;v.push((U*l+V*n)/
q,H,(U*-n+V*l)/360,100*(u+H)/e.w,77*(r+T)/e.i)};A(1,1);A(0,1);A(1,0);A(0,0);k.push(v)}k=new L(e,{wiggle:k});return{vb:f,Vb:a,ub:b,Jb:k,gb:h}}class Ea{constructor(a,b,c,e){const d=a.o.qa.vb("blink",a.l),h=a.u;this.x=this.P=b;this.y=c;this.z=e;this.a=this.m=0;this.oa=[O(0,b,c,-1,1,h),O(1,b,c,-1,-1,h),O(2,b,c,1,1,h),O(3,b,c,1,-1,h)];this.v=d;this.state=Fa(this,a)}F(a,b){const c=this.state.Ka;c&&c();this.state=b=b(this,a);b.I(a)}S(a,b,c){this.v=a(c,b)}}
function Fa(a,b){return{name:"creature_normal",I:()=>{var c=b.l;a.x=a.P+Math.sin(c);var e=.5*Math.cos(c);c=b.l;if(c>a.m){var d=a.a;a.a=(d+1)%a.oa.length;d=a.oa[d];e=a.x+.225*e+d.mb;.05<Math.abs(e-d.Aa)&&(a.m=c+.125,d.Wa=c+.125,d.Ta=d.Aa,d.Ua=d.La,d.Va=d.Ma,d.Aa=e,d.La=a.y+d.nb,d.Ma=b.u)}},Z:(c,e,d)=>{c=e.stack;const h=a.x,g=a.z;z(c,h,a.y,g);let f=d.x<h;d=Ba(d.z-g,d.x-h);f&&(c.push(Ca),d=Math.PI-d);C(c,d);a.v.fa(e);c.pop();f&&c.pop();c.pop()}}}
function Ga(a,b){Ha(b.audio,a,b.o.qa.gb);const c=b.o.qa.ub(b.j.s<a.x?"left":"right",b.l);a.v=c;return{name:"creature_death",I:()=>{1<c.J&&a.oa.length&&(a.oa=[]);-1===c.K&&b.N.splice(b.N.indexOf(a),1)},Z:(e,d)=>{console.log("DEATH");e=d.stack;z(e,a.x,a.y,b.u);c.fa(d);e.pop()}}}function Ia(a){const b=a.l;a.N.forEach(c=>{ta(c.v,b);c.state.I(a)})}
function Ja(a,b,c){const e=b.stack,d=c.o.qa.Jb,h=c.l,g=Ka(c.j);c.N.forEach(f=>{f.state.Z(a,b,g)});I(d,b);c.N.forEach(f=>{const k=f.z-.1875;f.oa.forEach(l=>{var n=f.x+l.bb,q=f.y+l.cb;let m=l.Aa,u=l.La,r=l.Ma;var v=l.Wa;h<v&&(v=1-(v-h)/.125,m=La(v,l.Ta,n,m),u=La(v,l.Ua,q,u),r=La(v,l.Va,k,r));n-=m;q-=u;v=k-r;const A=Math.sqrt(n*n+q*q+v*v);z(e,m,u,r);C(e,Ba(v,n));e.push(new Float32Array([A,0,0,0,0,q,0,0,0,0,1,0,0,0,0,1]));K(d,"wiggle",Math.abs((Math.floor(24*Date.now()/1E3)+l.kb)%57+1-29));e.pop();e.pop();
e.pop()})})}function O(a,b,c,e,d,h){const g=.4*e;d=.1*d;b+=g;c+=d;return{index:a,bb:.05*e,cb:0,mb:g,nb:d,Wa:0,Ta:b,Ua:c,Va:h,Aa:b,La:c,Ma:h,kb:0}}function La(a,b,c,e){return a*(a*e+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};class Ma{constructor(a){this.a=!1;this.x=a}Z(a,b,c){a=b.stack;const e=c.o.Ga.qb;z(a,this.x,0,c.u);I(e,b);K(e,this.a?"on":"off",0);a.pop()}};const Na=434/1.8,Q=405/Na;function Ka(a){return{x:a.s,z:a.X+1.8-.1}}function Oa(a){return(a=a.v.ta())?a.Ra:null}function R(a,b){a.$a=b;0!==b&&(a.na=Math.sign(b))}
class Pa{constructor(a,b,c){this.s=b;this.wa=0;this.X=c;this.na=1;this.$a=0;this.v=a.Ja("right",0);this.state={name:"unstarted",I:e=>this.F(e,S),Z:()=>{throw Error("Hero did not get processed before rendering!");}}}S(a,b,c=-1===this.na?"left":"right"){this.v=a(c,b)}fa(a,b){a=b.stack;z(a,this.s,this.wa,this.X);this.v.fa(b);a.pop()}F(a,b,c){const e=this.state.Ka;e&&e();this.state=b=b(this,a,c);b.I(a)}}function Qa(a,b,c){const e=c.j.state.Z;e?e(a,b):c.j.fa(a,b)}
function S(a,b){let c=!0;a.S(b.o.j.Ja,b.l);return{name:"normal",I:e=>{const d=e.j,h=e.l;var g=e.input;if(!G(g,"up")||!e.Ha.some(k=>{if(k instanceof Ma&&!k.a&&.2>Math.abs(d.s-k.x))return d.F(e,Ra,k),!0}))if("r0"===e.name&&G(g,"up"))d.F(e,Sa);else if(G(g,"attack"))d.F(e,Ta);else{g=1.2*e.Ba*qa(g);var f=d.s+g;f<e.L+Q?g=e.L+Q-d.s:f>e.M-Q&&(g=e.M-Q-d.s);R(d,g/e.Ba);f=-1===d.na?"left":"right";g?(d.s+=g,c&&(c=!1,d.S(e.o.j.yb,h))):c||(c=!0,d.S(e.o.j.Ja,h));ua(d.v,f)}}}}
function Ta(a,b){const c=a.s+300/Na*a.na;var e=b.N.find(d=>.4>Math.abs(c-d.x));e&&"creature_death"!==e.state.name&&e.F(b,Ga);a.S(b.o.j.sb,b.l);R(a,0);e=b.o.j.lb;Ha(b.audio,a,e[Math.floor(Math.random()*e.length)]);return{name:"attacking",I:d=>{-1===a.v.K&&a.F(d,S)}}}function Ra(a,b,c){a.S(b.o.j.xb,b.l,"main");R(a,0);a.s=c.x;return{name:"switch_on",I:()=>{!c.a&&6<=a.v.J&&(Ha(b.audio,c,b.o.j.pb),b.ya=!0,c.a=!0);-1===a.v.K&&a.F(b,S)}}}
function Sa(a,b){a.S(b.o.j.tb,b.l,"up");R(a,0);a.wa=.55;b.transition={Na:"r1",bc:"up",Ya:Date.now()/1E3,Za:1};return{name:"climbing",I:c=>{-1===a.v.K?a.F(c,S):a.X=c.u+.3*Math.min(5,a.v.J)},Ka:()=>{a.wa=0;a.X=b.u}}}
function Ua(a,b){const c=b.l;a.S(b.o.j.wb,b.l,"exit");R(a,0);b.Ia++;return{name:"entering_hatch",I:()=>{const e=a.v;if(b.l<c+1){var d=b.l;if(!e.ua.includes("exit"))throw Error(`${e} does not have mode ${"exit"}`);e.m=0;e.a="exit";e.J=0;e.K=d+e.P[0]}else-1===e.K?a.F(b,S):a.X=b.u+([-.5,-.5,-.3,-.3][a.v.J]||0)},Z:(e,d)=>{b.l<c+1||a.fa(e,d)},Ka:()=>{b.Ia--;a.X=b.u}}}
async function Va(a,b){const [c,e,d,h,g,f,k,l]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),a("hero_climbing","assets/Climbing Up.png"),a("hero_hatch","assets/climbing_in.png"),a("hero_light","assets/Hero flipping Switch.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")]),b("assets/light.mp3")]);a={name:"hero_hatch_enter",T:g,B:350,A:406,C:161,D:479,
ba:6,H:!1,G:.125,W:[{f:201,g:137,b:172,c:175},{f:422,g:246,b:461,c:259},{f:67,g:659,b:113,c:651},{f:419,g:658,b:462,c:648},{f:80,g:1041,b:106,c:1067},null],ha:"enter"};return{lb:k,Ja:W({name:"hero_idle",T:c,B:405,A:434,C:220,D:434,ba:16,H:!0,G:1/12,W:[{f:388,g:104,b:385,c:170},{f:792,g:105,b:790,c:170},{f:1198,g:105,b:1195,c:169},{f:1602,g:106,b:1600,c:170},{f:2008,g:106,b:2005,c:172},{f:388,g:539,b:385,c:604},{f:794,g:540,b:790,c:605},{f:1196,g:539,b:1196,c:604},{f:1602,g:539,b:1602,c:604},{f:2009,
g:541,b:2007,c:604},{f:386,g:974,b:385,c:1036},{f:792,g:972,b:790,c:1033},{f:1198,g:974,b:1196,c:1038},{f:1602,g:972,b:1601,c:1036},{f:2010,g:974,b:2005,c:1044},{f:386,g:1406,b:385,c:1477}]}),yb:W({name:"hero_walk",T:e,B:424,A:444,C:258,D:444,ba:8,H:!0,G:.125,W:[{f:408,g:110,b:404,c:166},{f:830,g:110,b:829,c:166},{f:408,g:554,b:404,c:614},{f:830,g:554,b:829,c:614},{f:408,g:998,b:404,c:1055},{f:830,g:998,b:829,c:1055},{f:408,g:1444,b:404,c:1500},{f:830,g:1444,b:829,c:1500}]}),sb:W({name:"hero_attack",
T:d,B:644,A:565,C:284,D:565,ba:5,H:!1,G:1/12,W:[{f:422,g:285,b:415,c:353},{f:936,g:367,b:868,c:380},{f:1507,g:311,b:1469,c:318},{f:162,g:948,b:206,c:943},{f:1025,g:934,b:976,c:962}]}),tb:W({name:"hero_climbing_up",T:h,B:222,A:412,C:110,D:412,ba:8,H:!1,G:.125,W:[{f:128,g:60,b:65,c:54},{f:329,g:155,b:277,c:148},{f:579,g:58,b:518,c:56},{f:772,g:157,b:721,c:156},{f:95,g:575,b:65,c:567},{f:337,g:472,b:286,c:465},null,null],ha:"up",scale:1.4}),Wb:W(a),wb:W({...a,name:"hero_hatch_exit",ha:"exit",Cb:!0}),
xb:W({name:"hero_switch",T:f,B:274,A:444,C:104,D:442,ba:9,H:!1,G:1/12,ha:"main",W:null}),pb:l}}
function W(a){var b=a.T;const c=a.B,e=a.A,d=a.C,h=a.D,g=a.Cb?m=>[...m].reverse():m=>m,f=Na/(a.scale||1),k=Math.floor(b.w/c),l={x:d/f,z:(e-h)/f,width:c/f,height:e/f,ja:c/b.w,ia:e/b.i,ea:k,count:a.ba},n=a.W&&a.W.map((m,u)=>{if(!m)return{Ra:null};const r=m.f,v=m.g;return{Ra:{x:(r-(u%k*c+d))/f,z:(Math.floor(u/k)*e+h-v)/f,angle:Ba(-(v-m.c),r-m.b)}}});let q;a.ha?(q=[a.ha],b=new L(b,{[a.ha]:g(N(l))})):(q=["left","right"],b=new L(b,{right:g(N(l)),left:g(N({...l,ga:!0}))}));return M({name:a.name,set:b,ma:q,
H:a.H,G:a.G,Bb:n&&g(n)})};function Wa(a,b){var c=376/b;const e=c/(484/b),d=c/(268/b);c/=1.25;const h=b/a*c;return{zb:new Float32Array([h,0,0,0,0,0,1/1.5,(d-e)/1.5,0,c,0,0,0,0,0,(e+d)/2]),Pb:e,Ob:d,Eb:h,Fb:c,B:a,A:b,da:554/b*e/c-1.25,R:.3}}
async function Xa(a,b){const [c,e,d,h,g,f,k]=await Promise.all([b("ladder","assets/ladder.png"),b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png"),b("set_pieces","assets/set_pieces.png"),b("lights","assets/Light Switch Flip.png")]);b=new L(c,{main:[X(a,c,{C:c.w,D:c.i,B:c.w,A:c.i,offsetY:.55,za:1.25})]});var l={};l.barrel1=[X(a,f,{C:370,D:270,B:338,A:222,offsetY:.55})];l.upperHatch=[X(a,f,{C:2036,D:725,B:345,A:311,offsetY:.55})];
l.lowerHatch=[X(a,f,{C:2036,D:725,B:345,A:311,offsetY:.1,hb:!0,za:.5})];l=new L(f,l);const n=new L(k,{on:[X(a,k,{C:316,D:1110,B:118,A:152,offsetY:.75,za:1.4})],off:[X(a,k,{C:316,D:298,B:118,A:152,offsetY:.75,za:1.4})]});return{Y:a,Rb:e,jb:d,fb:h,Hb:g,Ub:b,Xb:l,qb:n}}
function Ya({Rb:a,jb:b,fb:c,Hb:e,Y:d},h,g){const f=g-d.R;g=g+h+d.R;var k=494/a.i,l=1016/a.i,n=(l-k)*a.i/2.5*h/a.w;a=new L(a,{main:[[g,.75,2.5,n,k,g,.75,0,n,l,f,.75,2.5,0,k,f,.75,0,0,l]]});k=110/b.i;l=220/b.i;n=(l-k)*b.i/1.5*h/b.w;b=new L(b,{main:[[g,-.75,-d.da,n,1,f,-.75,-d.da,0,1,g,-.75,0,n,l,f,-.75,0,0,l,g,.75,0,n,k,f,.75,0,0,k]]});k=144/c.i;l=32/c.i;h=(l-k)*c.i/1.5*h/c.w;c=new L(c,{main:[[g,-.75,2.5+d.da,h,0,f,-.75,2.5+d.da,0,0,g,-.75,2.5,h,l,f,-.75,2.5,0,l,g,.75,2.5,h,k,f,.75,2.5,0,k]]});h=438/
e.w;k=318/e.w;l=194/e.i;n=1164/e.i;const q=84/e.w;d=[f,-.75,2.5,h,l,f,-.75,0,h,n,f+d.R,-.75,2.5,k,l,f+d.R,-.75,0,k,n,f+d.R,.75,2.5,q,414/e.i,f+d.R,.75,0,q,964/e.i];h=[];for(k=0;k<d.length;k+=5)h.push(g+(f-d[k]),d[k+1],d[k+2],d[k+3],d[k+4]);e=new L(e,{right:[h],left:[d]});return{Qb:a,ib:b,eb:c,Gb:e}}
function X(a,b,{offsetX:c=0,offsetY:e=0,za:d=0,C:h,D:g,B:f,A:k,hb:l=!1,Tb:n=!1}){let q=(g-k)/b.i;g/=b.i;l&&(l=q,q=g,g=l);l=(h-f)/b.w;b=h/b.w;n&&(n=l,l=b,b=n);const m=a.Eb;n=a.Fb;h=(e+.75)/1.5;h=a.Pb*(1-h)+a.Ob*h;c=c*m/h;d=d*n/h;f=f/a.B/2;k=k/a.A/2;a=(c-f)*h/m;f=(c+f)*h/m;c=(d+k)*h/n;k=(d-k)*h/n;return[a,e,c,l,q,f,e,c,b,q,a,e,k,l,g,f,e,k,b,g]};function Ha(a,b,c){const e=a.m;var d=e.get(b);d&&d.stop();a=a.a;d=a.createBufferSource();d.buffer=c;d.connect(a.destination);d.start();e.set(b,d)}function Za(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.a.decodeAudioData(c))}class $a{constructor(){this.a=new AudioContext;this.m=new WeakMap}};function ab(a){const b=a.l,c=a.Ba,e=a.j,d=a.Oa,h=Math.floor(48*b)-Math.floor(48*(b-c));for(let m=0;m<h;m++){var g=2*Math.random()+1.4;let u=.1*Math.sin(2*Math.PI*Math.random());var f=Oa(e);if(!f)break;const r=e.s+f.x*e.na,v=f.z+e.X,A=Math.PI/4*(Math.random()-.5)+f.angle;f=g*Math.sin(A);g=g*Math.cos(A)+e.$a;100<d.length&&d.pop();d.push({O:!1,x:r,y:e.wa+.01,z:v,V:g,ka:u,aa:f,startTime:b,Qa:b+1.5,Xa:!1})}const k=a.u,l=9.8*c,n=0*c,q=1-.8*c;d.forEach(m=>{var u=m.O;if(!u&&b<m.Qa){m.x+=m.V*c;m.y+=m.ka*c;
m.z+=m.aa*c;u=m.aa;m.Xa?(m.V*=q,m.ka*=q):(u-=l,m.V-=n,m.aa=u);if(m.x<a.L||m.x>a.M)m.O=!0;const r=m.y;if(-.75>r||.75<r){const v=0<r?.75:-.75;m.y=v+(v-r);m.ka=-m.ka}m.z<k&&(-.01<u?(m.z=k,m.aa=0,m.Xa=!0):(m.z=k+k-m.z,m.aa=-.25*u))}else u||(m.O=!0)});d.sort(bb)}
function cb(a){const b=1/18/18,c=h=>Math.max(0,Math.min(255,Math.round(256*(1-b*h*h)))),e=[];for(let h=0;2>h;h++)for(let g=0;18>g;g++)for(let f=0;2>f;f++){let k;var d=void 0;let l;d=g+6*f;18>d?(k=255,d=c(d),l=255):l=d=k=0;c(g+6*f);c(g+6*f+1);for(let n=0;2>n;n++)e.push(k,d,d,l)}a=na({name:"spark",width:72,height:2,h:a,Fa:new Uint8Array(e)});return new L(a,{fading:N({x:1/180,width:.04,height:2/180,ja:1/18,ia:1,ea:18,count:18})})}function bb(a,b){return a.O?b.O?0:1:b.O?-1:a.y-b.y}
function db(a,b){const c=b.o.Ib,e=a.stack;I(c,a);b.Oa.forEach(d=>{d.O||(z(e,d.x,d.y,d.z),C(e,(0<=d.V?Math.PI:0)+Math.atan(d.aa/d.V)),K(c,"fading",Math.floor(12*(b.l-d.startTime))),e.pop(),e.pop())})};function eb(a){const b=a.L,c=a.M,e=a.u,d=a.la;return{name:a.name,o:d.o,input:d.input,audio:d.audio,N:[],l:0,Db:Date.now()/1E3-1/60,Ba:0,L:b,M:c,u:e,sa:Ya(d.o.Ga,c-b,b),Oa:[],ya:!1,j:new Pa(d.o.j,(c+b)/2,e),transition:null,Ia:0,Ea:0,Ha:[]}};function fb(a,b,c){const e=a.a.h,d=a.m;e.bindFramebuffer(e.FRAMEBUFFER,a.ua);e.viewport(0,0,d.w,d.i);ia(a.a,(h,g)=>{gb(h,g,b,a,c)})}
class hb{constructor(a,b,c,e){b/=4;c/=4;var d=new D({h:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  gl_Position = u_projection * vec4(a_position, 1);\n  v_texturePosition = a_texturePosition;\n}"),h=new D({h:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\nuniform vec4 u_color;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    \n    if (u_threshold != -1.f) {\n      color.a -= u_threshold;\n      if (color.a <= u_threshold) {\n          discard;\n      }\n      output_color = color;\n    } else {\n      if (color.a == 0.f) {\n        discard;\n      }\n      output_color = u_color;\n    }\n}");const g=
new ha({h:a,Y:"projection"});fa(g,d,h).link();d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);h=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,h);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.bindFramebuffer(a.FRAMEBUFFER,
null);const f=128/e;e=na({name:"fade",width:64,height:64,h:a,Fa:ib(e)});this.a=g;this.m=oa({T:d,name:"lighting",width:b,height:c,h:a});this.ua=h;this.P=new L(e,{main:[[f,0,-f,1,0,f,0,f,1,1,-f,0,-f,0,0,-f,0,f,0,1]]});a=na({name:"solid",width:1,height:1,h:a,Fa:new Uint8Array([255,255,255,255])});this.xa=new L(a,{main:[[0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0]]})}}
function gb(a,b,c,e,d){a.blendFunc(a.ONE,a.ONE);a.clearColor(0,0,0,0);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const h=b.U.threshold,g=b.U.color;a.uniform1f(h,-1);const f=b.stack;c(f,()=>{const k=e.xa;I(k,b);d.forEach(n=>{a.uniform4f(g,0,0,0,window.ya||n.ya?1:n.Ea);const q=n.o.Ga.Y,m=n.L-q.R;f.push(new Float32Array([n.M+q.R-m,0,0,0,0,0,0,0,0,0,2*q.da+2.5,0,m,-.75,n.u-q.da,1]));K(k,"main",0);f.pop()});const l=e.P;I(l,b);a.uniform4f(g,0,0,0,1);d.forEach(n=>{const q=n.l;n.Oa.forEach(m=>{if(!m.O){var u=
m.startTime;u=(q-u)/(m.Qa-u);a.uniform1f(h,.5*u*u);z(f,m.x,m.y,m.z);K(l,"main",0);f.pop()}})})})}function ib(a){const b=new Uint8Array(16384),c=(h,g)=>{h/=a;g/=a;return h*h+g*g},e=Math.min(c(32,0),c(32,0));for(let h=0;64>h;h++)for(let g=0;64>g;g++){const f=4*(64*h+g);var d=c(g-32,h-32);const k=1-Math.sqrt(d/e);d=1E-4>=d?5:0;const l=Math.max(Math.round(255*k*k),0);b[f]=d+Math.max(Math.round(20*k),0);b[f+1]=d;b[f+2]=d;b[f+3]=l}return b};function jb(a,b){const c=a.a;let e=c.get(b);e||(e=kb(a.la,b),c.set(b,e));return e}function lb(a,b){a.pa.name!==b&&(a.pa=jb(a,b))}class mb{constructor(a,b){this.la=a;this.a=new Map([[b.name,b]]);this.pa=b}}
function kb(a,b){switch(b){case "start":return a=eb({la:a,name:b,M:6,L:-6,u:20}),a.Ea=.4,a.j.s=-1,a.Ha.push(new Ma(1)),a;case "r0":return a=eb({la:a,name:b,L:0,M:12,u:0}),b=a.j,b.s=a.L+4,a.N.push(new Ea(a,b.s+2,0,a.u+.75)),a.Ea=.1,a;case "r1":return a=eb({la:a,name:b,L:-12,M:10,u:5.5}),a.N.push(new Ea(a,0,0,a.u+.75)),a;default:throw Error(`Unrecognized room name "${b}"`);}}function nb(a){return{x:Math.min(Math.max(a.j.s,a.L+1),a.M-1),y:0,z:a.u+1.25}};window.onload=async function(){function a(p,t){p.push(u.zb);z(p,-J.x,-J.y,-J.z);z(p,0,0,wa);C(p,xa);t();p.pop();p.pop();p.pop()}function b(p,t,w){const B=t.stack;z(B,0,0,w.u);var x=w.sa.Qb;I(x,t);K(x,"main",0);x=w.sa.ib;I(x,t);K(x,"main",0);x=w.sa.eb;I(x,t);K(x,"main",0);x=w.sa.Gb;I(x,t);K(x,"left",0);K(x,"right",0);B.pop();w.Ha.forEach(y=>{y.Z(p,t,w)});Qa(p,t,w);Ja(p,t,w);db(t,w)}function c(p,t,w){p.bindFramebuffer(p.FRAMEBUFFER,null);p.viewport(0,0,q,m);p.blendFunc(p.SRC_ALPHA,p.ONE_MINUS_SRC_ALPHA);
p.clearColor(0,0,0,1);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);p.activeTexture(p.TEXTURE1);A.m.bindTexture();p.uniform1i(t.U.lighting,1);p.activeTexture(p.TEXTURE0);a(t.stack,()=>{w.forEach(B=>{const x=t.stack.depth();b(p,t,B);t.stack.depth()!==x&&console.error("yo!")})})}function e(){!ka&&G(f,"fullscreen")&&(ka=h.requestFullscreen());const p=Date.now()/1E3;Y=-1===Y?60:.125/(p-ya)+.875*Y;d.innerHTML=`fps=${Math.round(Y)}`;ya=p;var t=Math.sin(Math.PI*(p+0)/8)/2+Math.sin(Math.PI*(p+0)/3)/8,w=
Math.sin(Math.PI*(p+170)/8)/2+Math.sin(Math.PI*(p+130)/3)/8;xa=Math.asin((t-w)/100);wa=(t+w)/2;w=P.pa;t=null;const B=w.transition;B&&(B.Ya+B.Za<p?(w.transition=null,lb(P,B.Na),w=P.pa):t=jb(P,B.Na));const x=t?[w,t]:[w];x.forEach(y=>{{const F=p-y.Db;y.Ba=F-y.l;y.l=F}});J=nb(w);t&&(w=Math.sin(Math.PI/2*((p-B.Ya)/B.Za)),t=nb(t),J={x:J.x*(1-w)+t.x*w,y:J.y*(1-w)+t.y*w,z:J.z*(1-w)+t.z*w});pa(f)%2&&(l=!l,window.ya=l);x.forEach(y=>{{let Z=y.transition;var F=y.j;ta(F.v,y.l);F.state.I(y);if(y.transition&&!Z){Z=
y.transition;{F=jb(P,Z.Na);const za=F.j;za.s=y.j.s;za.F(F,Ua)}}ab(y);Z||y.Ia||Ia(y)}});fb(A,a,x);ia(v,(y,F)=>c(y,F,x));requestAnimationFrame(e)}const d=document.getElementById("fps"),h=document.getElementById("canvas");var g=window.getComputedStyle(h);const f=new ra(document.body);E(f,"left",["a","ArrowLeft"]);E(f,"right",["d","ArrowRight"]);E(f,"showLights",["l"]);E(f,"attack",["f"," "]);E(f,"fullscreen",["u"]);E(f,"up",["w","ArrowUp"]);E(f,"down",["s","ArrowDown"]);E(f,"lightUp",["y"]);E(f,"lightDown",
["h"]);var k=parseInt(g.getPropertyValue("width"),10);g=parseInt(g.getPropertyValue("height"),10);let l=!1;const n=window.devicePixelRatio||1,q=n*k,m=n*g;h.width=q;h.height=m;const u=Wa(k,g),r=h.getContext("webgl2",{antialias:!1,alpha:!1});r.enable(r.BLEND);r.enable(r.DEPTH_TEST);r.depthFunc(r.LEQUAL);k=new D({h:r,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
g=new D({h:r,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const v=new ha({h:r,Y:"projection"});fa(v,k,g).link();const A=new hb(r,q,m,360),H=new $a;k=(p,t)=>la({h:r,name:p,src:t});g=p=>Za(H,p);const [T,U,V]=await Promise.all([Xa(u,k),Da(k,g),Va(k,g)]);k={o:{qa:U,j:V,Ga:T,Ib:cb(r)},input:f,audio:H};const P=new mb(k,kb(k,"start"));let Y=-1,ka=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(ka=null)});let J={x:0,y:0,z:0},xa,wa,ya=Date.now();requestAnimationFrame(e);h.onmousemove=()=>{}};
