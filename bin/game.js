'use strict';class aa{constructor(a,b,c){this.name=c;this.P=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.P}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.P}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ba(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new aa(c[1],c[2],c[3]))});return b}
const ca=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function A(a,b){a.h.uniformMatrix4fv(a.m,!1,b);a.g.push(b)}function D(a,b,c,e=0){var d=a.g;d=d.length?d[d.length-1]:ca;A(a,new Float32Array([d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],b*d[0]+c*d[4]+e*d[8]+d[12],b*d[1]+c*d[5]+e*d[9]+d[13],b*d[2]+c*d[6]+e*d[10]+d[14],b*d[3]+c*d[7]+e*d[11]+d[15]]))}function E(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class da{constructor(a,b){this.h=a;this.m=b;this.g=[];a.uniformMatrix4fv(b,!1,ca)}pop(){return this.g.pop()}push(a){var b=this.g;0===b.length?A(this,a):(b=b[b.length-1],A(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*b[3]+a[5]*b[7]+
a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class F{constructor(a,b){this.name=a.name;var c=this.h=a.h;a=this.type=a.type;switch(a){case "vertex":var e=this.h.VERTEX_SHADER;break;case "fragment":e=this.h.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}e=this.g=c.createShader(e);c.shaderSource(e,b);c.compileShader(e);if(!c.getShaderParameter(e,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(e)}`,c.deleteShader(e),Error(b);this.ab=ba(b)}}
function fa(a,...b){const c=a.h,e=a.va;b.forEach(d=>{a.Ea.push(d);c.attachShader(e,d.g)});return a}class ha{constructor(a){this.name=a.name;this.T=a.T;a=this.h=a.h;this.g=!1;this.va=a.createProgram();this.Ea=[];this.K={};this.L={};this.stack=null}link(){if(this.g)return this;var a=this.h,b=this.va;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.g=!0;return this}}
function ia(a,b){var c=a.h,e=a.va;c.useProgram(e);for(var d={},h={},g=a.Ea,f=0;f<g.length;f++)for(var k=g[f].ab,l=0;l<k.length;l++){var n=k[l];1===n.type?n.P in d||(d[n.name]=c.getUniformLocation(e,n.P)):n.P in h||(h[n.name]=c.getAttribLocation(e,n.P))}a.K=d;a.L=h;if(e=a.T)if(e in a.K)a.stack=new da(c,a.K[e]);else throw Error(`No anchor point "${e}" in program`);try{b(c,a)}finally{a.K={},a.L={},a.stack=null}}
class G{constructor(a,b,c,e,d){this.h=a;this.name=b;this.w=c;this.j=e;this.g=d(a)}bindTexture(){this.h.bindTexture(this.h.TEXTURE_2D,this.g)}}function ja(a){return(new Promise((b,c)=>{const e=new Image;e.onload=()=>void b(e);e.onerror=()=>{c(Error(`failed to load ${a.src}`))};e.mode="no-cors";e.src=a.src})).then(b=>{const c=b.naturalWidth,e=b.naturalHeight;return new G(a.h,a.name,c,e,ka(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,e,0,d.RGBA,d.UNSIGNED_BYTE,b)}))})}
function la(a){const b=a.width,c=a.height;return new G(a.h,a.name,b,c,ka(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,b,c,0,e.RGBA,e.UNSIGNED_BYTE,a.Fa,0)}))}function ma(a){return new G(a.h,a.name,a.width,a.height,()=>a.J)}
function ka(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function K(a,b){const c=a.g.h;let e=a.m;null!=e?c.bindBuffer(c.ARRAY_BUFFER,e):(a.m=e=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,e),c.bufferData(c.ARRAY_BUFFER,a.N,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.g.bindTexture();c.uniform1i(b.K.texture,0);c.enableVertexAttribArray(b.L.texturePosition);c.vertexAttribPointer(b.L.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.L.position);c.vertexAttribPointer(b.L.position,3,c.FLOAT,!1,20,0)}
function L(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.g.h;const e=b.wa;a.drawArrays(a.TRIANGLE_STRIP,e[c%e.length],b.vb)}
class M{constructor(a,b){this.g=a;this.m=null;a=this.data={};const c=[];let e=0;for(const d in b){const h=b[d],g=[],f=h.length;if(0===f)throw Error("Sprite declared with 0 points");const k=h[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const l=k/5;for(let n=0;n<f;n++){const t=h[n];if(t.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");g.push(e);c.push.apply(c,t);e+=l}a[d]={Gb:this,name:d,wa:g,vb:l}}this.N=new Float32Array(c)}}
function na(a,b){for(var c=a.B;-1!==c&&c<=b;){c=a.N;const e=a.G+1;e===c.length?a.m===a.ob?a.B=c=-1:(a.m++,a.G=0,a.B=c=b+c[0]):(a.G=e,a.B=c=b+c[e])}}class oa{constructor(a,b,c,e){const d=a.A;this.Ka=a.name;this.ha=a.na;this.g=c;this.ob="number"===typeof d?d:d?-1:0;this.La=a.set;this.N=b;this.G=this.m=0;this.B=e+b[0];this.mb=a.wb}ga(){const a=this.mb;return null!=a?a[this.G]:void 0}U(a){K(this.La,a);L(this.La,this.g,this.G)}name(){return this.Ka}toString(){return`Sprite/${this.Ka}`}}
function pa(a){const b=a.name,c=a.v,e=a.set.data;let d=-1;a.na.forEach(g=>{const f=e[g];if(!f)throw Error(`Sprite/${b} has non-existent mode ${g}`);if(-1===d)d=f.wa.length;else if(d!==f.wa.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===d)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==d)throw Error(`Sprite/${b} given ${c.length} frame times for ${d} frames`);if(a.ga&&a.ga.length!==d)throw Error(`Sprite/${b} given ${a.ga.length} frame data points for ${d} frames`);
const h="number"===typeof c?Array(d).fill(c):c;return(g,f)=>new oa(a,h,g,f)}function N({x:a=0,y:b=0,z:c=0,width:e,height:d,ua:h,ta:g,oa:f,count:k,Mb:l=0,Nb:n=0,Ob:t=h,Lb:m=g,Z:p=!1}){const v=[];for(let r=0;r<k;r++){const z=l+r%f*t,J=n+Math.floor(r/f)*m;v.push(qa({x:a,y:b,z:c,width:e,height:d,Za:z,Xa:z+h,$a:J,Ya:J+g,Z:p}))}return v}
function qa({x:a=0,y:b=0,z:c=0,width:e,height:d,depth:h=0,Za:g,$a:f,Xa:k,Ya:l,Z:n=!1}){n?(n=k,k=a-e):(n=g,g=k,k=-a,a=e-a);return[a,-b,-c,g,l,k,-b,-c,n,l,a,h-b,d-c,g,f,k,h-b,d-c,n,f]};function P(a,b,c){a=a.m;null!=c?a.set(b,c):a.delete(b)}function Q(a,b){b=a.m.get(b);const c=a.g;return!!b&&!!b.some(e=>(e=c.get(e))?(e.ea=0,null!=e.ia):!1)}function ra(a){const b=a.m.get("showLights");if(b){const c=a.g;return b.reduce((e,d)=>(d=c.get(d))?(e+=d.ea,d.ea=0,e):e,0)}return 0}class sa{constructor(a){this.g=new Map;this.m=new Map;a.addEventListener("keydown",b=>{xa(this,b,!0)});a.addEventListener("keyup",b=>{xa(this,b,!1)});a.onblur=()=>{this.g.clear()};a.onfocus=()=>{this.g.clear()}}}
function xa(a,b,c){b=b.key;a=a.g;const e=a.get(b);c?null==e?a.set(b,{ia:Date.now(),ea:1}):(null==e.ia&&(e.ia=Date.now()),e.ea++):null!=e&&(e.ia=null)};function ya(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const za=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function Aa(a){const [b,c,e]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png")]);var d=new M(b,{blink:N({x:.25,z:.25,width:.5,height:.5,ua:108/b.w,ta:108/b.j,oa:2,count:6,Z:!0})});a=pa({name:"creature_attack",set:new M(e,{bite:N({x:.5,z:.75,width:1,height:2,ta:530/e.j,ua:278/e.w,oa:7,count:42,Z:!0})}),na:["bite"],A:!0,v:1/12});var h=Array(6).fill(.125);h[0]=4;d=pa({name:"creature_normal",set:d,na:["blink"],A:!0,
v:h});h=[];var g=92,f=-22;const k=Math.sqrt(g*g+f*f);g/=k;f/=k;for(let l=0;29>l;l++){const n=l%5,t=Math.floor(l/5),m=[],p=(v,r)=>{const z=100*v,J=77*r-48;m.push((z*g+J*f)/k,v,(z*-f+J*g)/360,100*(n+v)/c.w,77*(t+r)/c.j)};p(1,1);p(0,1);p(1,0);p(0,0);h.push(m)}h=new M(c,{wiggle:h});return{rb:d,Hb:a,Db:h}}class Ba{constructor(a,b,c,e){a=a.o.Ga.rb("blink",a.i);this.x=this.Cb=b;this.y=c;this.z=e;this.Ra=this.Sa=0;this.Da=[R(0,b,c,-1,1),R(1,b,c,-1,-1),R(2,b,c,1,1),R(3,b,c,1,-1)];this.u=a}}
function Ca(a){const b=a.i;a.da.forEach(c=>{c.x=c.Cb+Math.sin(b);var e=.5*Math.cos(b);na(c.u,a.i);if(b>c.Sa){var d=c.Ra;c.Ra=(d+1)%c.Da.length;d=c.Da[d];e=c.x+.225*e+d.kb;.05<Math.abs(e-d.pa)&&(c.Sa=b+.125,d.Qa=b+.125,d.Na=d.pa,d.Oa=d.za,d.Pa=d.Aa,d.pa=e,d.za=c.y+d.lb,d.Aa=0)}})}
function Da(a,b){const c=a.stack,e=b.o.Ga.Db,d=b.i,{x:h,z:g}={x:b.l.s,z:1.7};b.da.forEach(f=>{var k=f.x;const l=f.z;D(c,k,f.y,l);let n=h<k;k=ya(g-l,h-k);n&&(c.push(za),k=Math.PI-k);E(c,k);f.u.U(a);c.pop();n&&c.pop();c.pop()});K(e,a);b.da.forEach(f=>{const k=f.z-.1875;f.Da.forEach(l=>{var n=f.x+l.bb,t=f.y+l.cb;let m=l.pa,p=l.za,v=l.Aa;var r=l.Qa;d<r&&(r=1-(r-d)/.125,m=Ea(r,l.Na,n,m),p=Ea(r,l.Oa,t,p),v=Ea(r,l.Pa,k,v));n-=m;t-=p;r=k-v;const z=Math.sqrt(n*n+t*t+r*r);D(c,m,p,v);E(c,ya(r,n));c.push(new Float32Array([z,
0,0,0,0,t,0,0,0,0,1,0,0,0,0,1]));L(e,"wiggle",Math.abs((Math.floor(24*d)+l.ib)%57+1-29));c.pop();c.pop();c.pop()})})}function R(a,b,c,e,d){const h=.4*e;d=.1*d;b+=h;c+=d;return{index:a,bb:.05*e,cb:0,kb:h,lb:d,Qa:0,Na:b,Oa:c,Pa:0,pa:b,za:c,Aa:0,ib:0}}function Ea(a,b,c,e){return a*(a*e+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};const Fa=434/1.8,S=405/Fa;function T(a,b,c){c=c(a,b);a.state=c;c.S(b)}function Ga(a){return(a=a.u.ga())?a.Ja:null}function U(a,b){a.Wa=b;0!==b&&(a.ra=Math.sign(b))}function V(a,b,c,e=-1===a.ra?"left":"right"){a.u=b(e,c)}
class Ha{constructor(a,b,c){this.s=b;this.ja=0;this.ka=c;this.ra=1;this.Wa=0;this.u=a.ya("right",0);this.state={name:"unstarted",S:e=>T(this,e,Y),U:()=>{throw Error("Hero did not get processed before rendering!");}}}U(a,b){a=b.stack;D(a,this.s,this.ja,this.ka);this.u.U(b);a.pop()}}
function Y(a,b){let c=!0;V(a,b.o.l.ya,b.i);return{name:"normal",S:e=>{const d=e.l,h=e.i;var g=e.input;if("r0"===e.name&&Q(g,"up"))T(d,e,Ia);else if(Q(g,"attack"))T(d,e,Ja);else{var f=1.2*e.sa;{const k=Q(g,"left")?1:0;g=(Q(g,"right")?1:0)-k}f*=g;g=d.s+f;g<e.F+S?f=e.F+S-d.s:g>e.I-S&&(f=e.I-S-d.s);U(d,f/e.sa);g=-1===d.ra?"left":"right";f?(d.s+=f,c&&(c=!1,V(d,e.o.l.tb,h))):c||(c=!0,V(d,e.o.l.ya,h));e=d.u;if(g!==e.g){if(!e.ha.includes(g))throw Error(`${e} does not have mode ${g}`);e.g=g}}},qa:null}}
function Ja(a,b){V(a,b.o.l.pb,b.i);U(a,0);const c=b.o.l.jb;Ka(b.audio,a,c[Math.floor(Math.random()*c.length)]);return{name:"attacking",S:e=>{-1===a.u.B&&T(a,e,Y)},qa:null}}function Ia(a,b){V(a,b.o.l.qb,b.i,"up");U(a,0);a.ja=.75;b.transition={Ba:"r1",Pb:"up",Ua:Date.now()/1E3,Va:1};return{name:"climbing",S:c=>{-1===a.u.B?(a.ja=0,a.ka=c.D,T(a,c,Y)):a.ka=c.D+.3*Math.min(5,a.u.G)},qa:null}}
function La(a,b){const c=b.i;V(a,b.o.l.sb,b.i,"exit");U(a,0);b.xa++;return{name:"entering_hatch",S:()=>{const e=a.u;if(b.i<c+1){var d=b.i;if(!e.ha.includes("exit"))throw Error(`${e} does not have mode ${"exit"}`);e.m=0;e.g="exit";e.G=0;e.B=d+e.N[0]}else-1===e.B&&(b.xa--,T(a,b,Y))},qa:(e,d)=>{b.i<c+1||a.U(e,d,b)}}}
async function Ma(a,b){const [c,e,d,h,g,f]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),a("hero_climbing","assets/Climbing Up.png"),a("hero_hatch","assets/climbing_in.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")])]);a={name:"hero_hatch_enter",J:g,aa:350,Y:406,ba:161,ca:479,X:6,A:!1,v:.125,O:[{c:201,f:137,a:172,b:175},{c:422,f:246,a:461,b:259},
{c:67,f:659,a:113,b:651},{c:419,f:658,a:462,b:648},{c:80,f:1041,a:106,b:1067},null],$:"enter"};return{jb:f,ya:Z({name:"hero_idle",J:c,aa:405,Y:434,ba:220,ca:434,X:16,A:!0,v:1/12,O:[{c:388,f:104,a:385,b:170},{c:792,f:105,a:790,b:170},{c:1198,f:105,a:1195,b:169},{c:1602,f:106,a:1600,b:170},{c:2008,f:106,a:2005,b:172},{c:388,f:539,a:385,b:604},{c:794,f:540,a:790,b:605},{c:1196,f:539,a:1196,b:604},{c:1602,f:539,a:1602,b:604},{c:2009,f:541,a:2007,b:604},{c:386,f:974,a:385,b:1036},{c:792,f:972,a:790,b:1033},
{c:1198,f:974,a:1196,b:1038},{c:1602,f:972,a:1601,b:1036},{c:2010,f:974,a:2005,b:1044},{c:386,f:1406,a:385,b:1477}]}),tb:Z({name:"hero_walk",J:e,aa:424,Y:444,ba:258,ca:444,X:8,A:!0,v:.125,O:[{c:408,f:110,a:404,b:166},{c:830,f:110,a:829,b:166},{c:408,f:554,a:404,b:614},{c:830,f:554,a:829,b:614},{c:408,f:998,a:404,b:1055},{c:830,f:998,a:829,b:1055},{c:408,f:1444,a:404,b:1500},{c:830,f:1444,a:829,b:1500}]}),pb:Z({name:"hero_attack",J:d,aa:644,Y:565,ba:284,ca:565,X:5,A:!1,v:1/12,O:[{c:422,f:285,a:415,
b:353},{c:936,f:367,a:868,b:380},{c:1507,f:311,a:1469,b:318},{c:162,f:948,a:206,b:943},{c:1025,f:934,a:976,b:962}]}),qb:Z({name:"hero_climbing_up",J:h,aa:222,Y:412,ba:110,ca:412,X:8,A:!1,v:.125,O:[{c:128,f:60,a:65,b:54},{c:329,f:155,a:277,b:148},{c:579,f:58,a:518,b:56},{c:772,f:157,a:721,b:156},{c:95,f:575,a:65,b:567},{c:337,f:472,a:286,b:465},null,null],$:"up",scale:1.4}),Ib:Z(a),sb:Z({...a,name:"hero_hatch_exit",$:"exit",xb:!0})}}
function Z(a){var b=a.J;const c=a.aa,e=a.Y,d=a.ba,h=a.ca,g=a.xb?m=>[...m].reverse():m=>m,f=Fa/(a.scale||1),k=Math.floor(b.w/c),l={x:d/f,z:(e-h)/f,width:c/f,height:e/f,ua:c/b.w,ta:e/b.j,oa:k,count:a.X},n=a.O&&a.O.map((m,p)=>{if(!m)return{Ja:null};const v=m.c,r=m.f;return{Ja:{x:(v-(p%k*c+d))/f,z:(Math.floor(p/k)*e+h-r)/f,angle:ya(-(r-m.b),v-m.a)}}});let t;a.$?(t=[a.$],b=new M(b,{[a.$]:g(N(l))})):(t=["left","right"],b=new M(b,{right:g(N(l)),left:g(N({...l,Z:!0}))}));return pa({name:a.name,set:b,na:t,
A:a.A,v:a.v,wb:n&&g(n)})};function Na(a,b){var c=376/b;const e=c/(484/b),d=c/(268/b);c/=1.25;a=b/a*c;return{ub:new Float32Array([a,0,0,0,0,0,1/1.5,(d-e)/1.5,0,c,0,0,0,0,0,(e+d)/2]),Rb:e,Qb:d,Jb:a,Kb:c,ma:554/b*e/c-1.25,R:.3}}
async function Oa(a,b){const [c,e,d,h,g]=await Promise.all([b("ladder","assets/ladder.png"),b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png")]);b=2.5*c.w/c.j;b=new M(c,{main:[qa({x:b/2,y:-.75,width:b,height:2.5,Za:0,$a:.5,Xa:1,Ya:1})]});return{T:a,Fb:e,hb:d,fb:h,Ab:g,nb:b}}
function Pa({Fb:a,hb:b,fb:c,Ab:e,T:d},h,g){const f=g-d.R;g=g+h+d.R;var k=494/a.j,l=1016/a.j,n=(l-k)*a.j/2.5*h/a.w;a=new M(a,{main:[[g,.75,2.5,n,k,g,.75,0,n,l,f,.75,2.5,0,k,f,.75,0,0,l]]});k=110/b.j;l=220/b.j;n=(l-k)*b.j/1.5*h/b.w;b=new M(b,{main:[[g,-.75,-d.ma,n,1,f,-.75,-d.ma,0,1,g,-.75,0,n,l,f,-.75,0,0,l,g,.75,0,n,k,f,.75,0,0,k]]});k=144/c.j;l=32/c.j;h=(l-k)*c.j/1.5*h/c.w;c=new M(c,{main:[[g,-.75,2.5+d.ma,h,0,f,-.75,2.5+d.ma,0,0,g,-.75,2.5,h,l,f,-.75,2.5,0,l,g,.75,2.5,h,k,f,.75,2.5,0,k]]});h=438/
e.w;k=318/e.w;l=194/e.j;n=1164/e.j;const t=84/e.w;d=[f,-.75,2.5,h,l,f,-.75,0,h,n,f+d.R,-.75,2.5,k,l,f+d.R,-.75,0,k,n,f+d.R,.75,2.5,t,414/e.j,f+d.R,.75,0,t,964/e.j];h=[];for(k=0;k<d.length;k+=5)h.push(g+(f-d[k]),d[k+1],d[k+2],d[k+3],d[k+4]);e=new M(e,{right:[h],left:[d]});return{Eb:a,gb:b,eb:c,zb:e}};function Ka(a,b,c){const e=a.m;var d=e.get(b);d&&d.stop();a=a.g;d=a.createBufferSource();d.buffer=c;d.connect(a.destination);d.start();e.set(b,d)}function Qa(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.g.decodeAudioData(c))}class Ra{constructor(){this.g=new AudioContext;this.m=new WeakMap}};function Sa(a){const b=a.i,c=a.sa,e=a.l,d=a.Ca,h=Math.floor(48*b)-Math.floor(48*(b-c));for(let m=0;m<h;m++){var g=2*Math.random()+1.4;let p=.1*Math.sin(2*Math.PI*Math.random());var f=Ga(e);if(!f)break;const v=e.s+f.x*e.ra,r=f.z+e.ka,z=Math.PI/4*(Math.random()-.5)+f.angle;f=g*Math.sin(z);g=g*Math.cos(z)+e.Wa;100<d.length&&d.pop();d.push({C:!1,x:v,y:e.ja+.01,z:r,H:g,W:p,M:f,startTime:b,Ha:b+1.5,Ta:!1})}const k=a.D,l=9.8*c,n=0*c,t=1-.8*c;d.forEach(m=>{var p=m.C;if(!p&&b<m.Ha){m.x+=m.H*c;m.y+=m.W*c;m.z+=
m.M*c;p=m.M;m.Ta?(m.H*=t,m.W*=t):(p-=l,m.H-=n,m.M=p);if(m.x<a.F||m.x>a.I)m.C=!0;const v=m.y;if(-.75>v||.75<v){const r=0<v?.75:-.75;m.y=r+(r-v);m.W=-m.W}m.z<k&&(-.01<p?(m.z=k,m.M=0,m.Ta=!0):(m.z=k+k-m.z,m.M=-.25*p))}else p||(m.C=!0)});d.sort(Ta)}
function Ua(a){const b=1/18/18,c=h=>Math.max(0,Math.min(255,Math.round(256*(1-b*h*h)))),e=[];for(let h=0;2>h;h++)for(let g=0;18>g;g++)for(let f=0;2>f;f++){let k;var d=void 0;let l;d=g+6*f;18>d?(k=255,d=c(d),l=255):l=d=k=0;c(g+6*f);c(g+6*f+1);for(let n=0;2>n;n++)e.push(k,d,d,l)}a=la({name:"spark",width:72,height:2,h:a,Fa:new Uint8Array(e)});return new M(a,{fading:N({x:1/180,width:.04,height:2/180,ua:1/18,ta:1,oa:18,count:18})})}function Ta(a,b){return a.C?b.C?0:1:b.C?-1:a.y-b.y}
function Va(a,b){const c=b.o.Bb,e=a.stack;K(c,a);b.Ca.forEach(d=>{d.C||(D(e,d.x,d.y,d.z),E(e,(0<=d.H?Math.PI:0)+Math.atan(d.M/d.H)),L(c,"fading",Math.floor(12*(b.i-d.startTime))),e.pop(),e.pop())})};function Wa(a){const b=a.F,c=a.I,e=a.D,d=a.la;return{name:a.name,o:d.o,input:d.input,audio:d.audio,da:[],i:0,yb:Date.now()/1E3-1/60,sa:0,F:b,I:c,D:e,fa:Pa(d.o.Ia,c-b,b),Ca:[],Ma:!1,l:new Ha(d.o.l,(c+b)/2,e),transition:null,xa:0}};function Xa(a,b,c){const e=a.g.h,d=a.m;e.bindFramebuffer(e.FRAMEBUFFER,a.ha);e.viewport(0,0,d.w,d.j);ia(a.g,(h,g)=>{Ya(h,g,b,a,c)})}
class Za{constructor(a,b,c,e){b/=4;c/=4;var d=new F({h:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  vec4 position = u_projection * vec4(a_position, 1);\n  // float inverse = 1.f / (1.f - position.z * .2f);\n\n  // vec4 result = vec4(position.x, -inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n  // gl_Position = result;\n  gl_Position = position;\n  \n  v_texturePosition = a_texturePosition;\n}"),h=
new F({h:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    color.a -= u_threshold;\n    if (color.a <= u_threshold) {\n        discard;\n    }\n    output_color = color;\n}");const g=new ha({h:a,T:"projection"});fa(g,d,h).link();d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,
0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);h=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,h);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.bindFramebuffer(a.FRAMEBUFFER,null);const f=128/e;e=la({name:"fade",width:64,height:64,h:a,Fa:$a(e)});this.g=g;this.m=ma({J:d,name:"lighting",
width:b,height:c,h:a});this.ha=h;this.N=new M(e,{main:[[f,0,-f,1,0,f,0,f,1,1,-f,0,-f,0,0,-f,0,f,0,1]]})}}function Ya(a,b,c,e,d){a.blendFunc(a.ONE,a.ONE);d[0].Ma?a.clearColor(0,0,0,1):a.clearColor(0,0,0,window.g);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);c(b.stack,()=>{const h=e.N;K(h,b);const g=b.K.threshold;d.forEach(f=>{const k=f.i;f.Ca.forEach(l=>{if(!l.C){var n=l.startTime;n=(k-n)/(l.Ha-n);a.uniform1f(g,.5*n*n);D(b.stack,l.x,l.y,l.z);L(h,"main",0);b.stack.pop()}})})})}
function $a(a){const b=new Uint8Array(16384),c=(h,g)=>{h/=a;g/=a;return h*h+g*g},e=Math.min(c(32,0),c(32,0));for(let h=0;64>h;h++)for(let g=0;64>g;g++){const f=4*(64*h+g);var d=c(g-32,h-32);const k=1-Math.sqrt(d/e);d=1E-4>=d?5:0;const l=Math.max(Math.round(255*k*k),0);b[f]=d+Math.max(Math.round(20*k),0);b[f+1]=d;b[f+2]=d;b[f+3]=l}return b};function ab(a,b){const c=a.g;let e=c.get(b);e||(e=bb(a.la,b),c.set(b,e));return e}function cb(a,b){a.V.name!==b&&(a.V=ab(a,b))}class db{constructor(a,b){this.la=a;this.g=new Map([[b.name,b]]);this.V=b}}function bb(a,b){switch(b){case "r0":return a=Wa({la:a,name:b,F:0,I:12,D:0}),b=a.l,b.s=a.F+4,a.da.push(new Ba(a,b.s+2,0,.75)),a;case "r1":return Wa({la:a,name:b,F:-12,I:10,D:4.5});default:throw Error(`Unrecognized room name "${b}"`);}}
function eb(a){return{x:Math.min(Math.max(a.l.s,a.F+1),a.I-1),y:0,z:a.D+1.25}};window.g=.1;
window.onload=async function(){function a(q,w){q.push(m.ub);D(q,-H.x,-H.y,-H.z);E(q,ta);D(q,0,0,ua);w();q.pop();q.pop();q.pop()}function b(q,w,C){q.bindFramebuffer(q.FRAMEBUFFER,null);q.viewport(0,0,n,t);q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA);q.clearColor(0,0,0,1);q.clear(q.COLOR_BUFFER_BIT|q.DEPTH_BUFFER_BIT);q.activeTexture(q.TEXTURE1);r.m.bindTexture();q.uniform1i(w.K.lighting,1);q.activeTexture(q.TEXTURE0);a(w.stack,()=>{C.forEach(u=>{{const x=w.stack;D(x,0,0,u.D);var y=u.fa.Eb;K(y,w);
L(y,"main",0);y=u.fa.gb;K(y,w);L(y,"main",0);y=u.fa.eb;K(y,w);L(y,"main",0);y=u.fa.zb;K(y,w);L(y,"left",0);L(y,"right",0);D(x,2,0,0);y=u.o.Ia.nb;K(y,w);L(y,"main",0);x.pop();x.pop();(y=u.l.state.qa)?y(q,w):u.l.U(q,w,u);Da(w,u);Va(w,u);x.pop()}})})}function c(){!ea&&Q(g,"fullscreen")&&(ea=d.requestFullscreen());const q=Date.now()/1E3;W=-1===W?60:.125/(q-va)+.875*W;e.innerHTML=`fps=${Math.round(W)}`;va=q;let w=O.V;var C=null,u=w.transition;u&&(u.Ua+u.Va<q?(w.transition=null,cb(O,u.Ba),w=O.V):C=ab(O,
u.Ba));const y=C?[w,C]:[w];y.forEach(x=>{{const B=q-x.yb;x.sa=B-x.i;x.i=B}});H=eb(w);C&&(u=Math.sin(Math.PI/2*((q-u.Ua)/u.Va)),C=eb(C),H={x:H.x*(1-u)+C.x*u,y:H.y*(1-u)+C.y*u,z:H.z*(1-u)+C.z*u});ra(g)%2&&(k=!k,w.Ma=k);y.forEach(x=>{var B=Math.sin(Math.PI*(X.i+0)/8)/2+Math.sin(Math.PI*(X.i+0)/3)/8,I=Math.sin(Math.PI*(X.i+170)/8)/2+Math.sin(Math.PI*(X.i+130)/3)/8;ta=Math.asin((B-I)/100);ua=(B+I)/2;B=x.transition;I=x.l;na(I.u,x.i);I.state.S(x);if(x.transition&&!B){B=x.transition;{I=ab(O,B.Ba);const wa=
I.l;wa.s=x.l.s;T(wa,I,La)}}Sa(x);B||x.xa||Ca(x)});Xa(r,a,y);ia(v,(x,B)=>b(x,B,y));requestAnimationFrame(c)}const e=document.getElementById("fps"),d=document.getElementById("canvas");var h=window.getComputedStyle(d);const g=new sa(document.body);P(g,"left",["a","ArrowLeft"]);P(g,"right",["d","ArrowRight"]);P(g,"showLights",["l"]);P(g,"attack",["f"," "]);P(g,"fullscreen",["u"]);P(g,"up",["w","ArrowUp"]);P(g,"down",["s","ArrowDown"]);P(g,"lightUp",["y"]);P(g,"lightDown",["h"]);var f=parseInt(h.getPropertyValue("width"),
10);h=parseInt(h.getPropertyValue("height"),10);let k=!1;const l=window.devicePixelRatio||1,n=l*f,t=l*h;d.width=n;d.height=t;const m=Na(f,h),p=d.getContext("webgl2",{antialias:!1,alpha:!1});p.enable(p.BLEND);p.enable(p.DEPTH_TEST);p.depthFunc(p.LEQUAL);f=new F({h:p,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
h=new F({h:p,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const v=new ha({h:p,T:"projection"});fa(v,f,h).link();const r=new Za(p,n,t,360),z=new Ra;f=(q,w)=>ja({h:p,name:q,src:w});const [J,fb,gb]=await Promise.all([Oa(m,f),Aa(f),Ma(f,q=>Qa(z,q))]);f={o:{Ga:fb,l:gb,Ia:J,Bb:Ua(p)},input:g,audio:z};const O=new db(f,bb(f,"r0"));let X=O.V,W=-1,ea=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(ea=null)});let H={x:0,y:0,z:0},ta,ua,va=Date.now();requestAnimationFrame(c);d.onmousemove=()=>{}};
