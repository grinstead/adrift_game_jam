'use strict';class aa{constructor(a,b,c){this.name=c;this.aa=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.aa}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.aa}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ba(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new aa(c[1],c[2],c[3]))});return b}
const ca=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function A(a,b){a.h.uniformMatrix4fv(a.l,!1,b);a.g.push(b)}function C(a,b,c,e=0){var d=a.g;d=d.length?d[d.length-1]:ca;A(a,new Float32Array([d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],b*d[0]+c*d[4]+e*d[8]+d[12],b*d[1]+c*d[5]+e*d[9]+d[13],b*d[2]+c*d[6]+e*d[10]+d[14],b*d[3]+c*d[7]+e*d[11]+d[15]]))}function D(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class da{constructor(a,b){this.h=a;this.l=b;this.g=[];a.uniformMatrix4fv(b,!1,ca)}depth(){return this.g.length}pop(){return this.g.pop()}push(a){var b=this.g;0===b.length?A(this,a):(b=b[b.length-1],A(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+
a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class E{constructor(a,b){this.name=a.name;var c=this.h=a.h;a=this.type=a.type;switch(a){case "vertex":var e=this.h.VERTEX_SHADER;break;case "fragment":e=this.h.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}e=this.g=c.createShader(e);c.shaderSource(e,b);c.compileShader(e);if(!c.getShaderParameter(e,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(e)}`,c.deleteShader(e),Error(b);this.$a=ba(b)}}
function ea(a,...b){const c=a.h,e=a.Aa;b.forEach(d=>{a.La.push(d);c.attachShader(e,d.g)});return a}class fa{constructor(a){this.name=a.name;this.V=a.V;a=this.h=a.h;this.g=!1;this.Aa=a.createProgram();this.La=[];this.S={};this.Y={};this.stack=null}link(){if(this.g)return this;var a=this.h,b=this.Aa;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.g=!0;return this}}
function ia(a,b){var c=a.h,e=a.Aa;c.useProgram(e);for(var d={},h={},g=a.La,f=0;f<g.length;f++)for(var k=g[f].$a,m=0;m<k.length;m++){var n=k[m];1===n.type?n.aa in d||(d[n.name]=c.getUniformLocation(e,n.aa)):n.aa in h||(h[n.name]=c.getAttribLocation(e,n.aa))}a.S=d;a.Y=h;if(e=a.V)if(e in a.S)a.stack=new da(c,a.S[e]);else throw Error(`No anchor point "${e}" in program`);try{b(c,a)}finally{a.S={},a.Y={},a.stack=null}}
class ja{constructor(a,b,c,e,d){this.h=a;this.name=b;this.w=c;this.i=e;this.g=d(a)}bindTexture(){this.h.bindTexture(this.h.TEXTURE_2D,this.g)}}function ka(a){return(new Promise((b,c)=>{const e=new Image;e.onload=()=>void b(e);e.onerror=()=>{c(Error(`failed to load ${a.src}`))};e.mode="no-cors";e.src=a.src})).then(b=>{const c=b.naturalWidth,e=b.naturalHeight;return new ja(a.h,a.name,c,e,la(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,e,0,d.RGBA,d.UNSIGNED_BYTE,b)}))})}
function ma(a){const b=a.width,c=a.height;return new ja(a.h,a.name,b,c,la(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,b,c,0,e.RGBA,e.UNSIGNED_BYTE,a.Ca,0)}))}function na(a){return new ja(a.h,a.name,a.width,a.height,()=>a.X)}
function la(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function F(a,b,c){a=a.l;null!=c?a.set(b,c):a.delete(b)}function G(a,b){b=a.l.get(b);const c=a.g;return!!b&&!!b.some(e=>(e=c.get(e))?(e.qa=0,null!=e.ua):!1)}function oa(a){const b=a.l.get("showLights");if(b){const c=a.g;return b.reduce((e,d)=>(d=c.get(d))?(e+=d.qa,d.qa=0,e):e,0)}return 0}class pa{constructor(a){this.g=new Map;this.l=new Map;a.addEventListener("keydown",b=>{qa(this,b,!0)});a.addEventListener("keyup",b=>{qa(this,b,!1)});a.onblur=()=>{this.g.clear()};a.onfocus=()=>{this.g.clear()}}}
function qa(a,b,c){b=b.key;a=a.g;const e=a.get(b);c?null==e?a.set(b,{ua:Date.now(),qa:1}):(null==e.ua&&(e.ua=Date.now()),e.qa++):null!=e&&(e.ua=null)};function K(a,b){const c=a.g.h;let e=a.l;null!=e?c.bindBuffer(c.ARRAY_BUFFER,e):(a.l=e=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,e),c.bufferData(c.ARRAY_BUFFER,a.O,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.g.bindTexture();c.uniform1i(b.S.texture,0);c.enableVertexAttribArray(b.Y.texturePosition);c.vertexAttribPointer(b.Y.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.Y.position);c.vertexAttribPointer(b.Y.position,3,c.FLOAT,!1,20,0)}
function M(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.g.h;const e=b.Ba;a.drawArrays(a.TRIANGLE_STRIP,e[c%e.length],b.wb)}
class N{constructor(a,b){this.g=a;this.l=null;a=this.data={};const c=[];let e=0;for(const d in b){const h=b[d],g=[],f=h.length;if(0===f)throw Error("Sprite declared with 0 points");const k=h[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const m=k/5;for(let n=0;n<f;n++){const p=h[n];if(p.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");g.push(e);c.push.apply(c,p);e+=m}a[d]={Pb:this,name:d,Ba:g,wb:m}}this.O=new Float32Array(c)}}
function ra(a,b){for(var c=a.J;-1!==c&&c<=b;){c=a.O;const e=a.I+1;e===c.length?a.l===a.ob?a.J=c=-1:(a.l++,a.I=0,a.J=c=b+c[0]):(a.I=e,a.J=c=b+c[e])}}class sa{constructor(a,b,c,e){const d=a.D;this.wa=a.name;this.ta=a.ja;this.g=c;this.ob="number"===typeof d?d:d?-1:0;this.Pa=a.set;this.O=b;this.I=this.l=0;this.J=e+b[0];this.nb=a.xb}sa(){const a=this.nb;return null!=a?a[this.I]:void 0}da(a){K(this.Pa,a);M(this.Pa,this.g,this.I)}name(){return this.wa}toString(){return`Sprite/${this.wa}`}}
function O(a){const b=a.name,c=a.C,e=a.set.data;let d=-1;a.ja.forEach(g=>{const f=e[g];if(!f)throw Error(`Sprite/${b} has non-existent mode ${g}`);if(-1===d)d=f.Ba.length;else if(d!==f.Ba.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===d)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==d)throw Error(`Sprite/${b} given ${c.length} frame times for ${d} frames`);if(a.sa&&a.sa.length!==d)throw Error(`Sprite/${b} given ${a.sa.length} frame data points for ${d} frames`);
const h="number"===typeof c?Array(d).fill(c):c;return(g,f)=>new sa(a,h,g,f)}function P({x:a=0,y:b=0,z:c=0,width:e,height:d,ga:h,fa:g,ca:f,count:k,Vb:m=0,Wb:n=0,Xb:p=h,Ub:l=g,ea:q=!1}){const x=[];for(let u=0;u<k;u++){const B=m+u%f*p,H=n+Math.floor(u/f)*l;x.push(ta({x:a,y:b,z:c,width:e,height:d,Jb:B,Hb:B+h,Kb:H,Ib:H+g,ea:q}))}return x}
function ta({x:a=0,y:b=0,z:c=0,width:e,height:d,depth:h=0,Jb:g,Kb:f,Hb:k,Ib:m,ea:n=!1}){n?(n=k,k=a-e):(n=g,g=k,k=-a,a=e-a);return[a,-b,-c,g,m,k,-b,-c,n,m,a,h-b,d-c,g,f,k,h-b,d-c,n,f]};function ya(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const za=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function Aa(a,b){const [c,e,d,h,g]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png"),b("assets/Enemy Dying.mp3"),a("creature_death","assets/Enemy Dying.png")]);var f=new N(c,{blink:P({x:.25,z:.25,width:.5,height:.5,ga:108/c.w,fa:108/c.i,ca:2,count:6,ea:!0})});a=O({name:"creature_attack",set:new N(d,{bite:P({x:.5,z:.75,width:1,height:2,fa:530/d.i,ga:278/d.w,ca:7,count:42,ea:!0})}),ja:["bite"],D:!0,C:1/12});b=O({name:"creature_death",
set:new N(g,{left:P({x:330/(460/1.8),y:.375,z:0,width:660/(460/1.8),height:1.8,ga:660/g.w,fa:460/g.i,ca:3,count:12}),right:P({x:1.32,y:.375,z:0,width:2.64,height:1.8,ga:660/g.w,fa:450/g.i,ca:3,count:12,ea:!0})}),ja:["left","right"],D:!1,C:.125});var k=Array(6).fill(.125);k[0]=4;f=O({name:"creature_normal",set:f,ja:["blink"],D:!0,C:k});k=[];var m=92,n=-22;const p=Math.sqrt(m*m+n*n);m/=p;n/=p;for(let l=0;29>l;l++){const q=l%5,x=Math.floor(l/5),u=[],B=(H,Q)=>{const R=100*H,I=77*Q-48;u.push((R*m+I*n)/
p,H,(R*-n+I*m)/360,100*(q+H)/e.w,77*(x+Q)/e.i)};B(1,1);B(0,1);B(1,0);B(0,0);k.push(u)}k=new N(e,{wiggle:k});return{sb:f,Sb:a,rb:b,Gb:k,fb:h}}class Ba{constructor(a,b,c,e){const d=a.o.pa.sb("blink",a.j),h=a.s;this.x=this.O=b;this.y=c;this.z=e;this.g=this.l=0;this.na=[S(0,b,c,-1,1,h),S(1,b,c,-1,-1,h),S(2,b,c,1,1,h),S(3,b,c,1,-1,h)];this.v=d;this.state=Ca(this,a)}K(a,b){const c=this.state.Ga;c&&c();this.state=b=b(this,a);b.F(a)}W(a,b,c){this.v=a(c,b)}}
function Ca(a,b){return{name:"creature_normal",F:()=>{var c=b.j;a.x=a.O+Math.sin(c);var e=.5*Math.cos(c);c=b.j;if(c>a.l){var d=a.g;a.g=(d+1)%a.na.length;d=a.na[d];e=a.x+.225*e+d.lb;.05<Math.abs(e-d.ya)&&(a.l=c+.125,d.Ua=c+.125,d.Ra=d.ya,d.Sa=d.Ha,d.Ta=d.Ia,d.ya=e,d.Ha=a.y+d.mb,d.Ia=b.s)}},ka:(c,e,d)=>{c=e.stack;const h=a.x,g=a.z;C(c,h,a.y,g);let f=d.x<h;d=ya(d.z-g,d.x-h);f&&(c.push(za),d=Math.PI-d);D(c,d);a.v.da(e);c.pop();f&&c.pop();c.pop()}}}
function Da(a,b){Ea(b.audio,a,b.o.pa.fb);const c=b.o.pa.rb(b.m.u<a.x?"left":"right",b.j);a.v=c;return{name:"creature_death",F:()=>{1<c.I&&a.na.length&&(a.na=[]);-1===c.J&&b.M.splice(b.M.indexOf(a),1)},ka:(e,d)=>{console.log("DEATH");e=d.stack;C(e,a.x,a.y,b.s);c.da(d);e.pop()}}}function Fa(a){const b=a.j;a.M.forEach(c=>{ra(c.v,b);c.state.F(a)})}
function Ga(a,b,c){const e=b.stack,d=c.o.pa.Gb,h=c.j,g=Ha(c.m);c.M.forEach(f=>{f.state.ka(a,b,g)});K(d,b);c.M.forEach(f=>{const k=f.z-.1875;f.na.forEach(m=>{var n=f.x+m.ab,p=f.y+m.bb;let l=m.ya,q=m.Ha,x=m.Ia;var u=m.Ua;h<u&&(u=1-(u-h)/.125,l=Ia(u,m.Ra,n,l),q=Ia(u,m.Sa,p,q),x=Ia(u,m.Ta,k,x));n-=l;p-=q;u=k-x;const B=Math.sqrt(n*n+p*p+u*u);C(e,l,q,x);D(e,ya(u,n));e.push(new Float32Array([B,0,0,0,0,p,0,0,0,0,1,0,0,0,0,1]));M(d,"wiggle",Math.abs((Math.floor(24*Date.now()/1E3)+m.jb)%57+1-29));e.pop();e.pop();
e.pop()})})}function S(a,b,c,e,d,h){const g=.4*e;d=.1*d;b+=g;c+=d;return{index:a,ab:.05*e,bb:0,lb:g,mb:d,Ua:0,Ra:b,Sa:c,Ta:h,ya:b,Ha:c,Ia:h,jb:0}}function Ia(a,b,c,e){return a*(a*e+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};const Ja=434/1.8,T=405/Ja;function Ha(a){return{x:a.u,z:a.U+1.8-.1}}function Ka(a){return(a=a.v.sa())?a.Oa:null}function U(a,b){a.Za=b;0!==b&&(a.la=Math.sign(b))}
class La{constructor(a,b,c){this.u=b;this.va=0;this.U=c;this.la=1;this.Za=0;this.v=a.Fa("right",0);this.state={name:"unstarted",F:e=>this.K(e,V),ka:()=>{throw Error("Hero did not get processed before rendering!");}}}W(a,b,c=-1===this.la?"left":"right"){this.v=a(c,b)}da(a,b){a=b.stack;C(a,this.u,this.va,this.U);this.v.da(b);a.pop()}K(a,b){const c=this.state.Ga;c&&c();this.state=b=b(this,a);b.F(a)}}
function V(a,b){let c=!0;a.W(b.o.m.Fa,b.j);return{name:"normal",F:e=>{const d=e.m,h=e.j;var g=e.input;if("r0"===e.name&&G(g,"up"))d.K(e,Ma);else if(G(g,"attack"))d.K(e,Na);else{var f=1.2*e.za;{const k=G(g,"left")?1:0;g=(G(g,"right")?1:0)-k}f*=g;g=d.u+f;g<e.L+T?f=e.L+T-d.u:g>e.R-T&&(f=e.R-T-d.u);U(d,f/e.za);g=-1===d.la?"left":"right";f?(d.u+=f,c&&(c=!1,d.W(e.o.m.ub,h))):c||(c=!0,d.W(e.o.m.Fa,h));e=d.v;if(g!==e.g){if(!e.ta.includes(g))throw Error(`${e} does not have mode ${g}`);e.g=g}}}}}
function Na(a,b){const c=a.u+300/Ja*a.la;var e=b.M.find(d=>.4>Math.abs(c-d.x));e&&"creature_death"!==e.state.name&&e.K(b,Da);a.W(b.o.m.pb,b.j);U(a,0);e=b.o.m.kb;Ea(b.audio,a,e[Math.floor(Math.random()*e.length)]);return{name:"attacking",F:d=>{-1===a.v.J&&a.K(d,V)}}}function Ma(a,b){a.W(b.o.m.qb,b.j,"up");U(a,0);a.va=.55;b.transition={Ja:"r1",Yb:"up",Xa:Date.now()/1E3,Ya:1};return{name:"climbing",F:c=>{-1===a.v.J?a.K(c,V):a.U=c.s+.3*Math.min(5,a.v.I)},Ga:()=>{a.va=0;a.U=b.s}}}
function Oa(a,b){const c=b.j;a.W(b.o.m.tb,b.j,"exit");U(a,0);b.Ea++;return{name:"entering_hatch",F:()=>{const e=a.v;if(b.j<c+1){var d=b.j;if(!e.ta.includes("exit"))throw Error(`${e} does not have mode ${"exit"}`);e.l=0;e.g="exit";e.I=0;e.J=d+e.O[0]}else-1===e.J?a.K(b,V):a.U=b.s+([-.5,-.5,-.3,-.3][a.v.I]||0)},ka:(e,d)=>{b.j<c+1||a.da(e,d)},Ga:()=>{b.Ea--;a.U=b.s}}}
async function Pa(a,b){const [c,e,d,h,g,f]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),a("hero_climbing","assets/Climbing Up.png"),a("hero_hatch","assets/climbing_in.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")])]);a={name:"hero_hatch_enter",X:g,B:350,A:406,G:161,H:479,ia:6,D:!1,C:.125,$:[{c:201,f:137,a:172,b:175},{c:422,f:246,a:461,b:259},
{c:67,f:659,a:113,b:651},{c:419,f:658,a:462,b:648},{c:80,f:1041,a:106,b:1067},null],ma:"enter"};return{kb:f,Fa:W({name:"hero_idle",X:c,B:405,A:434,G:220,H:434,ia:16,D:!0,C:1/12,$:[{c:388,f:104,a:385,b:170},{c:792,f:105,a:790,b:170},{c:1198,f:105,a:1195,b:169},{c:1602,f:106,a:1600,b:170},{c:2008,f:106,a:2005,b:172},{c:388,f:539,a:385,b:604},{c:794,f:540,a:790,b:605},{c:1196,f:539,a:1196,b:604},{c:1602,f:539,a:1602,b:604},{c:2009,f:541,a:2007,b:604},{c:386,f:974,a:385,b:1036},{c:792,f:972,a:790,b:1033},
{c:1198,f:974,a:1196,b:1038},{c:1602,f:972,a:1601,b:1036},{c:2010,f:974,a:2005,b:1044},{c:386,f:1406,a:385,b:1477}]}),ub:W({name:"hero_walk",X:e,B:424,A:444,G:258,H:444,ia:8,D:!0,C:.125,$:[{c:408,f:110,a:404,b:166},{c:830,f:110,a:829,b:166},{c:408,f:554,a:404,b:614},{c:830,f:554,a:829,b:614},{c:408,f:998,a:404,b:1055},{c:830,f:998,a:829,b:1055},{c:408,f:1444,a:404,b:1500},{c:830,f:1444,a:829,b:1500}]}),pb:W({name:"hero_attack",X:d,B:644,A:565,G:284,H:565,ia:5,D:!1,C:1/12,$:[{c:422,f:285,a:415,b:353},
{c:936,f:367,a:868,b:380},{c:1507,f:311,a:1469,b:318},{c:162,f:948,a:206,b:943},{c:1025,f:934,a:976,b:962}]}),qb:W({name:"hero_climbing_up",X:h,B:222,A:412,G:110,H:412,ia:8,D:!1,C:.125,$:[{c:128,f:60,a:65,b:54},{c:329,f:155,a:277,b:148},{c:579,f:58,a:518,b:56},{c:772,f:157,a:721,b:156},{c:95,f:575,a:65,b:567},{c:337,f:472,a:286,b:465},null,null],ma:"up",scale:1.4}),Tb:W(a),tb:W({...a,name:"hero_hatch_exit",ma:"exit",yb:!0})}}
function W(a){var b=a.X;const c=a.B,e=a.A,d=a.G,h=a.H,g=a.yb?l=>[...l].reverse():l=>l,f=Ja/(a.scale||1),k=Math.floor(b.w/c),m={x:d/f,z:(e-h)/f,width:c/f,height:e/f,ga:c/b.w,fa:e/b.i,ca:k,count:a.ia},n=a.$&&a.$.map((l,q)=>{if(!l)return{Oa:null};const x=l.c,u=l.f;return{Oa:{x:(x-(q%k*c+d))/f,z:(Math.floor(q/k)*e+h-u)/f,angle:ya(-(u-l.b),x-l.a)}}});let p;a.ma?(p=[a.ma],b=new N(b,{[a.ma]:g(P(m))})):(p=["left","right"],b=new N(b,{right:g(P(m)),left:g(P({...m,ea:!0}))}));return O({name:a.name,set:b,ja:p,
D:a.D,C:a.C,xb:n&&g(n)})};function Qa(a,b){var c=376/b;const e=c/(484/b),d=c/(268/b);c/=1.25;const h=b/a*c;return{vb:new Float32Array([h,0,0,0,0,0,1/1.5,(d-e)/1.5,0,c,0,0,0,0,0,(e+d)/2]),Mb:e,Lb:d,Ab:h,Bb:c,B:a,A:b,ba:554/b*e/c-1.25,P:.3}}
async function Ra(a,b){const [c,e,d,h,g,f]=await Promise.all([b("ladder","assets/ladder.png"),b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png"),b("set_pieces","assets/set_pieces.png")]);b=new N(c,{main:[Z(a,c,{G:c.w,H:c.i,B:c.w,A:c.i,offsetY:.55,Va:1.25})]});var k={};k.barrel1=[Z(a,f,{G:370,H:270,B:338,A:222,offsetY:.55})];k.upperHatch=[Z(a,f,{G:2036,H:725,B:345,A:311,offsetY:.55})];k.lowerHatch=[Z(a,f,{G:2036,H:725,B:345,
A:311,offsetY:.1,gb:!0,Va:.5})];k=new N(f,k);return{V:a,Ob:e,ib:d,eb:h,Eb:g,Rb:b,Cb:k}}
function Sa({Ob:a,ib:b,eb:c,Eb:e,V:d},h,g){const f=g-d.P;g=g+h+d.P;var k=494/a.i,m=1016/a.i,n=(m-k)*a.i/2.5*h/a.w;a=new N(a,{main:[[g,.75,2.5,n,k,g,.75,0,n,m,f,.75,2.5,0,k,f,.75,0,0,m]]});k=110/b.i;m=220/b.i;n=(m-k)*b.i/1.5*h/b.w;b=new N(b,{main:[[g,-.75,-d.ba,n,1,f,-.75,-d.ba,0,1,g,-.75,0,n,m,f,-.75,0,0,m,g,.75,0,n,k,f,.75,0,0,k]]});k=144/c.i;m=32/c.i;h=(m-k)*c.i/1.5*h/c.w;c=new N(c,{main:[[g,-.75,2.5+d.ba,h,0,f,-.75,2.5+d.ba,0,0,g,-.75,2.5,h,m,f,-.75,2.5,0,m,g,.75,2.5,h,k,f,.75,2.5,0,k]]});h=438/
e.w;k=318/e.w;m=194/e.i;n=1164/e.i;const p=84/e.w;d=[f,-.75,2.5,h,m,f,-.75,0,h,n,f+d.P,-.75,2.5,k,m,f+d.P,-.75,0,k,n,f+d.P,.75,2.5,p,414/e.i,f+d.P,.75,0,p,964/e.i];h=[];for(k=0;k<d.length;k+=5)h.push(g+(f-d[k]),d[k+1],d[k+2],d[k+3],d[k+4]);e=new N(e,{right:[h],left:[d]});return{Nb:a,hb:b,cb:c,Db:e}}
function Z(a,b,{offsetX:c=0,offsetY:e=0,Va:d=0,G:h,H:g,B:f,A:k,gb:m=!1,Qb:n=!1}){let p=(g-k)/b.i;g/=b.i;m&&(m=p,p=g,g=m);m=(h-f)/b.w;b=h/b.w;n&&(n=m,m=b,b=n);const l=a.Ab;n=a.Bb;h=(e+.75)/1.5;h=a.Mb*(1-h)+a.Lb*h;c=c*l/h;d=d*n/h;f=f/a.B/2;k=k/a.A/2;a=(c-f)*h/l;f=(c+f)*h/l;c=(d+k)*h/n;k=(d-k)*h/n;return[a,e,c,m,p,f,e,c,b,p,a,e,k,m,g,f,e,k,b,g]};function Ea(a,b,c){const e=a.l;var d=e.get(b);d&&d.stop();a=a.g;d=a.createBufferSource();d.buffer=c;d.connect(a.destination);d.start();e.set(b,d)}function Ta(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.g.decodeAudioData(c))}class Ua{constructor(){this.g=new AudioContext;this.l=new WeakMap}};function Va(a){const b=a.j,c=a.za,e=a.m,d=a.Ka,h=Math.floor(48*b)-Math.floor(48*(b-c));for(let l=0;l<h;l++){var g=2*Math.random()+1.4;let q=.1*Math.sin(2*Math.PI*Math.random());var f=Ka(e);if(!f)break;const x=e.u+f.x*e.la,u=f.z+e.U,B=Math.PI/4*(Math.random()-.5)+f.angle;f=g*Math.sin(B);g=g*Math.cos(B)+e.Za;100<d.length&&d.pop();d.push({N:!1,x,y:e.va+.01,z:u,T:g,ha:q,Z:f,startTime:b,Na:b+1.5,Wa:!1})}const k=a.s,m=9.8*c,n=0*c,p=1-.8*c;d.forEach(l=>{var q=l.N;if(!q&&b<l.Na){l.x+=l.T*c;l.y+=l.ha*c;l.z+=
l.Z*c;q=l.Z;l.Wa?(l.T*=p,l.ha*=p):(q-=m,l.T-=n,l.Z=q);if(l.x<a.L||l.x>a.R)l.N=!0;const x=l.y;if(-.75>x||.75<x){const u=0<x?.75:-.75;l.y=u+(u-x);l.ha=-l.ha}l.z<k&&(-.01<q?(l.z=k,l.Z=0,l.Wa=!0):(l.z=k+k-l.z,l.Z=-.25*q))}else q||(l.N=!0)});d.sort(Wa)}
function Xa(a){const b=1/18/18,c=h=>Math.max(0,Math.min(255,Math.round(256*(1-b*h*h)))),e=[];for(let h=0;2>h;h++)for(let g=0;18>g;g++)for(let f=0;2>f;f++){let k;var d=void 0;let m;d=g+6*f;18>d?(k=255,d=c(d),m=255):m=d=k=0;c(g+6*f);c(g+6*f+1);for(let n=0;2>n;n++)e.push(k,d,d,m)}a=ma({name:"spark",width:72,height:2,h:a,Ca:new Uint8Array(e)});return new N(a,{fading:P({x:1/180,width:.04,height:2/180,ga:1/18,fa:1,ca:18,count:18})})}function Wa(a,b){return a.N?b.N?0:1:b.N?-1:a.y-b.y}
function Ya(a,b){const c=b.o.Fb,e=a.stack;K(c,a);b.Ka.forEach(d=>{d.N||(C(e,d.x,d.y,d.z),D(e,(0<=d.T?Math.PI:0)+Math.atan(d.Z/d.T)),M(c,"fading",Math.floor(12*(b.j-d.startTime))),e.pop(),e.pop())})};function Za(a){const b=a.L,c=a.R,e=a.s,d=a.xa;return{name:a.name,o:d.o,input:d.input,audio:d.audio,M:[],j:0,zb:Date.now()/1E3-1/60,za:0,L:b,R:c,s:e,ra:Sa(d.o.Da,c-b,b),Ka:[],Qa:!1,m:new La(d.o.m,(c+b)/2,e),transition:null,Ea:0,Ma:0}};function $a(a,b,c){const e=a.g.h,d=a.l;e.bindFramebuffer(e.FRAMEBUFFER,a.ta);e.viewport(0,0,d.w,d.i);ia(a.g,(h,g)=>{ab(h,g,b,a,c)})}
class bb{constructor(a,b,c,e){b/=4;c/=4;var d=new E({h:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  gl_Position = u_projection * vec4(a_position, 1);\n  v_texturePosition = a_texturePosition;\n}"),h=new E({h:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\nuniform vec4 u_color;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    \n    if (u_threshold != -1.f) {\n      color.a -= u_threshold;\n      if (color.a <= u_threshold) {\n          discard;\n      }\n      output_color = color;\n    } else {\n      if (color.a == 0.f) {\n        discard;\n      }\n      output_color = u_color;\n    }\n}");const g=
new fa({h:a,V:"projection"});ea(g,d,h).link();d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);h=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,h);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.bindFramebuffer(a.FRAMEBUFFER,
null);const f=128/e;e=ma({name:"fade",width:64,height:64,h:a,Ca:cb(e)});this.g=g;this.l=na({X:d,name:"lighting",width:b,height:c,h:a});this.ta=h;this.O=new N(e,{main:[[f,0,-f,1,0,f,0,f,1,1,-f,0,-f,0,0,-f,0,f,0,1]]});a=ma({name:"solid",width:1,height:1,h:a,Ca:new Uint8Array([255,255,255,255])});this.wa=new N(a,{main:[[0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0]]})}}
function ab(a,b,c,e,d){a.blendFunc(a.ONE,a.ONE);a.clearColor(0,0,0,0);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const h=b.S.threshold,g=b.S.color;a.uniform1f(h,-1);const f=b.stack;c(f,()=>{const k=e.wa;K(k,b);d.forEach(n=>{a.uniform4f(g,0,0,0,window.Qa?1:n.Ma);const p=n.o.Da.V,l=n.L-p.P;f.push(new Float32Array([n.R+p.P-l,0,0,0,0,0,0,0,0,0,2*p.ba+2.5,0,l,-.75,n.s-p.ba,1]));M(k,"main",0);f.pop()});const m=e.O;K(m,b);a.uniform4f(g,0,0,0,1);d.forEach(n=>{const p=n.j;n.Ka.forEach(l=>{if(!l.N){var q=
l.startTime;q=(p-q)/(l.Na-q);a.uniform1f(h,.5*q*q);C(f,l.x,l.y,l.z);M(m,"main",0);f.pop()}})})})}function cb(a){const b=new Uint8Array(16384),c=(h,g)=>{h/=a;g/=a;return h*h+g*g},e=Math.min(c(32,0),c(32,0));for(let h=0;64>h;h++)for(let g=0;64>g;g++){const f=4*(64*h+g);var d=c(g-32,h-32);const k=1-Math.sqrt(d/e);d=1E-4>=d?5:0;const m=Math.max(Math.round(255*k*k),0);b[f]=d+Math.max(Math.round(20*k),0);b[f+1]=d;b[f+2]=d;b[f+3]=m}return b};function db(a,b){const c=a.g;let e=c.get(b);e||(e=eb(a.xa,b),c.set(b,e));return e}function fb(a,b){a.oa.name!==b&&(a.oa=db(a,b))}class gb{constructor(a,b){this.xa=a;this.g=new Map([[b.name,b]]);this.oa=b}}function eb(a,b){switch(b){case "r0":return a=Za({xa:a,name:b,L:0,R:12,s:0}),b=a.m,b.u=a.L+4,a.M.push(new Ba(a,b.u+2,0,a.s+.75)),a.Ma=.1,a;case "r1":return a=Za({xa:a,name:b,L:-12,R:10,s:5.5}),a.M.push(new Ba(a,0,0,a.s+.75)),a;default:throw Error(`Unrecognized room name "${b}"`);}}
function hb(a){return{x:Math.min(Math.max(a.m.u,a.L+1),a.R-1),y:0,z:a.s+1.25}};window.onload=async function(){function a(r,t){r.push(l.vb);C(r,-J.x,-J.y,-J.z);C(r,0,0,ua);D(r,va);t();r.pop();r.pop();r.pop()}function b(r,t,y){r.bindFramebuffer(r.FRAMEBUFFER,null);r.viewport(0,0,n,p);r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);r.clearColor(0,0,0,1);r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);r.activeTexture(r.TEXTURE1);u.l.bindTexture();r.uniform1i(t.S.lighting,1);r.activeTexture(r.TEXTURE0);a(t.stack,()=>{y.forEach(z=>{const L=t.stack.depth();var w=t.stack;C(w,0,0,z.s);
var v=z.ra.Nb;K(v,t);M(v,"main",0);v=z.ra.hb;K(v,t);M(v,"main",0);v=z.ra.cb;K(v,t);M(v,"main",0);v=z.ra.Db;K(v,t);M(v,"left",0);M(v,"right",0);C(w,2,0,0);v=z.o.Da.Cb;K(v,t);M(v,"lowerHatch",0);w.pop();w.pop();(w=z.m.state.ka)?w(r,t):z.m.da(r,t);Ga(r,t,z);Ya(t,z);t.stack.depth()!==L&&console.error("yo!")})})}function c(){!ha&&G(g,"fullscreen")&&(ha=d.requestFullscreen());const r=Date.now()/1E3;X=-1===X?60:.125/(r-wa)+.875*X;e.innerHTML=`fps=${Math.round(X)}`;wa=r;var t=Math.sin(Math.PI*(r+0)/8)/2+
Math.sin(Math.PI*(r+0)/3)/8,y=Math.sin(Math.PI*(r+170)/8)/2+Math.sin(Math.PI*(r+130)/3)/8;va=Math.asin((t-y)/100);ua=(t+y)/2;y=I.oa;t=null;const z=y.transition;z&&(z.Xa+z.Ya<r?(y.transition=null,fb(I,z.Ja),y=I.oa):t=db(I,z.Ja));const L=t?[y,t]:[y];L.forEach(w=>{{const v=r-w.zb;w.za=v-w.j;w.j=v}});J=hb(y);t&&(y=Math.sin(Math.PI/2*((r-z.Xa)/z.Ya)),t=hb(t),J={x:J.x*(1-y)+t.x*y,y:J.y*(1-y)+t.y*y,z:J.z*(1-y)+t.z*y});oa(g)%2&&(k=!k,window.Qa=k);L.forEach(w=>{{let Y=w.transition;var v=w.m;ra(v.v,w.j);v.state.F(w);
if(w.transition&&!Y){Y=w.transition;{v=db(I,Y.Ja);const xa=v.m;xa.u=w.m.u;xa.K(v,Oa)}}Va(w);Y||w.Ea||Fa(w)}});$a(u,a,L);ia(x,(w,v)=>b(w,v,L));requestAnimationFrame(c)}const e=document.getElementById("fps"),d=document.getElementById("canvas");var h=window.getComputedStyle(d);const g=new pa(document.body);F(g,"left",["a","ArrowLeft"]);F(g,"right",["d","ArrowRight"]);F(g,"showLights",["l"]);F(g,"attack",["f"," "]);F(g,"fullscreen",["u"]);F(g,"up",["w","ArrowUp"]);F(g,"down",["s","ArrowDown"]);F(g,"lightUp",
["y"]);F(g,"lightDown",["h"]);var f=parseInt(h.getPropertyValue("width"),10);h=parseInt(h.getPropertyValue("height"),10);let k=!1;const m=window.devicePixelRatio||1,n=m*f,p=m*h;d.width=n;d.height=p;const l=Qa(f,h),q=d.getContext("webgl2",{antialias:!1,alpha:!1});q.enable(q.BLEND);q.enable(q.DEPTH_TEST);q.depthFunc(q.LEQUAL);f=new E({h:q,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
h=new E({h:q,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const x=new fa({h:q,V:"projection"});ea(x,f,h).link();const u=new bb(q,n,p,360),B=new Ua;f=(r,t)=>ka({h:q,name:r,src:t});h=r=>Ta(B,r);const [H,Q,R]=await Promise.all([Ra(l,f),Aa(f,h),Pa(f,h)]);f={o:{pa:Q,m:R,Da:H,Fb:Xa(q)},input:g,audio:B};const I=new gb(f,eb(f,"r0"));let X=-1,ha=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(ha=null)});let J={x:0,y:0,z:0},va,ua,wa=Date.now();requestAnimationFrame(c);d.onmousemove=()=>{}};
