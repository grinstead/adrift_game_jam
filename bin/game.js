'use strict';class aa{constructor(a,b,c){this.name=c;this.ia=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.ia}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.ia}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ca(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new aa(c[1],c[2],c[3]))});return b}
const da=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function ea(a,b){a.i.uniformMatrix4fv(a.v,!1,b);a.a.push(b)}function z(a,b,c,d=0){var e=a.a;e=e.length?e[e.length-1]:da;ea(a,new Float32Array([e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],b*e[0]+c*e[4]+d*e[8]+e[12],b*e[1]+c*e[5]+d*e[9]+e[13],b*e[2]+c*e[6]+d*e[10]+e[14],b*e[3]+c*e[7]+d*e[11]+e[15]]))}function A(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class fa{constructor(a,b){this.i=a;this.v=b;this.a=[];a.uniformMatrix4fv(b,!1,da)}depth(){return this.a.length}pop(){return this.a.pop()}push(a){var b=this.a;0===b.length?ea(this,a):(b=b[b.length-1],ea(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+
a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class B{constructor(a,b){this.name=a.name;var c=this.i=a.i;a=this.type=a.type;switch(a){case "vertex":var d=this.i.VERTEX_SHADER;break;case "fragment":d=this.i.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}d=this.a=c.createShader(d);c.shaderSource(d,b);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(d)}`,c.deleteShader(d),Error(b);this.gb=ca(b)}}
function ia(a,...b){const c=a.i,d=a.Ha;b.forEach(e=>{a.Qa.push(e);c.attachShader(d,e.a)});return a}class ja{constructor(a){this.name=a.name;this.ca=a.ca;a=this.i=a.i;this.a=!1;this.Ha=a.createProgram();this.Qa=[];this.V={};this.ea={};this.stack=null}link(){if(this.a)return this;var a=this.i,b=this.Ha;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.a=!0;return this}}
function ka(a,b){var c=a.i,d=a.Ha;c.useProgram(d);for(var e={},f={},h=a.Qa,g=0;g<h.length;g++)for(var k=h[g].gb,l=0;l<k.length;l++){var n=k[l];1===n.type?n.ia in e||(e[n.name]=c.getUniformLocation(d,n.ia)):n.ia in f||(f[n.name]=c.getAttribLocation(d,n.ia))}a.V=e;a.ea=f;if(d=a.ca)if(d in a.V)a.stack=new fa(c,a.V[d]);else throw Error(`No anchor point "${d}" in program`);try{b(c,a)}finally{a.V={},a.ea={},a.stack=null}}
class la{constructor(a,b,c,d,e){this.i=a;this.name=b;this.w=c;this.s=d;this.a=e(a)}bindTexture(){this.i.bindTexture(this.i.TEXTURE_2D,this.a)}}function ma(a){return(new Promise((b,c)=>{const d=new Image;d.onload=()=>void b(d);d.onerror=()=>{c(Error(`failed to load ${a.src}`))};d.mode="no-cors";d.src=a.src})).then(b=>{const c=b.naturalWidth,d=b.naturalHeight;return new la(a.i,a.name,c,d,na(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,c,d,0,e.RGBA,e.UNSIGNED_BYTE,b)}))})}
function oa(a){const b=a.width,c=a.height;return new la(a.i,a.name,b,c,na(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,b,c,0,d.RGBA,d.UNSIGNED_BYTE,a.Ja,0)}))}function pa(a){return new la(a.i,a.name,a.width,a.height,()=>a.U)}
function na(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function C(a,b,c){a=a.v;null!=c?a.set(b,c):a.delete(b)}function G(a,b){b=a.v.get(b);const c=a.a;return!!b&&!!b.some(d=>(d=c.get(d))?(d.wa=0,null!=d.Aa):!1)}function ra(a){const b=a.v.get("showLights");if(b){const c=a.a;return b.reduce((d,e)=>(e=c.get(e))?(d+=e.wa,e.wa=0,d):d,0)}return 0}function sa(a,b,c){b=G(a,b)?1:0;return(G(a,c)?1:0)-b}
class ta{constructor(a){this.a=new Map;this.v=new Map;a.addEventListener("keydown",b=>{ua(this,b,!0)});a.addEventListener("keyup",b=>{ua(this,b,!1)});a.onblur=()=>{this.a.clear()};a.onfocus=()=>{this.a.clear()}}}function ua(a,b,c){b=b.key;a=a.a;const d=a.get(b);c?null==d?a.set(b,{Aa:Date.now(),wa:1}):(null==d.Aa&&(d.Aa=Date.now()),d.wa++):null!=d&&(d.Aa=null)};function H(a,b){const c=a.a.i;let d=a.v;null!=d?c.bindBuffer(c.ARRAY_BUFFER,d):(a.v=d=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,d),c.bufferData(c.ARRAY_BUFFER,a.ga,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.a.bindTexture();c.uniform1i(b.V.texture,0);c.enableVertexAttribArray(b.ea.texturePosition);c.vertexAttribPointer(b.ea.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.ea.position);c.vertexAttribPointer(b.ea.position,3,c.FLOAT,!1,20,0)}
function K(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.a.i;const d=b.Ia;a.drawArrays(a.TRIANGLE_STRIP,d[c%d.length],b.Mb)}
class N{constructor(a,b){this.a=a;this.v=null;a=this.data={};const c=[];let d=0;for(const e in b){const f=b[e],h=[],g=f.length;if(0===g)throw Error("Sprite declared with 0 points");const k=f[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const l=k/5;for(let n=0;n<g;n++){const p=f[n];if(p.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");h.push(d);c.push.apply(c,p);d+=l}a[e]={dc:this,name:e,Ia:h,Mb:l}}this.ga=new Float32Array(c)}}
function va(a,b){for(var c=a.H;-1!==c&&c<=b;){c=a.ga;const d=a.I+1;d===c.length?a.v===a.Ab?a.H=c=-1:(a.v++,a.I=0,a.H=c=b+c[0]):(a.I=d,a.H=c=b+c[d])}}function wa(a,b){if(b!==a.a){if(!a.za.includes(b))throw Error(`${a} does not have mode ${b}`);a.a=b}}
class xa{constructor(a,b,c,d){const e=a.L;this.Ba=a.name;this.za=a.ta;this.a=c;this.Ab="number"===typeof e?e:e?-1:0;this.Ta=a.set;this.ga=b;this.I=this.v=0;this.H=d+b[0];this.wb=a.Nb}ya(){const a=this.wb;return null!=a?a[this.I]:void 0}T(a){H(this.Ta,a);K(this.Ta,this.a,this.I)}name(){return this.Ba}toString(){return`Sprite/${this.Ba}`}}
function O(a){const b=a.name,c=a.K,d=a.set.data;let e=-1;a.ta.forEach(h=>{const g=d[h];if(!g)throw Error(`Sprite/${b} has non-existent mode ${h}`);if(-1===e)e=g.Ia.length;else if(e!==g.Ia.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===e)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==e)throw Error(`Sprite/${b} given ${c.length} frame times for ${e} frames`);if(a.ya&&a.ya.length!==e)throw Error(`Sprite/${b} given ${a.ya.length} frame data points for ${e} frames`);
const f="number"===typeof c?Array(e).fill(c):c;return(h,g)=>new xa(a,f,h,g)}function P({x:a=0,y:b=0,z:c=0,width:d,height:e,qa:f,pa:h,ma:g,count:k,hc:l=0,ic:n=0,jc:p=f,fc:m=h,oa:t=!1}){const r=[];for(let w=0;w<k;w++){const D=l+w%g*p,I=n+Math.floor(w/g)*m;r.push(ya({x:a,y:b,z:c,width:d,height:e,Xb:D,Vb:D+f,Yb:I,Wb:I+h,oa:t}))}return r}
function ya({x:a=0,y:b=0,z:c=0,width:d,height:e,depth:f=0,Xb:h,Yb:g,Vb:k,Wb:l,oa:n=!1}){n?(n=k,k=a-d):(n=h,h=k,k=-a,a=d-a);return[a,-b,-c,h,l,k,-b,-c,n,l,a,f-b,e-c,h,g,k,f-b,e-c,n,g]};function za(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const Aa=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function Ba(a,b){const [c,d,e,f,h,g,k]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png"),b("assets/Enemy Dying.mp3"),b("assets/enemy_scream.mp3"),b("assets/Enemy Notices You.mp3"),a("creature_death","assets/Enemy Dying.png")]);var l=new N(c,{blink:P({x:.25,z:.25,width:.5,height:.5,qa:108/c.w,pa:108/c.s,ma:2,count:6,oa:!0})});a=O({name:"creature_attack",set:new N(e,{bite:P({x:.5,z:.75,width:1,height:2,pa:530/e.s,
qa:278/e.w,ma:7,count:42,oa:!0})}),ta:["bite"],L:!1,K:1/12});b=O({name:"creature_death",set:new N(k,{left:P({x:330/(460/1.8),y:.375,z:0,width:660/(460/1.8),height:1.8,qa:660/k.w,pa:500/k.s,ma:3,count:12}),right:P({x:1.32,y:.375,z:0,width:2.64,height:1.8,qa:660/k.w,pa:500/k.s,ma:3,count:12,oa:!0})}),ta:["left","right"],L:!1,K:.125});var n=Array(6).fill(.125);n[0]=4;l=O({name:"creature_normal",set:l,ta:["blink"],L:!0,K:n});n=[];var p=92,m=-22;const t=Math.sqrt(p*p+m*m);p/=t;m/=t;for(let r=0;29>r;r++){const w=
r%5,D=Math.floor(r/5),I=[],Q=(T,ba)=>{const J=100*T,M=77*ba-48;I.push((J*p+M*m)/t,T,(J*-m+M*p)/360,100*(w+T)/d.w,77*(D+ba)/d.s)};Q(1,1);Q(0,1);Q(1,0);Q(0,0);n.push(I)}n=new N(d,{wiggle:n});return{Fb:l,Db:a,Eb:b,Ub:n,lb:f,nb:h,mb:g}}
class Ca{constructor(a,b,c,d){const e=a.l.X.Fb("blink",a.m),f=a.u;this.a=e;this.x=this.v=b;this.y=c;this.z=d;this.Ya=this.Za=this.speed=0;this.Ga=[Da(0,b,c,-1,1,f),Da(1,b,c,-1,-1,f),Da(2,b,c,1,1,f),Da(3,b,c,1,-1,f)];this.o=e;this.state=Ha(this,a)}A(a,b){const c=this.state.Da;c&&c();this.state=b=b(this,a);b.D(a)}O(a,b,c){this.o=a(c,b)}}
function Ha(a,b){a.o=a.a;return{name:"creature_normal",D:()=>{var c=b.m;a.x=a.v+Math.sin(c);a.speed=.5*Math.cos(c);c=Math.abs(a.x-b.h.j);4>c&&(.5>c?a.A(b,Ia):a.A(b,Ja))},M:(c,d,e)=>{c=d.stack;const f=a.x,h=a.z;z(c,f,a.y,h);let g=e.x<f;e=za(e.z-h,e.x-f);g&&(c.push(Aa),e=Math.PI-e);A(c,e);a.o.T(d);c.pop();g&&c.pop();c.pop()}}}
function Ja(a,b){const c=b.m;R(b.audio,a,b.l.X.mb);a.o=a.a;return{name:"creature_hunting",D:()=>{const d=b.m;var e=b.h.j;const f=Math.abs(a.x-b.h.j);.25<f&&(e=(e<a.x?-1:1)*(.01+.02*Math.min(1,(b.m-c)/3)),a.speed=e,a.x+=e);.5>f&&1<d-c&&a.A(b,Ia)},M:(d,e,f)=>{d=e.stack;const h=a.x,g=a.z;z(d,h,a.y,g);let k=f.x<h;f=za(f.z-g,f.x-h);k&&(d.push(Aa),f=Math.PI-f);A(d,f);a.o.T(e);d.pop();k&&d.pop();d.pop()}}}
function Ia(a,b){const c=b.l.X.Db("bite",b.m);a.o=c;R(b.audio,a,b.l.X.nb);let d=!1;return{name:"creature_attack",D:()=>{const e=c.I;10>=e?d=b.h.j<a.x:15>e?1.5>Math.abs(a.x-b.h.j)&&console.warn("Kill / hurt the hero"):-1===c.H&&a.A(b,Ja)},M:(e,f)=>{e=f.stack;z(e,a.x,a.y,a.z);let h=d;h&&e.push(Aa);a.o.T(f);h&&e.pop();e.pop()}}}
function Ka(a,b){R(b.audio,a,b.l.X.lb);const c=b.l.X.Eb(b.h.j<a.x?"left":"right",b.m);a.o=c;return{name:"creature_death",D:()=>{1<c.I&&a.Ga.length&&(a.Ga=[]);-1===c.H&&b.Y.splice(b.Y.indexOf(a),1)},M:(d,e)=>{d=e.stack;z(d,a.x,a.y,b.u);c.T(e);d.pop()}}}function La(a,b){a.Y.push(new Ca(a,b,0,a.u+.75))}
function Ma(a){const b=a.m;a.Y.forEach(c=>{va(c.o,b);c.state.D(a);var d=c.Ga;if(0!==d.length){var e=c.speed,f=a.m;if(f>c.Za){let h=c.Ya;c.Ya=(h+1)%d.length;d=d[h];e=c.x+.225*e+d.ub;.05<Math.abs(e-d.Ea)&&(c.Za=f+.125,d.Xa=f+.125,d.Ua=d.Ea,d.Va=d.Ma,d.Wa=d.Na,d.Ea=e,d.Ma=c.y+d.vb,d.Na=a.u)}}})}
function Na(a,b,c){const d=b.stack,e=c.l.X.Ub,f=c.m,h=Oa(c.h);c.Y.forEach(g=>{g.state.M(a,b,h)});H(e,b);c.Y.forEach(g=>{const k=g.z-.1875;g.Ga.forEach(l=>{var n=g.x+l.hb,p=g.y+l.ib;let m=l.Ea,t=l.Ma,r=l.Na;var w=l.Xa;f<w&&(w=1-(w-f)/.125,m=Pa(w,l.Ua,n,m),t=Pa(w,l.Va,p,t),r=Pa(w,l.Wa,k,r));n-=m;p-=t;w=k-r;const D=Math.sqrt(n*n+p*p+w*w);z(d,m,t,r);A(d,za(w,n));d.push(new Float32Array([D,0,0,0,0,p,0,0,0,0,1,0,0,0,0,1]));K(e,"wiggle",Math.abs((Math.floor(24*Date.now()/1E3)+l.rb)%57+1-29));d.pop();d.pop();
d.pop()})})}function Da(a,b,c,d,e,f){const h=.4*d;e=.1*e;b+=h;c+=e;return{index:a,hb:.05*d,ib:0,ub:h,vb:e,Xa:0,Ua:b,Va:c,Wa:f,Ea:b,Ma:c,Na:f,rb:0}}function Pa(a,b,c,d){return a*(a*d+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};class Qa{constructor(a){this.a=!1;this.x=a}M(a,b,c){a=b.stack;const d=c.l.$.zb;z(a,this.x,0,c.u);H(d,b);K(d,this.a?"on":"off",0);a.pop()}}class S{constructor(a,b){this.a=b;this.x=a}Ka(){return Ra(this.a,"down")}M(a,b,c){a=b.stack;const d=c.l.$.eb;z(a,this.x,0,c.u);H(d,b);K(d,c.Ca?"lowerHatch":"lowerHatchClosed",0);a.pop()}}
class Sa{constructor(a,b){this.a=b;this.x=a}Ka(){return Ra(this.a,"up")}M(a,b,c){a=b.stack;const d=c.l.$.xb,e=c.l.$.eb;z(a,this.x,0,c.u);H(d,b);K(d,"main",0);H(e,b);K(e,"upperHatch",0);a.pop()}}function Ra(a,b){return{Oa:a,Zb:b,ab:Date.now()/1E3,cb:1}};const Ta=434/1.8,Ua=405/Ta;function Oa(a){return{x:a.j,z:a.P+1.8-.1}}function Va(a){return(a=a.o.ya())?a.Sa:null}function U(a,b){a.fb=b;0!==b&&(a.ua=Math.sign(b))}
class Wa{constructor(a,b,c){this.j=b;this.ja=0;this.P=c;this.ua=1;this.fb=0;this.o=a.La("right",0);this.state={name:"unstarted",D:d=>this.A(d,V),M:()=>{throw Error("Hero did not get processed before rendering!");}}}O(a,b,c=-1===this.ua?"left":"right"){this.o=a(c,b)}T(a,b){a=b.stack;z(a,this.j,this.ja,this.P);this.o.T(b);a.pop()}A(a,b,c){const d=this.state.Da;d&&d();this.state=b=b(this,a,c);b.D(a)}}function Xa(a,b,c){const d=c.h.state.M;d?d(a,b):c.h.T(a,b)}
function V(a,b){let c=!0;a.O(b.l.h.La,b.m);return{name:"normal",D:d=>{const e=d.h,f=d.m;var h=d.input;const g=sa(h,"down","up");if(!g||!d.ka.some(l=>{if(l instanceof Qa){if(1===g&&!l.a&&.4>Math.abs(e.j-l.x))return e.A(d,Ya,l),!0}else if(l instanceof S){if(-1===g&&.4>Math.abs(e.j-l.x)&&d.Ca)return e.A(d,Za,l),!0}else if(l instanceof Sa&&1===g&&.4>Math.abs(e.j-l.x))return e.A(d,$a,l),!0}))if(G(h,"attack"))e.A(d,ab);else{h=1.6*d.Fa*sa(h,"left","right");var k=e.j+h;k<d.J+Ua?h=d.J+Ua-e.j:k>d.N-Ua&&(h=
d.N-Ua-e.j);U(e,h/d.Fa);k=-1===e.ua?"left":"right";h?(e.j+=h,c&&(c=!1,e.O(d.l.h.Kb,f))):c||(c=!0,e.O(d.l.h.La,f));wa(e.o,k)}}}}function ab(a,b){const c=a.j+300/Ta*a.ua;var d=b.Y.find(e=>.6>Math.abs(c-e.x));d&&"creature_death"!==d.state.name&&d.A(b,Ka);a.O(b.l.h.Bb,b.m);U(a,0);d=b.l.h.sb;R(b.audio,a,d[Math.floor(Math.random()*d.length)]);return{name:"attacking",D:e=>{-1===a.o.H&&a.A(e,V)}}}
function Ya(a,b,c){a.O(b.l.h.Jb,b.m,"main");U(a,0);a.j=c.x;return{name:"switch_on",D:()=>{if(!c.a&&6<=a.o.I){R(b.audio,c,b.l.h.yb);b.Ca=!0;c.a=!0;const d=b.ka.find(e=>e instanceof S);d&&R(b.audio,d,b.l.$.tb)}-1===a.o.H&&a.A(b,V)}}}function $a(a,b,c){a.O(b.l.h.Cb,b.m,"up");U(a,0);a.ja=.55;a.j=c.x;b.transition=c.Ka();return{name:"climbing",D:d=>{-1===a.o.H?a.A(d,V):a.P=d.u+.3*Math.min(5,a.o.I)},Da:()=>{a.ja=0;a.P=b.u}}}
function bb(a,b){U(a,0);a.O(b.l.h.Gb,b.m,"down");a.ja=.55;b.sa++;return{name:"descending",D:c=>{-1===a.o.H?a.A(c,V):a.P=c.u+.3*Math.min(5,8-a.o.I)},Da:()=>{a.ja=0;a.P=b.u;b.sa--}}}function Za(a,b,c){U(a,0);a.j=c.x;a.O(b.l.h.Hb,b.m,"enter");b.transition=c.Ka();return{name:"descending",D:d=>{-1===a.o.H&&a.A(d,V)}}}
function cb(a,b){const c=b.m;a.O(b.l.h.Ib,b.m,"exit");U(a,0);b.sa++;return{name:"entering_hatch",D:()=>{const d=a.o;if(b.m<c+1){var e=b.m;if(!d.za.includes("exit"))throw Error(`${d} does not have mode ${"exit"}`);d.v=0;d.a="exit";d.I=0;d.H=e+d.ga[0]}else-1===d.H?a.A(b,V):a.P=b.u+([-.5,-.5,-.3,-.3][a.o.I]||0)},M:(d,e)=>{b.m<c+1||a.T(d,e)},Da:()=>{b.sa--;a.P=b.u}}}
async function db(a,b){const [c,d,e,f,h,g,k,l]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),a("hero_climbing","assets/Climbing Up.png"),a("hero_hatch","assets/climbing_in.png"),a("hero_light","assets/Hero flipping Switch.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")]),b("assets/light.mp3")]);a={name:"hero_hatch_enter",U:h,C:350,B:406,F:161,G:479,
ha:6,L:!1,K:.125,aa:[{f:201,g:137,b:172,c:175},{f:422,g:246,b:461,c:259},{f:67,g:659,b:113,c:651},{f:419,g:658,b:462,c:648},{f:80,g:1041,b:106,c:1067},null],da:"enter"};b={name:"hero_climbing_up",U:f,C:222,B:412,F:110,G:412,ha:8,L:!1,K:.125,aa:[{f:128,g:60,b:65,c:54},{f:329,g:155,b:277,c:148},{f:579,g:58,b:518,c:56},{f:772,g:157,b:721,c:156},{f:95,g:575,b:65,c:567},{f:337,g:472,b:286,c:465},null,null],da:"up",scale:1.4};return{sb:k,La:X({name:"hero_idle",U:c,C:405,B:434,F:220,G:434,ha:16,L:!0,K:1/
12,aa:[{f:388,g:104,b:385,c:170},{f:792,g:105,b:790,c:170},{f:1198,g:105,b:1195,c:169},{f:1602,g:106,b:1600,c:170},{f:2008,g:106,b:2005,c:172},{f:388,g:539,b:385,c:604},{f:794,g:540,b:790,c:605},{f:1196,g:539,b:1196,c:604},{f:1602,g:539,b:1602,c:604},{f:2009,g:541,b:2007,c:604},{f:386,g:974,b:385,c:1036},{f:792,g:972,b:790,c:1033},{f:1198,g:974,b:1196,c:1038},{f:1602,g:972,b:1601,c:1036},{f:2010,g:974,b:2005,c:1044},{f:386,g:1406,b:385,c:1477}]}),Kb:X({name:"hero_walk",U:d,C:424,B:444,F:258,G:444,
ha:8,L:!0,K:.125,aa:[{f:408,g:110,b:404,c:166},{f:830,g:110,b:829,c:166},{f:408,g:554,b:404,c:614},{f:830,g:554,b:829,c:614},{f:408,g:998,b:404,c:1055},{f:830,g:998,b:829,c:1055},{f:408,g:1444,b:404,c:1500},{f:830,g:1444,b:829,c:1500}]}),Bb:X({name:"hero_attack",U:e,C:644,B:565,F:284,G:565,ha:5,L:!1,K:1/12,aa:[{f:422,g:285,b:415,c:353},{f:936,g:367,b:868,c:380},{f:1507,g:311,b:1469,c:318},{f:162,g:948,b:206,c:943},{f:1025,g:934,b:976,c:962}]}),Cb:X(b),Gb:X({...b,name:"hero_hatch_descend",da:"down",
bb:!0}),Hb:X(a),Ib:X({...a,name:"hero_hatch_exit",da:"exit",bb:!0}),Jb:X({name:"hero_switch",U:g,C:274,B:444,F:104,G:442,ha:9,L:!1,K:1/12,da:"main",aa:null}),yb:l}}
function X(a){var b=a.U;const c=a.C,d=a.B,e=a.F,f=a.G,h=a.bb?m=>[...m].reverse():m=>m,g=Ta/(a.scale||1),k=Math.floor(b.w/c),l={x:e/g,z:(d-f)/g,width:c/g,height:d/g,qa:c/b.w,pa:d/b.s,ma:k,count:a.ha},n=a.aa&&a.aa.map((m,t)=>{if(!m)return{Sa:null};const r=m.f,w=m.g;return{Sa:{x:(r-(t%k*c+e))/g,z:(Math.floor(t/k)*d+f-w)/g,angle:za(-(w-m.c),r-m.b)}}});let p;a.da?(p=[a.da],b=new N(b,{[a.da]:h(P(l))})):(p=["left","right"],b=new N(b,{right:h(P(l)),left:h(P({...l,oa:!0}))}));return O({name:a.name,set:b,ta:p,
L:a.L,K:a.K,Nb:n&&h(n)})};function eb(a,b){var c=376/b;const d=c/(484/b),e=c/(268/b);c/=1.25;const f=b/a*c;return{Lb:new Float32Array([f,0,0,0,0,0,1/1.5,(e-d)/1.5,0,c,0,0,0,0,0,(d+e)/2]),ac:d,$b:e,Pb:f,Qb:c,C:a,B:b,la:554/b*d/c-1.25,S:.3}}
async function fb(a,b,c){const [d,e,f,h,g,k,l,n]=await Promise.all([b("ladder","assets/ladder.png"),b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png"),b("set_pieces","assets/set_pieces.png"),b("lights","assets/Light Switch Flip.png"),c("assets/Metal Door.mp3")]);b=new N(d,{main:[Y(a,d,{F:d.w,G:d.s,C:d.w,B:d.s,offsetY:.55,na:1.25})]});c={};c.barrel1=[Y(a,k,{F:370,G:270,C:338,B:222,offsetY:.55})];c.upperHatch=[Y(a,k,{F:2036,
G:725,C:345,B:311,offsetY:.56,na:2.2,offsetX:-.1})];c.lowerHatch=[Y(a,k,{F:2036,G:725,C:345,B:311,offsetY:.1,ob:!0,na:.5})];c.lowerHatchClosed=[Y(a,k,{F:842,G:1166,C:349,B:187,offsetY:.1,na:.3})];c=new N(k,c);const p=new N(l,{on:[Y(a,l,{F:316,G:1110,C:118,B:152,offsetY:.75,na:1.4})],off:[Y(a,l,{F:316,G:298,C:118,B:152,offsetY:.75,na:1.4})]});return{ca:a,cc:e,qb:f,kb:h,Sb:g,xb:b,eb:c,zb:p,tb:n}}
function gb({cc:a,qb:b,kb:c,Sb:d,ca:e},f,h){const g=h-e.S;h=h+f+e.S;var k=494/a.s,l=1016/a.s,n=(l-k)*a.s/2.5*f/a.w;a=new N(a,{main:[[h,.75,2.5,n,k,h,.75,0,n,l,g,.75,2.5,0,k,g,.75,0,0,l]]});k=110/b.s;l=220/b.s;n=(l-k)*b.s/1.5*f/b.w;b=new N(b,{main:[[h,-.75,-e.la,n,1,g,-.75,-e.la,0,1,h,-.75,0,n,l,g,-.75,0,0,l,h,.75,0,n,k,g,.75,0,0,k]]});k=144/c.s;l=32/c.s;f=(l-k)*c.s/1.5*f/c.w;c=new N(c,{main:[[h,-.75,2.5+e.la,f,0,g,-.75,2.5+e.la,0,0,h,-.75,2.5,f,l,g,-.75,2.5,0,l,h,.75,2.5,f,k,g,.75,2.5,0,k]]});f=438/
d.w;k=318/d.w;l=194/d.s;n=1164/d.s;const p=84/d.w;e=[g,-.75,2.5,f,l,g,-.75,0,f,n,g+e.S,-.75,2.5,k,l,g+e.S,-.75,0,k,n,g+e.S,.75,2.5,p,414/d.s,g+e.S,.75,0,p,964/d.s];f=[];for(k=0;k<e.length;k+=5)f.push(h+(g-e[k]),e[k+1],e[k+2],e[k+3],e[k+4]);d=new N(d,{right:[f],left:[e]});return{bc:a,pb:b,jb:c,Rb:d}}
function Y(a,b,{offsetX:c=0,offsetY:d=0,na:e=0,F:f,G:h,C:g,B:k,ob:l=!1,ec:n=!1}){let p=(h-k)/b.s;h/=b.s;l&&(l=p,p=h,h=l);l=(f-g)/b.w;b=f/b.w;n&&(n=l,l=b,b=n);const m=a.Pb;n=a.Qb;f=(d+.75)/1.5;f=a.ac*(1-f)+a.$b*f;c=c*m/f;e=e*n/f;g=g/a.C/2;k=k/a.B/2;a=(c-g)*f/m;g=(c+g)*f/m;c=(e+k)*f/n;k=(e-k)*f/n;return[a,d,c,l,p,g,d,c,b,p,a,d,k,l,h,g,d,k,b,h]};function R(a,b,c){const d=a.v;var e=d.get(b);e&&e.stop();a=a.a;e=a.createBufferSource();e.buffer=c;e.connect(a.destination);e.start();d.set(b,e)}function hb(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.a.decodeAudioData(c))}class ib{constructor(){this.a=new AudioContext;this.v=new WeakMap}};function jb(a){const b=a.m,c=a.Fa,d=a.h,e=a.Pa,f=Math.floor(48*b)-Math.floor(48*(b-c));for(let m=0;m<f;m++){var h=2*Math.random()+1.4;let t=.1*Math.sin(2*Math.PI*Math.random());var g=Va(d);if(!g)break;const r=d.j+g.x*d.ua,w=g.z+d.P,D=Math.PI/4*(Math.random()-.5)+g.angle;g=h*Math.sin(D);h=h*Math.cos(D)+d.fb;100<e.length&&e.pop();e.push({R:!1,x:r,y:d.ja+.01,z:w,Z:h,ra:t,fa:g,startTime:b,Ra:b+1.5,$a:!1})}const k=a.u,l=9.8*c,n=0*c,p=1-.8*c;e.forEach(m=>{var t=m.R;if(!t&&b<m.Ra){m.x+=m.Z*c;m.y+=m.ra*c;
m.z+=m.fa*c;t=m.fa;m.$a?(m.Z*=p,m.ra*=p):(t-=l,m.Z-=n,m.fa=t);if(m.x<a.J||m.x>a.N||m.z>a.u+2.5)m.R=!0;const r=m.y;if(-.75>r||.75<r){const w=0<r?.75:-.75;m.y=w+(w-r);m.ra=-m.ra}m.z<k&&(-.01<t?(m.z=k,m.fa=0,m.$a=!0):(m.z=k+k-m.z,m.fa=-.25*t))}else t||(m.R=!0)});e.sort(kb)}
function lb(a){const b=1/18/18,c=f=>Math.max(0,Math.min(255,Math.round(256*(1-b*f*f)))),d=[];for(let f=0;2>f;f++)for(let h=0;18>h;h++)for(let g=0;2>g;g++){let k;var e=void 0;let l;e=h+6*g;18>e?(k=255,e=c(e),l=255):l=e=k=0;c(h+6*g);c(h+6*g+1);for(let n=0;2>n;n++)d.push(k,e,e,l)}a=oa({name:"spark",width:72,height:2,i:a,Ja:new Uint8Array(d)});return new N(a,{fading:P({x:1/180,width:.04,height:2/180,qa:1/18,pa:1,ma:18,count:18})})}function kb(a,b){return a.R?b.R?0:1:b.R?-1:a.y-b.y}
function mb(a,b){const c=b.l.Tb,d=a.stack;H(c,a);b.Pa.forEach(e=>{e.R||(z(d,e.x,e.y,e.z),A(d,(0<=e.Z?Math.PI:0)+Math.atan(e.fa/e.Z)),K(c,"fading",Math.floor(12*(b.m-e.startTime))),d.pop(),d.pop())})};function Z(a){const b=a.J,c=a.N,d=a.u,e=a.ba;return{name:a.name,l:e.l,input:e.input,audio:e.audio,Y:[],m:0,Ob:Date.now()/1E3-1/60,Fa:0,J:b,N:c,u:d,xa:gb(e.l.$,c-b,b),Pa:[],Ca:!1,h:new Wa(e.l.h,(c+b)/2,d),transition:null,sa:0,W:a.W,ka:[]}};function nb(a,b,c){const d=a.a.i,e=a.v;d.bindFramebuffer(d.FRAMEBUFFER,a.za);d.viewport(0,0,e.w,e.s);ka(a.a,(f,h)=>{ob(f,h,b,a,c)})}
class pb{constructor(a,b,c,d){b/=4;c/=4;var e=new B({i:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  gl_Position = u_projection * vec4(a_position, 1);\n  v_texturePosition = a_texturePosition;\n}"),f=new B({i:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\nuniform vec4 u_color;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    \n    if (u_threshold != -1.f) {\n      color.a -= u_threshold;\n      if (color.a <= u_threshold) {\n          discard;\n      }\n      output_color = color;\n    } else {\n      if (color.a == 0.f) {\n        discard;\n      }\n      output_color = u_color;\n    }\n}");const h=
new ja({i:a,ca:"projection"});ia(h,e,f).link();e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);f=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,f);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0);a.bindFramebuffer(a.FRAMEBUFFER,
null);const g=128/d;d=oa({name:"fade",width:64,height:64,i:a,Ja:qb(d)});this.a=h;this.v=pa({U:e,name:"lighting",width:b,height:c,i:a});this.za=f;this.ga=new N(d,{main:[[g,0,-g,1,0,g,0,g,1,1,-g,0,-g,0,0,-g,0,g,0,1]]});a=oa({name:"solid",width:1,height:1,i:a,Ja:new Uint8Array([255,255,255,255])});this.Ba=new N(a,{main:[[0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0]]})}}
function ob(a,b,c,d,e){a.blendFunc(a.ONE,a.ONE);a.clearColor(0,0,0,0);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const f=b.V.threshold,h=b.V.color;a.uniform1f(f,-1);const g=b.stack;c(g,()=>{const k=d.Ba;H(k,b);e.forEach(n=>{a.uniform4f(h,0,0,0,window.lightsOn||n.Ca?1:n.W);const p=n.l.$.ca,m=n.J-p.S;g.push(new Float32Array([n.N+p.S-m,0,0,0,0,0,0,0,0,0,2*p.la+2.5,0,m,-.75,n.u-p.la,1]));K(k,"main",0);g.pop()});const l=d.ga;H(l,b);a.uniform4f(h,0,0,0,1);e.forEach(n=>{const p=n.m;n.Pa.forEach(m=>{if(!m.R){var t=
m.startTime;t=(p-t)/(m.Ra-t);a.uniform1f(f,.5*t*t);z(g,m.x,m.y,m.z);K(l,"main",0);g.pop()}})})})}function qb(a){const b=new Uint8Array(16384),c=(f,h)=>{f/=a;h/=a;return f*f+h*h},d=Math.min(c(32,0),c(32,0));for(let f=0;64>f;f++)for(let h=0;64>h;h++){const g=4*(64*f+h);var e=c(h-32,f-32);const k=1-Math.sqrt(e/d);e=1E-4>=e?5:0;const l=Math.max(Math.round(255*k*k),0);b[g]=e+Math.max(Math.round(20*k),0);b[g+1]=e;b[g+2]=e;b[g+3]=l}return b};function rb(a,b){const c=a.a;let d=c.get(b);d||(d=sb(a.ba,b),c.set(b,d));return d}function tb(a,b){a.va.name!==b&&(a.va=rb(a,b))}class ub{constructor(a,b){this.ba=a;this.a=new Map([[b.name,b]]);this.va=b}}
function sb(a,b){switch(b){case "start":return a=Z({ba:a,name:b,N:5,J:-5,u:20,W:.4}),a.h.j=-1,a.ka.push(new Qa(1),new S(3,"second")),a;case "second":return a=Z({ba:a,name:b,N:5,J:-15,u:15,W:.4}),a.ka.push(new Qa(1),new Sa(3,"start"),new S(-10,"third")),La(a,-8),a;case "third":return a=Z({ba:a,name:b,N:10,J:-12,u:10,W:.4}),a.ka.push(new Qa(6),new Sa(-10,"second"),new S(8,"r0")),La(a,0),a;case "r0":return a=Z({ba:a,name:b,J:0,N:12,u:0,W:.1}),b=a.h,b.j=a.J+4,La(a,b.j+2),a;case "r1":return a=Z({ba:a,
name:b,J:-12,N:10,u:5.5,W:0}),La(a,0),a;default:throw Error(`Unrecognized room name "${b}"`);}}function vb(a){return{x:Math.min(Math.max(a.h.j,a.J+1),a.N-1),y:0,z:a.u+1.25}};window.onload=async function(){function a(q,u){q.push(t.Lb);z(q,-L.x,-L.y,-L.z);z(q,0,0,Ea);A(q,Fa);u();q.pop();q.pop();q.pop()}function b(q,u,v){const E=u.stack;z(E,0,0,v.u);var y=v.xa.bc;H(y,u);K(y,"main",0);y=v.xa.pb;H(y,u);K(y,"main",0);y=v.xa.jb;H(y,u);K(y,"main",0);y=v.xa.Rb;H(y,u);K(y,"left",0);K(y,"right",0);E.pop();v.ka.forEach(x=>{x.M(q,u,v)});Xa(q,u,v);Na(q,u,v);mb(u,v)}function c(q,u,v){q.bindFramebuffer(q.FRAMEBUFFER,null);q.viewport(0,0,p,m);q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA);
q.clearColor(0,0,0,1);q.clear(q.COLOR_BUFFER_BIT|q.DEPTH_BUFFER_BIT);q.activeTexture(q.TEXTURE1);D.v.bindTexture();q.uniform1i(u.V.lighting,1);q.activeTexture(q.TEXTURE0);a(u.stack,()=>{v.forEach(E=>{const y=u.stack.depth();b(q,u,E);u.stack.depth()!==y&&console.error("yo!")})})}function d(){!qa&&G(g,"fullscreen")&&(qa=f.requestFullscreen());const q=Date.now()/1E3;M=-1===M?60:.125/(q-Ga)+.875*M;e.innerHTML=`fps=${Math.round(M)}`;Ga=q;var u=Math.sin(Math.PI*(q+0)/8)/2+Math.sin(Math.PI*(q+0)/3)/8,v=
Math.sin(Math.PI*(q+170)/8)/2+Math.sin(Math.PI*(q+130)/3)/8;Fa=Math.asin((u-v)/100);Ea=(u+v)/2;v=J.va;u=null;const E=v.transition;E&&(E.ab+E.cb<q?(v.transition=null,tb(J,E.Oa),v=J.va):u=rb(J,E.Oa));const y=u?[v,u]:[v];y.forEach(x=>{{const F=q-x.Ob;x.Fa=F-x.m;x.m=F}});L=vb(v);u&&(v=Math.sin(Math.PI/2*((q-E.ab)/E.cb)),u=vb(u),L={x:L.x*(1-v)+u.x*v,y:L.y*(1-v)+u.y*v,z:L.z*(1-v)+u.z*v});ra(g)%2&&(l=!l,window.lightsOn=l);y.forEach(x=>{{let W=x.transition;var F=x.h;va(F.o,x.m);F.state.D(x);if(x.transition&&
!W){W=x.transition;{F=rb(J,W.Oa);const ha=F.h;"up"===W.Zb?(ha.j=x.h.j,ha.A(F,cb)):(ha.j=x.h.j,ha.A(F,bb))}}jb(x);W||x.sa||Ma(x)}});nb(D,a,y);ka(w,(x,F)=>c(x,F,y));requestAnimationFrame(d)}const e=document.getElementById("fps"),f=document.getElementById("canvas");var h=window.getComputedStyle(f);const g=new ta(document.body);C(g,"left",["a","ArrowLeft"]);C(g,"right",["d","ArrowRight"]);C(g,"showLights",["l"]);C(g,"attack",["f"," "]);C(g,"fullscreen",["u"]);C(g,"up",["w","ArrowUp"]);C(g,"down",["s",
"ArrowDown"]);C(g,"lightUp",["y"]);C(g,"lightDown",["h"]);var k=parseInt(h.getPropertyValue("width"),10);h=parseInt(h.getPropertyValue("height"),10);let l=!1;const n=window.devicePixelRatio||1,p=n*k,m=n*h;f.width=p;f.height=m;const t=eb(k,h),r=f.getContext("webgl2",{antialias:!1,alpha:!1});r.enable(r.BLEND);r.enable(r.DEPTH_TEST);r.depthFunc(r.LEQUAL);k=new B({i:r,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
h=new B({i:r,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const w=new ja({i:r,ca:"projection"});ia(w,k,h).link();const D=new pb(r,p,m,360),I=new ib;k=(q,u)=>ma({i:r,name:q,src:u});h=q=>hb(I,q);const [Q,T,ba]=await Promise.all([fb(t,k,h),Ba(k,h),db(k,h)]);k={l:{X:T,h:ba,$:Q,Tb:lb(r)},input:g,audio:I};const J=new ub(k,sb(k,"start"));let M=-1,qa=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(qa=null)});let L={x:0,y:0,z:0},Fa,Ea,Ga=Date.now();requestAnimationFrame(d);f.onmousemove=()=>{}};
