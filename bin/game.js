'use strict';class t{constructor(a,c,d){this.name=d;this.h=`${c}${d}`;switch(a){case "uniform":this.type=1;if("u_"!==c)throw Error(`uniform field "${this.h}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==c)throw Error(`in field "${this.h}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function u(a){const c=[];a.split("\n").forEach(d=>{(d=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(d))&&c.push(new t(d[1],d[2],d[3]))});return c}
const v=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function w(a,c,d=0){var b=a.b;b=b[b.length-1]||v;c=new Float32Array([b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8],b[9],b[10],b[11],c*b[0]+0*b[4]+d*b[8]+b[12],c*b[1]+0*b[5]+d*b[9]+b[13],c*b[2]+0*b[6]+d*b[10]+b[14],c*b[3]+0*b[7]+d*b[11]+b[15]]);a.a.uniformMatrix4fv(a.c,!1,c);a.b.push(c)}class x{constructor(a,c){this.a=a;this.c=c;this.b=[];a.uniformMatrix4fv(c,!1,v)}pop(){return this.b.pop()}}
class y{constructor(a,c){this.name=a.name;var d=this.a=a.a;a=this.type=a.type;switch(a){case "vertex":var b=this.a.VERTEX_SHADER;break;case "fragment":b=this.a.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}b=this.b=d.createShader(b);d.shaderSource(b,c);d.compileShader(b);if(!d.getShaderParameter(b,d.COMPILE_STATUS))throw c=`Failed to compile ${this.name} ${a}-shader: ${d.getShaderInfoLog(b)}`,d.deleteShader(b),Error(c);this.s=u(c)}}
function z(a,...c){const d=a.a,b=a.i;c.forEach(f=>{a.m.push(f);d.attachShader(b,f.b)});return a}function A(a,c){a.g.includes(c)||a.g.push(c);requestAnimationFrame(a.A)}
class B{constructor(a){this.name=a.name;this.j=a.j;a=this.a=a.a;this.o=!1;this.i=a.createProgram();this.m=[];this.c={};this.b={};this.stack=null;this.g=[];this.A=()=>{var c=this.a,d=this.i;c.useProgram(d);for(var b={},f={},g=this.m,e=0;e<g.length;e++)for(var l=g[e].s,m=0;m<l.length;m++){var k=l[m];1===k.type?k.h in b||(b[k.name]=c.getUniformLocation(d,k.h)):k.h in f||(f[k.name]=c.getAttribLocation(d,k.h))}this.c=b;this.b=f;if(d=this.j)if(d in this.c)this.stack=new x(c,this.c[d]);else throw Error(`No anchor point "${d}" in program`);
try{var p=this.g;this.g=[];for(e=0;e<p.length;p++)p[e](c,this)}finally{this.c={},this.b={},this.stack=null}}}link(){if(this.o)return this;var a=this.a,c=this.i;a.linkProgram(c);if(!a.getProgramParameter(c,a.LINK_STATUS)){var d=`Failed to link ${this.name} program: ${a.getProgramInfoLog(c)}`;a.deleteProgram(c);throw Error(d);}this.o=!0;return this}}
class K{constructor(a,c,d,b,f){this.a=a;this.name=c;this.w=d;this.f=b;c=this.b=a.createTexture();a.bindTexture(a.TEXTURE_2D,c);f(a);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.bindTexture(a.TEXTURE_2D,null)}bindTexture(){this.a.bindTexture(this.a.TEXTURE_2D,this.b)}}
function L(a){return(new Promise((c,d)=>{const b=new Image;b.onload=()=>void c(b);b.onerror=()=>{d(Error(`failed to load ${a.src}`))};b.mode="no-cors";b.src=a.src})).then(c=>{const d=c.naturalWidth,b=c.naturalHeight;return new K(a.a,a.name,d,b,f=>{f.texImage2D(f.TEXTURE_2D,0,f.RGBA,d,b,0,f.RGBA,f.UNSIGNED_BYTE,c)})})}function M(a){const c=a.width,d=a.height;return new K(a.a,a.name,c,d,b=>{b.texImage2D(b.TEXTURE_2D,0,b.RGBA,c,d,0,b.RGBA,b.UNSIGNED_BYTE,a.v,0)})};function N(a,c){const d=a.b.a;let b=a.c;null!=b?d.bindBuffer(d.ARRAY_BUFFER,b):(a.c=b=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,b),d.bufferData(d.ARRAY_BUFFER,a.g,d.STATIC_DRAW));d.activeTexture(d.TEXTURE0);a.b.bindTexture();d.uniform1i(c.c.texture,0);d.enableVertexAttribArray(c.b.texturePosition);d.vertexAttribPointer(c.b.texturePosition,2,d.FLOAT,!1,20,12);d.enableVertexAttribArray(c.b.position);d.vertexAttribPointer(c.b.position,3,d.FLOAT,!1,20,0)}
function O(a,c){if(!a.data.hasOwnProperty(c))throw Error(`Can not render unknown "${c}"`);c=a.data[c];a=a.b.a;a.drawArrays(a.TRIANGLE_STRIP,c.u[0],c.B)}
class P{constructor(a,c){this.b=a;this.c=null;a=this.data={};const d=[];let b=0;for(const f in c){const g=c[f],e=[],l=g.length;if(0===l)throw Error("Sprite declared with 0 points");const m=g[0].length;if(0==m)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const k=m/5;for(let p=0;p<l;p++){const r=g[p];if(r.length!==m)throw Error("Sprite declared with inconsistent lengths of elements");e.push(b);d.push.apply(d,r);b+=k}a[f]={C:this,name:f,u:e,B:k}}this.g=new Float32Array(d)}}
;function Q(){const a=new Uint8Array(65536),c=(f,g)=>{f/=360;g/=360;return f*f+g*g},d=Math.min(c(64,0),c(64,0));for(let f=0;128>f;f++)for(let g=0;128>g;g++){const e=4*(128*f+g),l=c(g-64,f-64);if(1E-4>=l)a[e]=255,a[e+1]=255,a[e+2]=255,a[e+3]=255;else{var b=Math.sqrt(1E-4/l);const m=Math.floor(256*b);b=Math.floor(256*b*b);a[e]=255;a[e+1]=b;a[e+2]=b;a[e+3]=l>=d?0:m}}return a}
window.onload=async function(){function a(q,n){q=Date.now();c.innerHTML=`fps=${Math.round(1E3/(q-C))}`;C=q;q=n.stack;var D=R;q.a.uniformMatrix4fv(q.c,!1,D);q.b.push(D);w(n.stack,Math.sin((Date.now()-S)/1E3/4)-1.5,h.d/2+h.f);N(E,n);O(E,"main");N(F,n);O(F,"main");w(n.stack,4,0);N(G,n);O(G,"idle");n.stack.pop();n.stack.pop();N(H,n);w(n.stack,I/180,(g-J)/180);O(H,"main");A(n,a)}const c=document.getElementById("fps"),d=document.getElementById("canvas");var b=window.getComputedStyle(d);let f=parseInt(b.getPropertyValue("width"),
10),g=parseInt(b.getPropertyValue("height"),10);b=window.devicePixelRatio||1;1!==b&&(d.width=b*f,d.height=b*g);var e=d.getContext("webgl2",{antialias:!1,alpha:!1});e.enable(e.BLEND);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);e.enable(e.DEPTH_TEST);e.depthFunc(e.LEQUAL);const l=new y({a:e,type:"vertex"},"#version 300 es\n\n    in vec3 a_position;\n    in vec2 a_texturePosition;\n\n    uniform mat4 u_projection;\n\n    out vec2 v_texturePosition;\n\n    void main() {\n        vec4 position = u_projection * vec4(a_position, 1);\n        float variance = 1.f / (position.z + 1.f);\n\n        vec4 result = vec4(position.x, position.y * variance, -.5f * (position.z - 1.f) * variance, variance);\n        gl_Position = result;\n\n        v_texturePosition = a_texturePosition;\n    }\n"),
m=new y({a:e,type:"fragment"},"#version 300 es\n    precision mediump float;\n\n    uniform sampler2D u_texture;\n\n    in vec2 v_texturePosition;\n    out vec4 output_color;\n\n    void main() {\n        vec4 color = texture(u_texture, v_texturePosition.st);\n        if (color.a == 0.0) {\n            discard;\n        }\n        output_color = color;\n    }\n");b=new B({a:e,j:"projection"});z(b,l,m).link();const [k,p,r]=await Promise.all([L({a:e,src:"assets/Background Wall.png",name:"wall"}),L({a:e,
src:"assets/Floor 2.png",name:"floor"}),L({a:e,src:"assets/Hero Breathing0001.png",name:"idle"})]),h={w:p.w/360,f:34/360,d:175/360,l:175/209},E=new P(k,{main:[[k.w/360,-h.d/2,k.f/360,1,0,k.w/360,-h.d/2,0,1,1,0,-h.d/2,k.f/360,0,0,0,-h.d/2,0,0,1]]}),F=new P(p,{main:[[h.w,h.d/2,-h.f,1,1,0,h.d/2,-h.f,0,1,h.w,h.d/2,0,1,h.l,0,h.d/2,0,0,h.l,h.w,-h.d/2,0,1,0,0,-h.d/2,0,0,0]]}),G=new P(r,{idle:[[r.w/360,0,r.f/360,1,0,r.w/360,0,0,1,1,0,0,r.f/360,0,0,0,0,0,0,1]]});e=M({name:"fade",width:128,height:128,a:e,v:Q()});
const H=new P(e,{main:[[64/360,0,-64/360,1,0,64/360,0,64/360,1,1,-64/360,0,-64/360,0,0,-64/360,0,64/360,0,1]]});let I=0,J=0;const R=new Float32Array([360/f,0,0,0,0,-360/g,.25,0,0,360/g,0,0,-1,-1,0,1]);let S=Date.now(),C=Date.now();A(b,a);d.onmousemove=q=>{I=q.offsetX;J=q.offsetY}};
