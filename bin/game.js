'use strict';class ba{constructor(a,b,c){this.name=c;this.ea=`${b}${c}`;switch(a){case "uniform":this.type=1;if("u_"!==b)throw Error(`uniform field "${this.ea}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==b)throw Error(`in field "${this.ea}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function ca(a){const b=[];a.split("\n").forEach(c=>{(c=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(c))&&b.push(new ba(c[1],c[2],c[3]))});return b}
const da=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function ea(a,b){a.h.uniformMatrix4fv(a.u,!1,b);a.a.push(b)}function z(a,b,c,d=0){var e=a.a;e=e.length?e[e.length-1]:da;ea(a,new Float32Array([e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],b*e[0]+c*e[4]+d*e[8]+e[12],b*e[1]+c*e[5]+d*e[9]+e[13],b*e[2]+c*e[6]+d*e[10]+e[14],b*e[3]+c*e[7]+d*e[11]+e[15]]))}function B(a,b){const c=Math.cos(b);b=Math.sin(b);a.push(new Float32Array([c,0,b,0,0,1,0,0,-b,0,c,0,0,0,0,1]))}
class fa{constructor(a,b){this.h=a;this.u=b;this.a=[];a.uniformMatrix4fv(b,!1,da)}depth(){return this.a.length}pop(){return this.a.pop()}push(a){var b=this.a;0===b.length?ea(this,a):(b=b[b.length-1],ea(this,new Float32Array([a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+
a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]])))}}
class C{constructor(a,b){this.name=a.name;var c=this.h=a.h;a=this.type=a.type;switch(a){case "vertex":var d=this.h.VERTEX_SHADER;break;case "fragment":d=this.h.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}d=this.a=c.createShader(d);c.shaderSource(d,b);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw b=`Failed to compile ${this.name} ${a}-shader: ${c.getShaderInfoLog(d)}`,c.deleteShader(d),Error(b);this.cb=ca(b)}}
function ha(a,...b){const c=a.h,d=a.Da;b.forEach(e=>{a.Qa.push(e);c.attachShader(d,e.a)});return a}class ia{constructor(a){this.name=a.name;this.$=a.$;a=this.h=a.h;this.a=!1;this.Da=a.createProgram();this.Qa=[];this.W={};this.aa={};this.stack=null}link(){if(this.a)return this;var a=this.h,b=this.Da;a.linkProgram(b);if(!a.getProgramParameter(b,a.LINK_STATUS)){var c=`Failed to link ${this.name} program: ${a.getProgramInfoLog(b)}`;a.deleteProgram(b);throw Error(c);}this.a=!0;return this}}
function ja(a,b){var c=a.h,d=a.Da;c.useProgram(d);for(var e={},g={},h=a.Qa,f=0;f<h.length;f++)for(var k=h[f].cb,l=0;l<k.length;l++){var n=k[l];1===n.type?n.ea in e||(e[n.name]=c.getUniformLocation(d,n.ea)):n.ea in g||(g[n.name]=c.getAttribLocation(d,n.ea))}a.W=e;a.aa=g;if(d=a.$)if(d in a.W)a.stack=new fa(c,a.W[d]);else throw Error(`No anchor point "${d}" in program`);try{b(c,a)}finally{a.W={},a.aa={},a.stack=null}}
class ka{constructor(a,b,c,d,e){this.h=a;this.name=b;this.w=c;this.l=d;this.a=e(a)}bindTexture(){this.h.bindTexture(this.h.TEXTURE_2D,this.a)}}function ma(a){return(new Promise((b,c)=>{const d=new Image;d.onload=()=>void b(d);d.onerror=()=>{c(Error(`failed to load ${a.src}`))};d.mode="no-cors";d.src=a.src})).then(b=>{const c=b.naturalWidth,d=b.naturalHeight;return new ka(a.h,a.name,c,d,na(e=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,c,d,0,e.RGBA,e.UNSIGNED_BYTE,b)}))})}
function oa(a){const b=a.width,c=a.height;return new ka(a.h,a.name,b,c,na(d=>{d.texImage2D(d.TEXTURE_2D,0,d.RGBA,b,c,0,d.RGBA,d.UNSIGNED_BYTE,a.Ga,0)}))}function pa(a){return new ka(a.h,a.name,a.width,a.height,()=>a.V)}
function na(a){return b=>{const c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);a(b);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.bindTexture(b.TEXTURE_2D,null);return c}};function E(a,b,c){a=a.u;null!=c?a.set(b,c):a.delete(b)}function G(a,b){b=a.u.get(b);const c=a.a;return!!b&&!!b.some(d=>(d=c.get(d))?(d.ra=0,null!=d.wa):!1)}function qa(a){const b=a.u.get("showLights");if(b){const c=a.a;return b.reduce((d,e)=>(e=c.get(e))?(d+=e.ra,e.ra=0,d):d,0)}return 0}function ra(a,b,c){b=G(a,b)?1:0;return(G(a,c)?1:0)-b}
class sa{constructor(a){this.a=new Map;this.u=new Map;a.addEventListener("keydown",b=>{ta(this,b,!0)});a.addEventListener("keyup",b=>{ta(this,b,!1)});a.onblur=()=>{this.a.clear()};a.onfocus=()=>{this.a.clear()}}}function ta(a,b,c){b=b.key;a=a.a;const d=a.get(b);c?null==d?a.set(b,{wa:Date.now(),ra:1}):(null==d.wa&&(d.wa=Date.now()),d.ra++):null!=d&&(d.wa=null)};function I(a,b){const c=a.a.h;let d=a.u;null!=d?c.bindBuffer(c.ARRAY_BUFFER,d):(a.u=d=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,d),c.bufferData(c.ARRAY_BUFFER,a.S,c.STATIC_DRAW));c.activeTexture(c.TEXTURE0);a.a.bindTexture();c.uniform1i(b.W.texture,0);c.enableVertexAttribArray(b.aa.texturePosition);c.vertexAttribPointer(b.aa.texturePosition,2,c.FLOAT,!1,20,12);c.enableVertexAttribArray(b.aa.position);c.vertexAttribPointer(b.aa.position,3,c.FLOAT,!1,20,0)}
function K(a,b,c){if(!a.data.hasOwnProperty(b))throw Error(`Can not render unknown "${b}"`);b=a.data[b];a=a.a.h;const d=b.Ea;a.drawArrays(a.TRIANGLE_STRIP,d[c%d.length],b.Db)}
class L{constructor(a,b){this.a=a;this.u=null;a=this.data={};const c=[];let d=0;for(const e in b){const g=b[e],h=[],f=g.length;if(0===f)throw Error("Sprite declared with 0 points");const k=g[0].length;if(0==k)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const l=k/5;for(let n=0;n<f;n++){const q=g[n];if(q.length!==k)throw Error("Sprite declared with inconsistent lengths of elements");h.push(d);c.push.apply(c,q);d+=l}a[e]={Xb:this,name:e,Ea:h,Db:l}}this.S=new Float32Array(c)}}
function ua(a,b){for(var c=a.H;-1!==c&&c<=b;){c=a.S;const d=a.K+1;d===c.length?a.u===a.tb?a.H=c=-1:(a.u++,a.K=0,a.H=c=b+c[0]):(a.K=d,a.H=c=b+c[d])}}function va(a,b){if(b!==a.a){if(!a.va.includes(b))throw Error(`${a} does not have mode ${b}`);a.a=b}}
class wa{constructor(a,b,c,d){const e=a.J;this.ya=a.name;this.va=a.na;this.a=c;this.tb="number"===typeof e?e:e?-1:0;this.Ta=a.set;this.S=b;this.K=this.u=0;this.H=d+b[0];this.qb=a.Eb}ua(){const a=this.qb;return null!=a?a[this.K]:void 0}U(a){I(this.Ta,a);K(this.Ta,this.a,this.K)}name(){return this.ya}toString(){return`Sprite/${this.ya}`}}
function M(a){const b=a.name,c=a.I,d=a.set.data;let e=-1;a.na.forEach(h=>{const f=d[h];if(!f)throw Error(`Sprite/${b} has non-existent mode ${h}`);if(-1===e)e=f.Ea.length;else if(e!==f.Ea.length)throw Error(`Sprite/${b} has inconsistent frame counts`);});if(-1===e)throw Error(`Sprite/${b} given 0 modes`);if("number"!==typeof c&&c.length!==e)throw Error(`Sprite/${b} given ${c.length} frame times for ${e} frames`);if(a.ua&&a.ua.length!==e)throw Error(`Sprite/${b} given ${a.ua.length} frame data points for ${e} frames`);
const g="number"===typeof c?Array(e).fill(c):c;return(h,f)=>new wa(a,g,h,f)}function N({x:a=0,y:b=0,z:c=0,width:d,height:e,ka:g,ja:h,ga:f,count:k,ac:l=0,bc:n=0,cc:q=g,$b:m=h,ha:u=!1}){const r=[];for(let v=0;v<k;v++){const A=l+v%f*q,H=n+Math.floor(v/f)*m;r.push(xa({x:a,y:b,z:c,width:d,height:e,Qb:A,Ob:A+g,Rb:H,Pb:H+h,ha:u}))}return r}
function xa({x:a=0,y:b=0,z:c=0,width:d,height:e,depth:g=0,Qb:h,Rb:f,Ob:k,Pb:l,ha:n=!1}){n?(n=k,k=a-d):(n=h,h=k,k=-a,a=d-a);return[a,-b,-c,h,l,k,-b,-c,n,l,a,g-b,e-c,h,f,k,g-b,e-c,n,f]};function O(a,b){return 0<b?Math.atan(a/b):0===b?0<a?Math.PI/2:0===a?0:-Math.PI/2:Math.atan(a/b)+Math.PI};const ya=new Float32Array([-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);
async function za(a,b){const [c,d,e,g,h]=await Promise.all([a("creature","assets/Enemy.png"),a("tentacle","assets/Tentacle.png"),a("creature_attack","assets/enemy_bite.png"),b("assets/Enemy Dying.mp3"),a("creature_death","assets/Enemy Dying.png")]);var f=new L(c,{blink:N({x:.25,z:.25,width:.5,height:.5,ka:108/c.w,ja:108/c.l,ga:2,count:6,ha:!0})});a=M({name:"creature_attack",set:new L(e,{bite:N({x:.5,z:.75,width:1,height:2,ja:530/e.l,ka:278/e.w,ga:7,count:42,ha:!0})}),na:["bite"],J:!1,I:1/42});b=M({name:"creature_death",
set:new L(h,{left:N({x:330/(460/1.8),y:.375,z:0,width:660/(460/1.8),height:1.8,ka:660/h.w,ja:460/h.l,ga:3,count:12}),right:N({x:1.32,y:.375,z:0,width:2.64,height:1.8,ka:660/h.w,ja:450/h.l,ga:3,count:12,ha:!0})}),na:["left","right"],J:!1,I:.125});var k=Array(6).fill(.125);k[0]=4;f=M({name:"creature_normal",set:f,na:["blink"],J:!0,I:k});k=[];var l=92,n=-22;const q=Math.sqrt(l*l+n*n);l/=q;n/=q;for(let m=0;29>m;m++){const u=m%5,r=Math.floor(m/5),v=[],A=(H,U)=>{const V=100*H,W=77*U-48;v.push((V*l+W*n)/
q,H,(V*-n+W*l)/360,100*(u+H)/d.w,77*(r+U)/d.l)};A(1,1);A(0,1);A(1,0);A(0,0);k.push(v)}k=new L(d,{wiggle:k});return{Va:f,wb:a,xb:b,Nb:k,ib:g}}function Aa(a,b,c){const d=b.j;if(d>a.u){var e=a.a;a.a=(e+1)%a.pa.length;e=a.pa[e];c=a.x+.225*c+e.ob;.05<Math.abs(c-e.Aa)&&(a.u=d+.125,e.Za=d+.125,e.Wa=e.Aa,e.Xa=e.La,e.Ya=e.Ma,e.Aa=c,e.La=a.y+e.pb,e.Ma=b.v)}}
class Ba{constructor(a,b,c,d){const e=a.m.ba.Va("blink",a.j),g=a.v;this.x=this.S=b;this.y=c;this.z=d;this.a=this.u=0;this.pa=[P(0,b,c,-1,1,g),P(1,b,c,-1,-1,g),P(2,b,c,1,1,g),P(3,b,c,1,-1,g)];this.s=e;this.state=Ga(this,a)}D(a,b){const c=this.state.Ka;c&&c();this.state=b=b(this,a);b.C(a)}O(a,b,c){this.s=a(c,b)}}
function Ga(a,b){return{name:"creature_normal",C:()=>{var c=b.j;a.x=a.S+Math.sin(c);Aa(a,b,.5*Math.cos(c));c=Math.abs(a.x-b.i.o);2>c&&(a.state=.5>c?Ha(a,b):Ia(a,b))},L:(c,d,e)=>{c=d.stack;const g=a.x,h=a.z;z(c,g,a.y,h);let f=e.x<g;e=O(e.z-h,e.x-g);f&&(c.push(ya),e=Math.PI-e);B(c,e);a.s.U(d);c.pop();f&&c.pop();c.pop()}}}
function Ia(a,b){const c=b.j;return{name:"creature_hunting",C:()=>{const d=b.j,e=b.i.o,g=Math.abs(a.x-b.i.o);.25<g&&(a.x+=(e<a.x?-1:1)*(.01+.02*Math.min(1,(b.j-c)/3)));Aa(a,b,.5*Math.cos(d));.5>g&&1<d-c&&(a.state=Ha(a,b))},L:(d,e,g)=>{d=e.stack;const h=a.x,f=a.z;z(d,h,a.y,f);let k=g.x<h;g=O(g.z-f,g.x-h);k&&(d.push(ya),g=Math.PI-g);B(d,g);a.s.U(e);d.pop();k&&d.pop();d.pop()}}}
function Ha(a,b){const c=b.m.ba.wb("bite",b.j);a.s=c;return{name:"creature_attack",C:()=>{-1===c.H&&(1.5>Math.abs(a.x-b.i.o)&&console.warn("Kill / hurt the hero"),a.state=Ia(a,b),a.s=b.m.ba.Va("blink",b.j))},L:(d,e,g)=>{d=e.stack;const h=a.x,f=a.z;z(d,h,a.y,f);let k=g.x<h;g=O(g.z-f,g.x-h);k&&(d.push(ya),g=Math.PI-g);B(d,g);a.s.U(e);d.pop();k&&d.pop();d.pop()}}}
function Ja(a,b){Ka(b.audio,a,b.m.ba.ib);const c=b.m.ba.xb(b.i.o<a.x?"left":"right",b.j);a.s=c;return{name:"creature_death",C:()=>{1<c.K&&a.pa.length&&(a.pa=[]);-1===c.H&&b.P.splice(b.P.indexOf(a),1)},L:(d,e)=>{console.log("DEATH");d=e.stack;z(d,a.x,a.y,b.v);c.U(e);d.pop()}}}function La(a){const b=a.j;a.P.forEach(c=>{ua(c.s,b);c.state.C(a)})}
function Ma(a,b,c){const d=b.stack,e=c.m.ba.Nb,g=c.j,h=Na(c.i);c.P.forEach(f=>{f.state.L(a,b,h)});I(e,b);c.P.forEach(f=>{const k=f.z-.1875;f.pa.forEach(l=>{var n=f.x+l.eb,q=f.y+l.fb;let m=l.Aa,u=l.La,r=l.Ma;var v=l.Za;g<v&&(v=1-(v-g)/.125,m=Oa(v,l.Wa,n,m),u=Oa(v,l.Xa,q,u),r=Oa(v,l.Ya,k,r));n-=m;q-=u;v=k-r;const A=Math.sqrt(n*n+q*q+v*v);z(d,m,u,r);B(d,O(v,n));d.push(new Float32Array([A,0,0,0,0,q,0,0,0,0,1,0,0,0,0,1]));K(e,"wiggle",Math.abs((Math.floor(24*Date.now()/1E3)+l.mb)%57+1-29));d.pop();d.pop();
d.pop()})})}function P(a,b,c,d,e,g){const h=.4*d;e=.1*e;b+=h;c+=e;return{index:a,eb:.05*d,fb:0,ob:h,pb:e,Za:0,Wa:b,Xa:c,Ya:g,Aa:b,La:c,Ma:g,mb:0}}function Oa(a,b,c,d){return a*(a*d+(1-a)*c)+(1-a)*(a*c+(1-a)*b)};class Pa{constructor(a){this.a=!1;this.x=a}L(a,b,c){a=b.stack;const d=c.m.sa.sb;z(a,this.x,0,c.v);I(d,b);K(d,this.a?"on":"off",0);a.pop()}}class Qa{constructor(a,b){this.bb=b;this.x=a}L(a,b,c){a=b.stack;const d=c.m.sa.Jb;z(a,this.x,0,c.v);I(d,b);K(d,"lowerHatch",0);a.pop()}};const Ra=434/1.8,Q=405/Ra;function Na(a){return{x:a.o,z:a.Z+1.8-.1}}function Sa(a){return(a=a.s.ua())?a.Sa:null}function S(a,b){a.ab=b;0!==b&&(a.oa=Math.sign(b))}
class Ta{constructor(a,b,c){this.o=b;this.xa=0;this.Z=c;this.oa=1;this.ab=0;this.s=a.Ja("right",0);this.state={name:"unstarted",C:d=>this.D(d,T),L:()=>{throw Error("Hero did not get processed before rendering!");}}}O(a,b,c=-1===this.oa?"left":"right"){this.s=a(c,b)}U(a,b){a=b.stack;z(a,this.o,this.xa,this.Z);this.s.U(b);a.pop()}D(a,b,c){const d=this.state.Ka;d&&d();this.state=b=b(this,a,c);b.C(a)}}function Ua(a,b,c){const d=c.i.state.L;d?d(a,b):c.i.U(a,b)}
function T(a,b){let c=!0;a.O(b.m.i.Ja,b.j);return{name:"normal",C:d=>{const e=d.i,g=d.j;var h=d.input;const f=ra(h,"down","up");if(!f||!d.Ha.some(l=>{if(l instanceof Pa){if(1===f&&!l.a&&.2>Math.abs(e.o-l.x))return e.D(d,Va,l),!0}else if(l instanceof Qa&&-1===f)return e.D(d,Wa,l),!0}))if("r0"===d.name&&G(h,"up"))e.D(d,Xa);else if(G(h,"attack"))e.D(d,Ya);else{h=1.2*d.Ca*ra(h,"left","right");var k=e.o+h;k<d.M+Q?h=d.M+Q-e.o:k>d.N-Q&&(h=d.N-Q-e.o);S(e,h/d.Ca);k=-1===e.oa?"left":"right";h?(e.o+=h,c&&(c=
!1,e.O(d.m.i.Bb,g))):c||(c=!0,e.O(d.m.i.Ja,g));va(e.s,k)}}}}function Ya(a,b){const c=a.o+300/Ra*a.oa;var d=b.P.find(e=>.4>Math.abs(c-e.x));d&&"creature_death"!==d.state.name&&d.D(b,Ja);a.O(b.m.i.ub,b.j);S(a,0);d=b.m.i.nb;Ka(b.audio,a,d[Math.floor(Math.random()*d.length)]);return{name:"attacking",C:e=>{-1===a.s.H&&a.D(e,T)}}}function Va(a,b,c){a.O(b.m.i.Ab,b.j,"main");S(a,0);a.o=c.x;return{name:"switch_on",C:()=>{!c.a&&6<=a.s.K&&(Ka(b.audio,c,b.m.i.rb),b.Ua=!0,c.a=!0);-1===a.s.H&&a.D(b,T)}}}
function Xa(a,b){a.O(b.m.i.vb,b.j,"up");S(a,0);a.xa=.55;b.transition={Ba:"r1",Sb:"up",Na:Date.now()/1E3,Oa:1};return{name:"climbing",C:c=>{-1===a.s.H?a.D(c,T):a.Z=c.v+.3*Math.min(5,a.s.K)},Ka:()=>{a.xa=0;a.Z=b.v}}}function Wa(a,b,c){S(a,0);a.o=c.x;a.O(b.m.i.yb,b.j,"enter");b.transition={Ba:c.bb,Sb:"down",Na:Date.now()/1E3,Oa:1};return{name:"descending",C:d=>{-1===a.s.H&&a.D(d,T)}}}
function Za(a,b){const c=b.j;a.O(b.m.i.zb,b.j,"exit");S(a,0);b.Ia++;return{name:"entering_hatch",C:()=>{const d=a.s;if(b.j<c+1){var e=b.j;if(!d.va.includes("exit"))throw Error(`${d} does not have mode ${"exit"}`);d.u=0;d.a="exit";d.K=0;d.H=e+d.S[0]}else-1===d.H?a.D(b,T):a.Z=b.v+([-.5,-.5,-.3,-.3][a.s.K]||0)},L:(d,e)=>{b.j<c+1||a.U(d,e)},Ka:()=>{b.Ia--;a.Z=b.v}}}
async function $a(a,b){const [c,d,e,g,h,f,k,l]=await Promise.all([a("hero_idle","assets/Hero Breathing with axe.png"),a("hero_walk","assets/Hero Walking with axe.png"),a("hero_attack","assets/Axe Chop.png"),a("hero_climbing","assets/Climbing Up.png"),a("hero_hatch","assets/climbing_in.png"),a("hero_light","assets/Hero flipping Switch.png"),Promise.all([b("assets/Grunt1.mp3"),b("assets/Grunt2.mp3"),b("assets/Grunt3.mp3")]),b("assets/light.mp3")]);a={name:"hero_hatch_enter",V:h,B:350,A:406,F:161,G:479,
da:6,J:!1,I:.125,Y:[{f:201,g:137,b:172,c:175},{f:422,g:246,b:461,c:259},{f:67,g:659,b:113,c:651},{f:419,g:658,b:462,c:648},{f:80,g:1041,b:106,c:1067},null],ia:"enter"};return{nb:k,Ja:X({name:"hero_idle",V:c,B:405,A:434,F:220,G:434,da:16,J:!0,I:1/12,Y:[{f:388,g:104,b:385,c:170},{f:792,g:105,b:790,c:170},{f:1198,g:105,b:1195,c:169},{f:1602,g:106,b:1600,c:170},{f:2008,g:106,b:2005,c:172},{f:388,g:539,b:385,c:604},{f:794,g:540,b:790,c:605},{f:1196,g:539,b:1196,c:604},{f:1602,g:539,b:1602,c:604},{f:2009,
g:541,b:2007,c:604},{f:386,g:974,b:385,c:1036},{f:792,g:972,b:790,c:1033},{f:1198,g:974,b:1196,c:1038},{f:1602,g:972,b:1601,c:1036},{f:2010,g:974,b:2005,c:1044},{f:386,g:1406,b:385,c:1477}]}),Bb:X({name:"hero_walk",V:d,B:424,A:444,F:258,G:444,da:8,J:!0,I:.125,Y:[{f:408,g:110,b:404,c:166},{f:830,g:110,b:829,c:166},{f:408,g:554,b:404,c:614},{f:830,g:554,b:829,c:614},{f:408,g:998,b:404,c:1055},{f:830,g:998,b:829,c:1055},{f:408,g:1444,b:404,c:1500},{f:830,g:1444,b:829,c:1500}]}),ub:X({name:"hero_attack",
V:e,B:644,A:565,F:284,G:565,da:5,J:!1,I:1/12,Y:[{f:422,g:285,b:415,c:353},{f:936,g:367,b:868,c:380},{f:1507,g:311,b:1469,c:318},{f:162,g:948,b:206,c:943},{f:1025,g:934,b:976,c:962}]}),vb:X({name:"hero_climbing_up",V:g,B:222,A:412,F:110,G:412,da:8,J:!1,I:.125,Y:[{f:128,g:60,b:65,c:54},{f:329,g:155,b:277,c:148},{f:579,g:58,b:518,c:56},{f:772,g:157,b:721,c:156},{f:95,g:575,b:65,c:567},{f:337,g:472,b:286,c:465},null,null],ia:"up",scale:1.4}),yb:X(a),zb:X({...a,name:"hero_hatch_exit",ia:"exit",Fb:!0}),
Ab:X({name:"hero_switch",V:f,B:274,A:444,F:104,G:442,da:9,J:!1,I:1/12,ia:"main",Y:null}),rb:l}}
function X(a){var b=a.V;const c=a.B,d=a.A,e=a.F,g=a.G,h=a.Fb?m=>[...m].reverse():m=>m,f=Ra/(a.scale||1),k=Math.floor(b.w/c),l={x:e/f,z:(d-g)/f,width:c/f,height:d/f,ka:c/b.w,ja:d/b.l,ga:k,count:a.da},n=a.Y&&a.Y.map((m,u)=>{if(!m)return{Sa:null};const r=m.f,v=m.g;return{Sa:{x:(r-(u%k*c+e))/f,z:(Math.floor(u/k)*d+g-v)/f,angle:O(-(v-m.c),r-m.b)}}});let q;a.ia?(q=[a.ia],b=new L(b,{[a.ia]:h(N(l))})):(q=["left","right"],b=new L(b,{right:h(N(l)),left:h(N({...l,ha:!0}))}));return M({name:a.name,set:b,na:q,
J:a.J,I:a.I,Eb:n&&h(n)})};function ab(a,b){var c=376/b;const d=c/(484/b),e=c/(268/b);c/=1.25;const g=b/a*c;return{Cb:new Float32Array([g,0,0,0,0,0,1/1.5,(e-d)/1.5,0,c,0,0,0,0,0,(d+e)/2]),Ub:d,Tb:e,Hb:g,Ib:c,B:a,A:b,fa:554/b*d/c-1.25,T:.3}}
async function bb(a,b){const [c,d,e,g,h,f,k]=await Promise.all([b("ladder","assets/ladder.png"),b("wall","assets/Back Wall.png"),b("floor","assets/floor.png"),b("ceiling","assets/ceiling.png"),b("wall","assets/side_wall.png"),b("set_pieces","assets/set_pieces.png"),b("lights","assets/Light Switch Flip.png")]);b=new L(c,{main:[Y(a,c,{F:c.w,G:c.l,B:c.w,A:c.l,offsetY:.55,za:1.25})]});var l={};l.barrel1=[Y(a,f,{F:370,G:270,B:338,A:222,offsetY:.55})];l.upperHatch=[Y(a,f,{F:2036,G:725,B:345,A:311,offsetY:.55})];
l.lowerHatch=[Y(a,f,{F:2036,G:725,B:345,A:311,offsetY:.1,jb:!0,za:.5})];l=new L(f,l);const n=new L(k,{on:[Y(a,k,{F:316,G:1110,B:118,A:152,offsetY:.75,za:1.4})],off:[Y(a,k,{F:316,G:298,B:118,A:152,offsetY:.75,za:1.4})]});return{$:a,Wb:d,lb:e,hb:g,Lb:h,Zb:b,Jb:l,sb:n}}
function cb({Wb:a,lb:b,hb:c,Lb:d,$:e},g,h){const f=h-e.T;h=h+g+e.T;var k=494/a.l,l=1016/a.l,n=(l-k)*a.l/2.5*g/a.w;a=new L(a,{main:[[h,.75,2.5,n,k,h,.75,0,n,l,f,.75,2.5,0,k,f,.75,0,0,l]]});k=110/b.l;l=220/b.l;n=(l-k)*b.l/1.5*g/b.w;b=new L(b,{main:[[h,-.75,-e.fa,n,1,f,-.75,-e.fa,0,1,h,-.75,0,n,l,f,-.75,0,0,l,h,.75,0,n,k,f,.75,0,0,k]]});k=144/c.l;l=32/c.l;g=(l-k)*c.l/1.5*g/c.w;c=new L(c,{main:[[h,-.75,2.5+e.fa,g,0,f,-.75,2.5+e.fa,0,0,h,-.75,2.5,g,l,f,-.75,2.5,0,l,h,.75,2.5,g,k,f,.75,2.5,0,k]]});g=438/
d.w;k=318/d.w;l=194/d.l;n=1164/d.l;const q=84/d.w;e=[f,-.75,2.5,g,l,f,-.75,0,g,n,f+e.T,-.75,2.5,k,l,f+e.T,-.75,0,k,n,f+e.T,.75,2.5,q,414/d.l,f+e.T,.75,0,q,964/d.l];g=[];for(k=0;k<e.length;k+=5)g.push(h+(f-e[k]),e[k+1],e[k+2],e[k+3],e[k+4]);d=new L(d,{right:[g],left:[e]});return{Vb:a,kb:b,gb:c,Kb:d}}
function Y(a,b,{offsetX:c=0,offsetY:d=0,za:e=0,F:g,G:h,B:f,A:k,jb:l=!1,Yb:n=!1}){let q=(h-k)/b.l;h/=b.l;l&&(l=q,q=h,h=l);l=(g-f)/b.w;b=g/b.w;n&&(n=l,l=b,b=n);const m=a.Hb;n=a.Ib;g=(d+.75)/1.5;g=a.Ub*(1-g)+a.Tb*g;c=c*m/g;e=e*n/g;f=f/a.B/2;k=k/a.A/2;a=(c-f)*g/m;f=(c+f)*g/m;c=(e+k)*g/n;k=(e-k)*g/n;return[a,d,c,l,q,f,d,c,b,q,a,d,k,l,h,f,d,k,b,h]};function Ka(a,b,c){const d=a.u;var e=d.get(b);e&&e.stop();a=a.a;e=a.createBufferSource();e.buffer=c;e.connect(a.destination);e.start();d.set(b,e)}function db(a,b){return fetch(b).then(c=>{if(!c.ok)throw Error(`failed to load ${b}`);return c.arrayBuffer()}).then(c=>a.a.decodeAudioData(c))}class eb{constructor(){this.a=new AudioContext;this.u=new WeakMap}};function fb(a){const b=a.j,c=a.Ca,d=a.i,e=a.Pa,g=Math.floor(48*b)-Math.floor(48*(b-c));for(let m=0;m<g;m++){var h=2*Math.random()+1.4;let u=.1*Math.sin(2*Math.PI*Math.random());var f=Sa(d);if(!f)break;const r=d.o+f.x*d.oa,v=f.z+d.Z,A=Math.PI/4*(Math.random()-.5)+f.angle;f=h*Math.sin(A);h=h*Math.cos(A)+d.ab;100<e.length&&e.pop();e.push({R:!1,x:r,y:d.xa+.01,z:v,X:h,la:u,ca:f,startTime:b,Ra:b+1.5,$a:!1})}const k=a.v,l=9.8*c,n=0*c,q=1-.8*c;e.forEach(m=>{var u=m.R;if(!u&&b<m.Ra){m.x+=m.X*c;m.y+=m.la*c;
m.z+=m.ca*c;u=m.ca;m.$a?(m.X*=q,m.la*=q):(u-=l,m.X-=n,m.ca=u);if(m.x<a.M||m.x>a.N)m.R=!0;const r=m.y;if(-.75>r||.75<r){const v=0<r?.75:-.75;m.y=v+(v-r);m.la=-m.la}m.z<k&&(-.01<u?(m.z=k,m.ca=0,m.$a=!0):(m.z=k+k-m.z,m.ca=-.25*u))}else u||(m.R=!0)});e.sort(gb)}
function hb(a){const b=1/18/18,c=g=>Math.max(0,Math.min(255,Math.round(256*(1-b*g*g)))),d=[];for(let g=0;2>g;g++)for(let h=0;18>h;h++)for(let f=0;2>f;f++){let k;var e=void 0;let l;e=h+6*f;18>e?(k=255,e=c(e),l=255):l=e=k=0;c(h+6*f);c(h+6*f+1);for(let n=0;2>n;n++)d.push(k,e,e,l)}a=oa({name:"spark",width:72,height:2,h:a,Ga:new Uint8Array(d)});return new L(a,{fading:N({x:1/180,width:.04,height:2/180,ka:1/18,ja:1,ga:18,count:18})})}function gb(a,b){return a.R?b.R?0:1:b.R?-1:a.y-b.y}
function ib(a,b){const c=b.m.Mb,d=a.stack;I(c,a);b.Pa.forEach(e=>{e.R||(z(d,e.x,e.y,e.z),B(d,(0<=e.X?Math.PI:0)+Math.atan(e.ca/e.X)),K(c,"fading",Math.floor(12*(b.j-e.startTime))),d.pop(),d.pop())})};function jb(a){const b=a.M,c=a.N,d=a.v,e=a.ma;return{name:a.name,m:e.m,input:e.input,audio:e.audio,P:[],j:0,Gb:Date.now()/1E3-1/60,Ca:0,M:b,N:c,v:d,ta:cb(e.m.sa,c-b,b),Pa:[],Ua:!1,i:new Ta(e.m.i,(c+b)/2,d),transition:null,Ia:0,Fa:0,Ha:[]}};function kb(a,b,c){const d=a.a.h,e=a.u;d.bindFramebuffer(d.FRAMEBUFFER,a.va);d.viewport(0,0,e.w,e.l);ja(a.a,(g,h)=>{lb(g,h,b,a,c)})}
class mb{constructor(a,b,c,d){b/=4;c/=4;var e=new C({h:a,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec2 v_texturePosition;\n\nvoid main() {\n  gl_Position = u_projection * vec4(a_position, 1);\n  v_texturePosition = a_texturePosition;\n}"),g=new C({h:a,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform float u_threshold;\nuniform vec4 u_color;\n\nin vec2 v_texturePosition;\nout vec4 output_color;\n\nvoid main() {\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    \n    if (u_threshold != -1.f) {\n      color.a -= u_threshold;\n      if (color.a <= u_threshold) {\n          discard;\n      }\n      output_color = color;\n    } else {\n      if (color.a == 0.f) {\n        discard;\n      }\n      output_color = u_color;\n    }\n}");const h=
new ia({h:a,$:"projection"});ha(h,e,g).link();e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);g=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,g);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0);a.bindFramebuffer(a.FRAMEBUFFER,
null);const f=128/d;d=oa({name:"fade",width:64,height:64,h:a,Ga:nb(d)});this.a=h;this.u=pa({V:e,name:"lighting",width:b,height:c,h:a});this.va=g;this.S=new L(d,{main:[[f,0,-f,1,0,f,0,f,1,1,-f,0,-f,0,0,-f,0,f,0,1]]});a=oa({name:"solid",width:1,height:1,h:a,Ga:new Uint8Array([255,255,255,255])});this.ya=new L(a,{main:[[0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0]]})}}
function lb(a,b,c,d,e){a.blendFunc(a.ONE,a.ONE);a.clearColor(0,0,0,0);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const g=b.W.threshold,h=b.W.color;a.uniform1f(g,-1);const f=b.stack;c(f,()=>{const k=d.ya;I(k,b);e.forEach(n=>{a.uniform4f(h,0,0,0,window.lightsOn||n.Ua?1:n.Fa);const q=n.m.sa.$,m=n.M-q.T;f.push(new Float32Array([n.N+q.T-m,0,0,0,0,0,0,0,0,0,2*q.fa+2.5,0,m,-.75,n.v-q.fa,1]));K(k,"main",0);f.pop()});const l=d.S;I(l,b);a.uniform4f(h,0,0,0,1);e.forEach(n=>{const q=n.j;n.Pa.forEach(m=>{if(!m.R){var u=
m.startTime;u=(q-u)/(m.Ra-u);a.uniform1f(g,.5*u*u);z(f,m.x,m.y,m.z);K(l,"main",0);f.pop()}})})})}function nb(a){const b=new Uint8Array(16384),c=(g,h)=>{g/=a;h/=a;return g*g+h*h},d=Math.min(c(32,0),c(32,0));for(let g=0;64>g;g++)for(let h=0;64>h;h++){const f=4*(64*g+h);var e=c(h-32,g-32);const k=1-Math.sqrt(e/d);e=1E-4>=e?5:0;const l=Math.max(Math.round(255*k*k),0);b[f]=e+Math.max(Math.round(20*k),0);b[f+1]=e;b[f+2]=e;b[f+3]=l}return b};function ob(a,b){const c=a.a;let d=c.get(b);d||(d=pb(a.ma,b),c.set(b,d));return d}function qb(a,b){a.qa.name!==b&&(a.qa=ob(a,b))}class rb{constructor(a,b){this.ma=a;this.a=new Map([[b.name,b]]);this.qa=b}}
function pb(a,b){switch(b){case "start":return a=jb({ma:a,name:b,N:6,M:-6,v:20}),a.Fa=.4,a.i.o=-1,a.Ha.push(new Pa(1),new Qa(3,"r0")),a;case "r0":return a=jb({ma:a,name:b,M:0,N:12,v:0}),b=a.i,b.o=a.M+4,a.P.push(new Ba(a,b.o+2,0,a.v+.75)),a.Fa=.1,a;case "r1":return a=jb({ma:a,name:b,M:-12,N:10,v:5.5}),a.P.push(new Ba(a,0,0,a.v+.75)),a;default:throw Error(`Unrecognized room name "${b}"`);}}function sb(a){return{x:Math.min(Math.max(a.i.o,a.M+1),a.N-1),y:0,z:a.v+1.25}};window.onload=async function(){function a(p,t){p.push(u.Cb);z(p,-J.x,-J.y,-J.z);z(p,0,0,Ca);B(p,Da);t();p.pop();p.pop();p.pop()}function b(p,t,w){const D=t.stack;z(D,0,0,w.v);var x=w.ta.Vb;I(x,t);K(x,"main",0);x=w.ta.kb;I(x,t);K(x,"main",0);x=w.ta.gb;I(x,t);K(x,"main",0);x=w.ta.Kb;I(x,t);K(x,"left",0);K(x,"right",0);D.pop();w.Ha.forEach(y=>{y.L(p,t,w)});Ua(p,t,w);Ma(p,t,w);ib(t,w)}function c(p,t,w){p.bindFramebuffer(p.FRAMEBUFFER,null);p.viewport(0,0,q,m);p.blendFunc(p.SRC_ALPHA,p.ONE_MINUS_SRC_ALPHA);
p.clearColor(0,0,0,1);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);p.activeTexture(p.TEXTURE1);A.u.bindTexture();p.uniform1i(t.W.lighting,1);p.activeTexture(p.TEXTURE0);a(t.stack,()=>{w.forEach(D=>{const x=t.stack.depth();b(p,t,D);t.stack.depth()!==x&&console.error("yo!")})})}function d(){!la&&G(f,"fullscreen")&&(la=g.requestFullscreen());const p=Date.now()/1E3;Z=-1===Z?60:.125/(p-Ea)+.875*Z;e.innerHTML=`fps=${Math.round(Z)}`;Ea=p;var t=Math.sin(Math.PI*(p+0)/8)/2+Math.sin(Math.PI*(p+0)/3)/8,w=
Math.sin(Math.PI*(p+170)/8)/2+Math.sin(Math.PI*(p+130)/3)/8;Da=Math.asin((t-w)/100);Ca=(t+w)/2;w=R.qa;t=null;const D=w.transition;D&&(D.Na+D.Oa<p?(w.transition=null,qb(R,D.Ba),w=R.qa):t=ob(R,D.Ba));const x=t?[w,t]:[w];x.forEach(y=>{{const F=p-y.Gb;y.Ca=F-y.j;y.j=F}});J=sb(w);t&&(w=Math.sin(Math.PI/2*((p-D.Na)/D.Oa)),t=sb(t),J={x:J.x*(1-w)+t.x*w,y:J.y*(1-w)+t.y*w,z:J.z*(1-w)+t.z*w});qa(f)%2&&(l=!l,window.lightsOn=l);x.forEach(y=>{{let aa=y.transition;var F=y.i;ua(F.s,y.j);F.state.C(y);if(y.transition&&
!aa){aa=y.transition;{F=ob(R,aa.Ba);const Fa=F.i;Fa.o=y.i.o;Fa.D(F,Za)}}fb(y);aa||y.Ia||La(y)}});kb(A,a,x);ja(v,(y,F)=>c(y,F,x));requestAnimationFrame(d)}const e=document.getElementById("fps"),g=document.getElementById("canvas");var h=window.getComputedStyle(g);const f=new sa(document.body);E(f,"left",["a","ArrowLeft"]);E(f,"right",["d","ArrowRight"]);E(f,"showLights",["l"]);E(f,"attack",["f"," "]);E(f,"fullscreen",["u"]);E(f,"up",["w","ArrowUp"]);E(f,"down",["s","ArrowDown"]);E(f,"lightUp",["y"]);
E(f,"lightDown",["h"]);var k=parseInt(h.getPropertyValue("width"),10);h=parseInt(h.getPropertyValue("height"),10);let l=!1;const n=window.devicePixelRatio||1,q=n*k,m=n*h;g.width=q;g.height=m;const u=ab(k,h),r=g.getContext("webgl2",{antialias:!1,alpha:!1});r.enable(r.BLEND);r.enable(r.DEPTH_TEST);r.depthFunc(r.LEQUAL);k=new C({h:r,type:"vertex"},"#version 300 es\nin vec3 a_position;\nin vec2 a_texturePosition;\n\nuniform mat4 u_projection;\n\nout vec4 v_clipSpace;\nout vec2 v_texturePosition;\n\nvoid main() {\n    vec4 position = u_projection * vec4(a_position, 1);\n    // float inverse = 1.f / (1.f - position.z * .2f);\n\n    // vec4 result = vec4(position.x, inverse * position.y * (1.f - .5f * position.z), inverse * position.z, inverse * position.w);\n    // vec4 result = vec4(position.x * position.w, position.y, position.z, position.w);\n    vec4 result = position;\n    gl_Position = result;\n    \n    v_clipSpace = result;\n    v_texturePosition = a_texturePosition;\n}");
h=new C({h:r,type:"fragment"},"#version 300 es\nprecision mediump float;\n\nuniform sampler2D u_texture;\nuniform sampler2D u_lighting;\n\nin vec2 v_texturePosition;\nin vec4 v_clipSpace;\nout vec4 output_color;\n\nvoid main() {\n    vec4 clipSpace = v_clipSpace / v_clipSpace.w; //vec4(.5f * (v_clipSpace.x + 1.f), -.5f * (v_clipSpace.y - 1.f), v_clipSpace.z, v_clipSpace.w) / v_clipSpace.w;\n    clipSpace.x = .5f * (clipSpace.x + 1.f);\n    clipSpace.y = 1.f - .5f * (1.f - clipSpace.y); // why????\n\n    vec4 color = texture(u_texture, v_texturePosition.st);\n    if (color.a == 0.0) {\n        discard;\n    }\n\n    vec4 light = texture(u_lighting, clipSpace.xy);\n    vec3 math = min(light.xyz + color.xyz * light.a, vec3(1.f, 1.f, 1.f));\n    output_color = vec4(math, color.a);\n}");
const v=new ia({h:r,$:"projection"});ha(v,k,h).link();const A=new mb(r,q,m,360),H=new eb;k=(p,t)=>ma({h:r,name:p,src:t});h=p=>db(H,p);const [U,V,W]=await Promise.all([bb(u,k),za(k,h),$a(k,h)]);k={m:{ba:V,i:W,sa:U,Mb:hb(r)},input:f,audio:H};const R=new rb(k,pb(k,"start"));let Z=-1,la=null;document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||(la=null)});let J={x:0,y:0,z:0},Da,Ca,Ea=Date.now();requestAnimationFrame(d);g.onmousemove=()=>{}};
